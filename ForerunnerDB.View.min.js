(function(){var n=ForerunnerDB.classes.Collection,p=ForerunnerDB.classes.CollectionGroup,b=function(){this.init.apply(this,arguments)};b.prototype.init=function(a){var c=this;this._name=a;this._groups=[];this._listeners={};this._query={query:{},options:{}};this._onFromInsert=function(){c._onInsert.apply(c,arguments)};this._onFromUpdate=function(){c._onUpdate.apply(c,arguments)};this._onFromRemove=function(){c._onRemove.apply(c,arguments)}};b.prototype.on=function(a,c){this._listeners=this._listeners||
{};this._listeners[a]=this._listeners[a]||[];this._listeners[a].push(c);return this};b.prototype.off=function(a,c){if(a in this._listeners){var b=this._listeners[a],d=b.indexOf(c);-1<d&&b.splice(d,1)}return this};b.prototype.emit=function(a,c){this._listeners=this._listeners||{};if(a in this._listeners){var b=this._listeners[a],d=b.length,e;for(e=0;e<d;e++)b[e].apply(this,Array.prototype.slice.call(arguments,1))}return this};b.prototype.drop=function(){return(this._db||this._from)&&this._name?((this._debug||
this._from&&this._from._debug||this._db&&this._db._debug)&&console.log("Dropping view "+this._name),this.emit("drop"),this._db&&delete this._db._views[this._name],this._from&&delete this._from._views[this._name],!0):!1};b.prototype.db=function(a){return void 0!==a?(this._db=a,this):this._db};b.prototype.from=function(a){return void 0!==a?(this._from!==a&&(this._from&&this.removeFrom(),this.addFrom(a)),this):this._from};b.prototype.addFrom=function(a){a instanceof n||a instanceof p?this._from=a:"string"===
typeof a&&(this._from=this._db.collection(a));if(this._from)return this._from.on("insert",this._onFromInsert),this._from.on("update",this._onFromUpdate),this._from.on("remove",this._onFromRemove),this._from._addView(this),this._primaryKey=this._from._primaryKey,this.refresh(),this;throw"Cannot determine collection type in view.from()";};b.prototype.removeFrom=function(){this._from.off("insert",this._onFromInsert);this._from.off("update",this._onFromUpdate);this._from.off("remove",this._onFromRemove);
this._from._removeView(this)};b.prototype.primaryKey=function(){if(this._from)return this._from.primaryKey()};b.prototype.query=function(a,c,b){void 0!==a&&(this._query.query=a);void 0!==c&&(this._query.options=c);return void 0!==a||void 0!==c?((void 0===b||!0===b)&&this.refresh(),this):this._query};b.prototype.queryAdd=function(a,c,b){var d=this._query.query,e;if(void 0!==a)for(e in a)if(a.hasOwnProperty(e)&&(void 0===d[e]||void 0!==d[e]&&c))d[e]=a[e];(void 0===b||!0===b)&&this.refresh()};b.prototype.queryRemove=
function(a,c){var b=this._query.query,d;if(void 0!==a)for(d in a)a.hasOwnProperty(d)&&delete b[d];(void 0===c||!0===c)&&this.refresh()};b.prototype.queryObj=function(a,c){return void 0!==a?(this._query.query=a,(void 0===c||!0===c)&&this.refresh(),this):this._query.query};b.prototype.queryOptions=function(a,c){return void 0!==a?(this._query.options=a,(void 0===c||!0===c)&&this.refresh(),this):this._query.options};b.prototype.refresh=function(a){var c=this._data,b,d,e,l,f,h=[],m=[],k=[],g;this._from&&
(this._data=this._query?this._from.subset(this._query.query,this._query.options):this._from.subset({}));if(a)e=this._data.find(),this._onInsert(e,[]),this.emit("change",{data:e});else if(c)if(d=this._data,c.subsetOf()===d.subsetOf()){e=d.find();a=c.find();l=d._primaryKey;for(g=0;g<e.length;g++)f=e[g],b={},b[l]=f[l],(b=c.find(b)[0])?JSON.stringify(b)!==JSON.stringify(f)&&m.push(f):h.push(f);for(g=0;g<a.length;g++)f=a[g],b={},b[l]=f[l],d.find(b)[0]||k.push(f);h.length&&this._onInsert(h,[]);m.length&&
this._onUpdate(m,[]);k.length&&this._onRemove(k,[]);this.emit("change",{data:e})}else k=c.find(),k.length&&this._onRemove(k),h=d.find(),h.length&&this._onInsert(h);return this};b.prototype.count=function(){return this._data&&this._data._data?this._data._data.length:0};b.prototype.find=function(){return this._data?this._data.find.apply(this._data,arguments):[]};b.prototype._onInsert=function(a,b){this.emit("insert",a,b)};b.prototype._onUpdate=function(a,b){this.emit("update",a,b)};b.prototype._onRemove=
function(a,b){this.emit("remove",a,b)};ForerunnerDB.prototype.view=function(a){this._views[a]||this._debug&&console.log("Creating view "+a);this._views[a]=this._views[a]||(new b(a)).db(this);return this._views[a]};ForerunnerDB.prototype.viewExists=function(a){return Boolean(this._views[a])};ForerunnerDB.prototype.views=function(){var a=[],b;for(b in this._views)this._views.hasOwnProperty(b)&&a.push({name:b,count:this._views[b].count()});return a};ForerunnerDB.classes.View=b})();
