!function(y){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=y();else if("function"==typeof define&&define.amd)define([],y);else{var e;"undefined"!=typeof window?e=window:"undefined"!=typeof global?e=global:"undefined"!=typeof self&&(e=self);e.ForerunnerDB=y()}}(function(){return function e(m,h,k){function g(a,b){if(!h[a]){if(!m[a]){var f="function"==typeof require&&require;if(!b&&f)return f(a,!0);if(c)return c(a,!0);f=Error("Cannot find module '"+a+"'");throw f.code="MODULE_NOT_FOUND",
f;}f=h[a]={exports:{}};m[a][0].call(f.exports,function(f){var b=m[a][1][f];return g(b?b:f)},f,f.exports,e,m,h,k)}return h[a].exports}for(var c="function"==typeof require&&require,a=0;a<k.length;a++)g(k[a]);return g}({1:[function(e,m,h){h=e("../lib/Core");e("../lib/CollectionGroup");e("../lib/View");e("../lib/OldView");e("../lib/OldView.Bind");e("../lib/Highcharts");e("../lib/Persist");e("../lib/Document");e("../lib/Overview");m.exports=h},{"../lib/CollectionGroup":4,"../lib/Core":5,"../lib/Document":7,
"../lib/Highcharts":8,"../lib/OldView":13,"../lib/OldView.Bind":12,"../lib/Overview":15,"../lib/Persist":17,"../lib/View":20}],2:[function(e,m,h){m.exports={chain:function(k){this._chain=this._chain||[];-1===this._chain.indexOf(k)&&this._chain.push(k)},unChain:function(k){this._chain&&(k=this._chain.indexOf(k),-1<k&&this._chain.splice(k,1))},chainSend:function(k,g,c){if(this._chain){var a=this._chain,d=a.length,b;for(b=0;b<d;b++)a[b].chainReceive(this,k,g,c)}},chainReceive:function(k,g,c,a){k={sender:k,
type:g,data:c,options:a};(!this._chainHandler||this._chainHandler&&!this._chainHandler(k))&&this.chainSend(k.type,k.data,k.options)}}},{}],3:[function(e,m,h){var k,g,c,a,d;h=e("./Shared");var b=function(f){this.init.apply(this,arguments)};b.prototype.init=function(f){this._primaryKey="_id";this._primaryIndex=new g("primary");this._primaryCrc=new g("primaryCrc");this._crcLookup=new g("crcLookup");this._name=f;this._data=[];this._groups=[];this._metrics=new k;this._linked=0;this._deferQueue={insert:[],
update:[],remove:[],upsert:[]};this._deferThreshold={insert:100,update:100,remove:100,upsert:100};this._deferTime={insert:1,update:1,remove:1,upsert:1};this._subsetOf(this)};h.addModule("Collection",b);h.inherit(b.prototype,h.chainReactor);k=e("./Metrics");g=e("./KeyValueStore");c=e("./Path");a=e("./Index");d=e("./Crc");e=h.modules.Core;b.prototype.debug=h.common.debug;b.prototype.crc=d;h.synthesize(b.prototype,"name");b.prototype.on=h.common.on;b.prototype.off=h.common.off;b.prototype.emit=h.common.emit;
b.prototype.drop=function(){if(this._db&&this._db._collection&&this._name){this.debug()&&console.log("Dropping collection "+this._name);this.emit("drop");delete this._db._collection[this._name];var f=[],r;for(r=0;r<this._groups.length;r++)f.push(this._groups[r]);for(r=0;r<f.length;r++)this._groups[r].removeCollection(this);return!0}return!1};b.prototype.primaryKey=function(f){return void 0!==f?(this._primaryKey!==f&&(this._primaryKey=f,this._primaryIndex.primaryKey(f),this._rebuildPrimaryKeyIndex()),
this):this._primaryKey};b.prototype._onInsert=function(f,r){this.emit("insert",f,r)};b.prototype._onUpdate=function(f){this.emit("update",f)};b.prototype._onRemove=function(f){this.emit("remove",f)};h.synthesize(b.prototype,"db");b.prototype.setData=function(f,r,a){if(f){var b=this._metrics.create("setData");b.start();r=r||{};r.$decouple=void 0!==r.$decouple?r.$decouple:!0;r.$decouple&&(f=this.decouple(f));f instanceof Array||(f=[f]);b.time("transformIn");f=this.transformIn(f);b.time("transformIn");
var d=this._data;this._linked?this.remove():this._data=[];f.length&&(this._linked?this.insert(f):this._data=this._data.concat(f));b.time("Rebuild Primary Key Index");this._rebuildPrimaryKeyIndex(r);b.time("Rebuild Primary Key Index");b.time("Resolve chains");this.chainSend("setData",f,{oldData:d});b.time("Resolve chains");b.stop();this.emit("setData",this._data,d)}a&&a(!1);return this};b.prototype._rebuildPrimaryKeyIndex=function(f){var r=f&&void 0!==f.ensureKeys?f.ensureKeys:!0;f=f&&void 0!==f.violationCheck?
f.violationCheck:!0;var b,a,d,c=this._primaryIndex,g=this._primaryCrc,k=this._crcLookup,e=this._primaryKey,h;c.truncate();g.truncate();k.truncate();b=this._data;for(a=b.length;a--;){d=b[a];r&&this._ensurePrimaryKey(d);if(f){if(!c.uniqueSet(d[e],d))throw"Call to setData failed because your data violates the primary key unique constraint. One or more documents are using the same primary key: "+d[this._primaryKey];}else c.set(d[e],d);h=JSON.stringify(d);g.set(d[e],h);k.set(h,d)}};b.prototype._ensurePrimaryKey=
function(f){void 0===f[this._primaryKey]&&(f[this._primaryKey]=this.objectId())};b.prototype.truncate=function(){this.emit("truncate",this._data);this._data.length=0;this.deferEmit("change");return this};b.prototype.upsert=function(f,r){if(f){var b=this._deferQueue.upsert,a=this._deferThreshold.upsert,d={},c;if(f instanceof Array){if(f.length>a){this._deferQueue.upsert=b.concat(f);this.processQueue("upsert",r);return}d=[];for(b=0;b<f.length;b++)d.push(this.upsert(f[b]));r&&r();return d}f[this._primaryKey]?
(c={},c[this._primaryKey]=f[this._primaryKey],this._primaryIndex.lookup(c)[0]?d.op="update":d.op="insert"):d.op="insert";switch(d.op){case "insert":d.result=this.insert(f);break;case "update":d.result=this.update(c,f)}return d}r&&r()};b.prototype.update=function(f,b,a){b=this.decouple(b);b=this.transformIn(b);this.debug()&&console.log('Updating some collection data for collection "'+this.name()+'"');var d=this,c=this._metrics.create("update"),g=this._primaryKey,k,e,h=function(c){if(b&&void 0!==b[g]&&
b[g]!=c[g]){d._removeIndex(c);var k=d._updateObject(c,b,f,a,"");if(d._insertIndex(c))return k;throw"Primary key violation in update! Key violated: "+c[g];}return d._updateObject(c,b,f,a,"")};c.start();c.time("Retrieve documents to update");k=this.find(f,{$decouple:!1});c.time("Retrieve documents to update");k.length&&(c.time("Update documents"),e=k.filter(h),c.time("Update documents"),e.length&&(c.time("Resolve chains"),this.chainSend("update",{query:f,update:b},a),c.time("Resolve chains"),this._onUpdate(e),
this.deferEmit("change",{type:"update",data:e})));c.stop();return e||[]};b.prototype.updateById=function(f,b){var a={};a[this._primaryKey]=f;return this.update(a,b)};b.prototype._updateObject=function(f,b,a,d,g,k){b=this.decouple(b);g=g||"";"."===g.substr(0,1)&&(g=g.substr(1,g.length-1));var e=!1,h=!1,q,p,n,l;for(l in b)if(b.hasOwnProperty(l)){q=!1;if("$"===l.substr(0,1))switch(l){case "$index":q=!0;break;default:q=!0,(h=this._updateObject(f,b[l],a,d,g,l))&&(e=!0)}if(this._isPositionalKey(l)&&(q=
!0,l=l.substr(0,l.length-2),h=new c(g+"."+l),f[l]&&f[l]instanceof Array&&f[l].length)){p=[];for(n=0;n<f[l].length;n++)this._match(f[l][n],h.value(a)[0])&&p.push(n);for(n=0;n<p.length;n++)(h=this._updateObject(f[l][p[n]],b[l+".$"],a,d,g+"."+l,k))&&(e=!0)}if(!q)if(k||"object"!==typeof b[l])switch(k){case "$inc":this._updateIncrement(f,l,b[l]);e=!0;break;case "$push":void 0===f[l]&&(f[l]=[]);if(f[l]instanceof Array){if(void 0!==b[l].$position&&b[l].$each instanceof Array)for(h=b[l].$position,q=b[l].$each.length,
n=0;n<q;n++)this._updateSplicePush(f[l],h+n,b[l].$each[n]);else if(b[l].$each instanceof Array)for(q=b[l].$each.length,n=0;n<q;n++)this._updatePush(f[l],b[l].$each[n]);else this._updatePush(f[l],b[l]);e=!0}else throw"Cannot push to a key that is not an array! ("+l+")";break;case "$pull":if(f[l]instanceof Array){p=[];for(n=0;n<f[l].length;n++)this._match(f[l][n],b[l])&&p.push(n);for(q=p.length;q--;)this._updatePull(f[l],p[q]),e=!0}break;case "$pullAll":if(f[l]instanceof Array)if(b[l]instanceof Array){if(p=
f[l],q=p.length,0<q)for(;q--;){for(h=0;h<b[l].length;h++)p[q]===b[l][h]&&(this._updatePull(f[l],q),q--,e=!0);if(0>q)break}}else throw"Cannot pullAll without being given an array of values to pull! ("+l+")";break;case "$addToSet":void 0===f[l]&&(f[l]=[]);if(f[l]instanceof Array){n=f[l];var m;p=n.length;var t;q=!0;m=d&&d.$addToSet;var s;m&&m.key?(h=!1,s=new c(m.key),t=s.value(b[l])[0]):(t=JSON.stringify(b[l]),h=!0);for(m=0;m<p;m++)if(h){if(JSON.stringify(n[m])===t){q=!1;break}}else if(t===s.value(n[m])[0]){q=
!1;break}q&&(this._updatePush(f[l],b[l]),e=!0)}else throw"Cannot addToSet on a key that is not an array! (undefined)!";break;case "$splicePush":void 0===f[l]&&(f[l]=[]);if(f[l]instanceof Array)if(h=b.$index,void 0!==h)delete b.$index,h>f[l].length&&(h=f[l].length),this._updateSplicePush(f[l],h,b[l]),e=!0;else throw"Cannot splicePush without a $index integer value!";else throw"Cannot splicePush with a key that is not an array! ("+l+")";break;case "$move":if(f[l]instanceof Array)for(n=0;n<f[l].length;n++){if(this._match(f[l][n],
b[l])){e=b.$index;if(void 0!==e)delete b.$index,this._updateSpliceMove(f[l],n,e),e=!0;else throw"Cannot move without a $index integer value!";break}}else throw"Cannot move on a key that is not an array! ("+l+")";break;case "$mul":this._updateMultiply(f,l,b[l]);e=!0;break;case "$rename":this._updateRename(f,l,b[l]);e=!0;break;case "$unset":this._updateUnset(f,l);e=!0;break;case "$pop":if(f[l]instanceof Array)this._updatePop(f[l],b[l])&&(e=!0);else throw"Cannot pop from a key that is not an array! ("+
l+")";break;default:f[l]!==b[l]&&(this._updateProperty(f,l,b[l]),e=!0)}else if(null!==f[l]&&"object"===typeof f[l])if(n=f[l]instanceof Array,p=b[l]instanceof Array,n||p)if(!p&&n)for(n=0;n<f[l].length;n++)(h=this._updateObject(f[l][n],b[l],a,d,g+"."+l,k))&&(e=!0);else f[l]!==b[l]&&(this._updateProperty(f,l,b[l]),e=!0);else(h=this._updateObject(f[l],b[l],a,d,g+"."+l,k))&&(e=!0);else f[l]!==b[l]&&(this._updateProperty(f,l,b[l]),e=!0)}return e};b.prototype._isPositionalKey=function(f){return".$"===f.substr(f.length-
2,2)};b.prototype._updateProperty=function(f,b,a){this._linked?(jQuery.observable(f).setProperty(b,a),this.debug()&&console.log('ForerunnerDB.Collection: Setting data-bound document property "'+b+'" for collection "'+this.name()+'"')):(f[b]=a,this.debug()&&console.log('ForerunnerDB.Collection: Setting non-data-bound document property "'+b+'" for collection "'+this.name()+'"'))};b.prototype._updateIncrement=function(f,b,a){this._linked?jQuery.observable(f).setProperty(b,f[b]+a):f[b]+=a};b.prototype._updateSpliceMove=
function(f,b,a){this._linked?(jQuery.observable(f).move(b,a),this.debug()&&console.log('ForerunnerDB.Collection: Moving data-bound document array index from "'+b+'" to "'+a+'" for collection "'+this.name()+'"')):(f.splice(a,0,f.splice(b,1)[0]),this.debug()&&console.log('ForerunnerDB.Collection: Moving non-data-bound document array index from "'+b+'" to "'+a+'" for collection "'+this.name()+'"'))};b.prototype._updateSplicePush=function(f,b,a){f.length>b?this._linked?jQuery.observable(f).insert(b,a):
f.splice(b,0,a):this._linked?jQuery.observable(f).insert(a):f.push(a)};b.prototype._updatePush=function(f,b){this._linked?jQuery.observable(f).insert(b):f.push(b)};b.prototype._updatePull=function(f,b){this._linked?jQuery.observable(f).remove(b):f.splice(b,1)};b.prototype._updateMultiply=function(f,b,a){this._linked?jQuery.observable(f).setProperty(b,f[b]*a):f[b]*=a};b.prototype._updateRename=function(f,b,a){var d=f[b];this._linked?(jQuery.observable(f).setProperty(a,d),jQuery.observable(f).removeProperty(b)):
(f[a]=d,delete f[b])};b.prototype._updateUnset=function(f,b){this._linked?jQuery.observable(f).removeProperty(b):delete f[b]};b.prototype._updatePop=function(f,b){var a,d=!1;0<f.length&&(this._linked?(1===b?a=f.length-1:-1===b&&(a=0),-1<a&&(jQuery.observable(arr).remove(a),d=!0)):1===b?(f.pop(),d=!0):-1===b&&(f.shift(),d=!0));return d};b.prototype.remove=function(f,b,a){var d,c;if(f instanceof Array){c=[];for(a=0;a<f.length;a++)c.push(this.remove(f[a],{noEmit:!0}));(!b||b&&!b.noEmit)&&this._onRemove(c);
return c}a=this.find(f,{$decouple:!1});if(a.length){for(c=0;c<a.length;c++)d=a[c],this._removeIndex(d),d=this._data.indexOf(d),this._linked?jQuery.observable(this._data).remove(d):this._data.splice(d,1);this.chainSend("remove",{query:f},b);(!b||b&&!b.noEmit)&&this._onRemove(a);this.deferEmit("change",{type:"remove",data:a})}return a};b.prototype.removeById=function(f){var b={};b[this._primaryKey]=f;return this.remove(b)};b.prototype.deferEmit=function(){var f=this,b;this._noEmitDefer||this._db&&(!this._db||
this._db._noEmitDefer)?this.emit.apply(this,arguments):(b=arguments,this._changeTimeout&&clearTimeout(this._changeTimeout),this._changeTimeout=setTimeout(function(){f.debug()&&console.log("ForerunnerDB.Collection: Emitting "+b[0]);f.emit.apply(f,b)},100))};b.prototype.processQueue=function(f,b){var a=this._deferQueue[f],d=this._deferThreshold[f],c=this._deferTime[f];if(a.length){var g=this;a.length&&(a=a.length>d?a.splice(0,d):a.splice(0,a.length),this[f](a));setTimeout(function(){g.processQueue(f,
b)},c)}else b&&b()};b.prototype.insert=function(f,b,a){"function"===typeof b?(a=b,b=this._data.length):void 0===b&&(b=this._data.length);f=this.transformIn(f);return this._insertHandle(f,b,a)};b.prototype._insertHandle=function(f,b,a){var d=this._deferQueue.insert,c=this._deferThreshold.insert,g=[],e=[];if(f instanceof Array){if(f.length>c){this._deferQueue.insert=d.concat(f);this.processQueue("insert",a);return}for(c=0;c<f.length;c++)d=this._insert(f[c],b+c),!0===d?g.push(f[c]):e.push({doc:f[c],
reason:d})}else d=this._insert(f,b),!0===d?g.push(f):e.push({doc:f,reason:d});this.chainSend("insert",f,{index:b});this._onInsert(g,e);a&&a();this.deferEmit("change",{type:"insert",data:g});return{inserted:g,failed:e}};b.prototype._insert=function(f,b){if(f){var a;this._ensurePrimaryKey(f);if(a=this.insertIndexViolation(f))return"Index violation in index: "+a;this._insertIndex(f);b>this._data.length&&(b=this._data.length);this._linked?jQuery.observable(this._data).insert(b,f):this._data.splice(b,
0,f);return!0}return"No document passed to insert"};b.prototype._insertIndex=function(f){var b=this._indexByName,a,d,c=JSON.stringify(f);d=this._primaryIndex.uniqueSet(f[this._primaryKey],f);this._primaryCrc.uniqueSet(f[this._primaryKey],c);this._crcLookup.uniqueSet(c,f);for(a in b)b.hasOwnProperty(a)&&b[a].insert(f);return d};b.prototype._removeIndex=function(f){var b=this._indexByName,a,d=JSON.stringify(f);this._primaryIndex.unSet(f[this._primaryKey]);this._primaryCrc.unSet(f[this._primaryKey]);
this._crcLookup.unSet(d);for(a in b)b.hasOwnProperty(a)&&b[a].remove(f)};b.prototype.subset=function(f,a){var d=this.find(f,a);return(new b)._subsetOf(this).primaryKey(this._primaryKey).setData(d)};b.prototype.subsetOf=function(){return this.__subsetOf};b.prototype._subsetOf=function(f){this.__subsetOf=f;return this};b.prototype.distinct=function(f,b,a){b=this.find(b,a);f=new c(f);a={};var d=[],g,e;for(e=0;e<b.length;e++)(g=f.value(b[e])[0])&&!a[g]&&(a[g]=!0,d.push(g));return d};b.prototype.decouple=
h.common.decouple;b.prototype.findById=function(f,b){var a={};a[this._primaryKey]=f;return this.find(a,b)[0]};b.prototype.peek=function(f,a){var d=this._data,c=d.length,g,e,k=new b;if("string"===typeof f){for(g=0;g<c;g++)e=JSON.stringify(d[g]),-1<e.indexOf(f)&&k.insert(d[g]);return k.find({},a)}return this.find(f,a)};b.prototype.explain=function(f,b){return this.find(f,b).__fdbOp._data};b.prototype.find=function(f,b){f=f||{};b=b||{};b.$decouple=void 0!==b.$decouple?b.$decouple:!0;var a=this._metrics.create("find"),
d=this,g,e=!0,k,h,m,p,n,l,u,t,s,x=[];h=function(b){return d._match(b,f,"and")};a.start();if(f){a.time("analyseQuery");g=this._analyseQuery(f,b,a);a.time("analyseQuery");a.data("analysis",g);if(g.hasJoin&&g.queriesJoin){a.time("joinReferences");for(m=0;m<g.joinsOn.length;m++)n=g.joinsOn[m],p=new c(g.joinQueries[n]),p=p.value(f)[0],this._db.collection(g.joinsOn[m]).subset(p);a.time("joinReferences")}g.indexMatch.length&&(!b||b&&!b.$skipIndex)?(a.data("index.potential",g.indexMatch),a.data("index.used",
g.indexMatch[0].index),a.time("indexLookup"),k=g.indexMatch[0].lookup,a.time("indexLookup"),g.indexMatch[0].keyData.totalKeyCount===g.indexMatch[0].keyData.matchedKeyCount&&(e=!1)):a.flag("usedIndex",!1);e&&(k&&k.length?(g=k.length,a.time("tableScan: "+g),k=k.filter(h)):(g=this._data.length,a.time("tableScan: "+g),k=this._data.filter(h)),b.$orderBy&&(a.time("sort"),k=this.sort(b.$orderBy,k),a.time("sort")),a.time("tableScan: "+g));b.limit&&k&&k.length>b.limit&&(k.length=b.limit,a.data("limit",b.limit));
b.$decouple&&(a.time("decouple"),k=this.decouple(k),a.time("decouple"),a.data("flag.decouple",!0));if(b.join){for(h=0;h<b.join.length;h++)for(n in b.join[h])if(b.join[h].hasOwnProperty(n))for(t=n,g=this._db.collection(n),e=b.join[h][n],s=0;s<k.length;s++){u={};p=m=!1;for(l in e)if(e.hasOwnProperty(l))if("$"===l.substr(0,1))switch(l){case "$as":t=e[l];break;case "$multi":m=e[l];break;case "$require":p=e[l];break;default:l.substr(0,3)}else u[l]=(new c(e[l])).value(k[s])[0];u=g.find(u);!p||p&&u[0]?k[s][t]=
!1===m?u[0]:u:x.push(k[s])}a.data("flag.join",!0)}if(x.length){a.time("removalQueue");for(l=0;l<x.length;l++)n=k.indexOf(x[l]),-1<n&&k.splice(n,1);a.time("removalQueue")}if(b.transform){a.time("transform");for(l=0;l<k.length;l++)k.splice(l,1,b.transform(k[l]));a.time("transform");a.data("flag.transform",!0)}this._transformEnabled&&this._transformOut&&(a.time("transformOut"),k=this.transformOut(k),a.time("transformOut"));a.data("results",k.length);a.stop()}else a.stop(),k=[];k.__fdbOp=a;return k};
b.prototype.indexOf=function(f){if(f=this.find(f,{$decouple:!1})[0])return this._data.indexOf(f)};b.prototype.transform=function(f){return void 0!==f?("object"===typeof f?(void 0!==f.enabled&&(this._transformEnabled=f.enabled),void 0!==f.dataIn&&(this._transformIn=f.dataIn),void 0!==f.dataOut&&(this._transformOut=f.dataOut)):this._transformEnabled=!1===f?!1:!0,this):{enabled:this._transformEnabled,dataIn:this._transformIn,dataOut:this._transformOut}};b.prototype.transformIn=function(f){if(this._transformEnabled&&
this._transformIn){if(f instanceof Array){var b=[],a;for(a=0;a<f.length;a++)b[a]=this._transformIn(f[a]);return b}return this._transformIn(f)}return f};b.prototype.transformOut=function(f){if(this._transformEnabled&&this._transformOut){if(f instanceof Array){var b=[],a;for(a=0;a<f.length;a++)b[a]=this._transformOut(f[a]);return b}return this._transformOut(f)}return f};b.prototype.sort=function(f,b){b=b||[];var a=[],d,c;for(d in f)f.hasOwnProperty(d)&&(c={},c[d]=f[d],c.___fdbKey=d,a.push(c));return 2>
a.length?this._sort(f,b):this._bucketSort(a,b)};b.prototype._bucketSort=function(f,b){var a=f.shift(),d,c,g=[];if(0<f.length){b=this._sort(a,b);d=this.bucket(a.___fdbKey,b);for(c in d)d.hasOwnProperty(c)&&(a=[].concat(f),g=g.concat(this._bucketSort(a,d[c])));return g}return this._sort(a,b)};b.prototype._sort=function(f,b){var a,d=new c;a=d.parse(f,!0)[0];d.path(a.path);if(1===a.value)a=function(f,b){var a=d.value(f)[0],c=d.value(b)[0];return"string"===typeof a&&"string"===typeof c?a.localeCompare(c):
a>c?1:a<c?-1:0};else if(-1===a.value)a=function(f,b){var a=d.value(f)[0],c=d.value(b)[0];return"string"===typeof a&&"string"===typeof c?1===a.localeCompare(c)?-1:1:a>c?-1:a<c?1:0};else throw this._name+": $orderBy clause has invalid direction: "+a.value+", accepted values are 1 or -1 for ascending or descending!";return b.sort(a)};b.prototype.bucket=function(f,b){var a,d={};for(a=0;a<b.length;a++)d[b[a][f]]=d[b[a][f]]||[],d[b[a][f]].push(b[a]);return d};b.prototype._analyseQuery=function(f,b,a){var d=
{queriesOn:[this._name],indexMatch:[],hasJoin:!1,queriesJoin:!1,joinQueries:{},query:f,options:b},g,k=[],e=[],h,m,p,n,l;a.time("checkIndexes");void 0!==f[this._primaryKey]&&(a.time("checkIndexMatch: Primary Key"),h=new c,d.indexMatch.push({lookup:this._primaryIndex.lookup(f,b),keyData:{matchedKeys:[this._primaryKey],matchedKeyCount:1,totalKeyCount:h.countKeys(f)},index:this._primaryIndex}),a.time("checkIndexMatch: Primary Key"));for(l in this._indexById)if(this._indexById.hasOwnProperty(l)&&(m=this._indexById[l],
p=m.name(),a.time("checkIndexMatch: "+p),h=m.match(f,b),n=m.lookup(f,b),0<h.matchedKeyCount&&d.indexMatch.push({lookup:n,keyData:h,index:m}),a.time("checkIndexMatch: "+p),h.totalKeyCount===h.matchedKeyCount))break;a.time("checkIndexes");1<d.indexMatch.length&&(a.time("findOptimalIndex"),d.indexMatch.sort(function(f,b){return f.keyData.totalKeyCount===f.keyData.matchedKeyCount?-1:b.keyData.totalKeyCount===b.keyData.matchedKeyCount?1:f.keyData.matchedKeyCount===b.keyData.matchedKeyCount?f.lookup.length-
b.lookup.length:b.keyData.matchedKeyCount-f.keyData.matchedKeyCount}),a.time("findOptimalIndex"));if(b.join){d.hasJoin=!0;for(a=0;a<b.join.length;a++)for(g in b.join[a])b.join[a].hasOwnProperty(g)&&(k.push(g),"$as"in b.join[a][g]?e.push(b.join[a][g].$as):e.push(g));for(g=0;g<e.length;g++)if(b=this._queryReferencesCollection(f,e[g],""))d.joinQueries[k[g]]=b,d.queriesJoin=!0;d.joinsOn=k;d.queriesOn=d.queriesOn.concat(k)}return d};b.prototype._queryReferencesCollection=function(f,b,a){for(var d in f)if(f.hasOwnProperty(d)){if(d===
b)return a&&(a+="."),a+d;if("object"===typeof f[d])return a&&(a+="."),a+=d,this._queryReferencesCollection(f[d],b,a)}return!1};b.prototype._match=function(b,a,d){var c,g;c=typeof b;g=typeof a;var k=!0,e;if(!("string"!==c&&"number"!==c||"string"!==g&&"number"!==g))b!==a&&(k=!1);else for(e in a)if(a.hasOwnProperty(e)){c=!1;if("$"===e.substr(0,1))switch(e){case "$gt":if(b>a[e]){if("or"===d)return!0}else k=!1;c=!0;break;case "$gte":if(b>=a[e]){if("or"===d)return!0}else k=!1;c=!0;break;case "$lt":if(b<
a[e]){if("or"===d)return!0}else k=!1;c=!0;break;case "$lte":if(b<=a[e]){if("or"===d)return!0}else k=!1;c=!0;break;case "$exists":if(void 0===b!==a[e]){if("or"===d)return!0}else k=!1;c=!0;break;case "$or":c=!0;for(g=0;g<a[e].length;g++){if(this._match(b,a[e][g],"and"))return!0;k=!1}break;case "$and":c=!0;for(g=0;g<a[e].length;g++)if(!this._match(b,a[e][g],"and"))return!1;break;case "$in":if(a[e]instanceof Array){c=a[e];g=c.length;var h,m=!1;for(h=0;h<g;h++)if(c[h]===b){m=!0;break}if(m){if("or"===d)return!0}else k=
!1}else throw"Cannot use a $nin operator on a non-array key: "+e;c=!0;break;case "$nin":if(a[e]instanceof Array){c=a[e];g=c.length;m=!0;for(h=0;h<g;h++)if(c[h]===b){m=!1;break}if(m){if("or"===d)return!0}else k=!1}else throw"Cannot use a $nin operator on a non-array key: "+e;c=!0;break;case "$ne":if(b!=a[e]){if("or"===d)return!0}else k=!1;c=!0}if(!c&&a[e]instanceof RegExp)if(c=!0,"object"===typeof b&&void 0!==b[e]&&a[e].test(b[e])){if("or"===d)return!0}else k=!1;if(!c)if("object"===typeof a[e])if(void 0!==
b[e]){if(b[e]instanceof Array&&!(a[e]instanceof Array))for(c=!1,g=0;g<b[e].length&&!(c=this._match(b[e][g],a[e],void 0));g++);else if(!(b[e]instanceof Array)&&a[e]instanceof Array)for(c=!1,g=0;g<a[e].length&&!(c=this._match(b[e],a[e][g],void 0));g++);else c="object"===typeof b?this._match(b[e],a[e],void 0):this._match(void 0,a[e],void 0);if(c){if("or"===d)return!0}else k=!1}else if(a[e]&&void 0!==a[e].$exists)if(c=this._match(void 0,a[e],void 0)){if("or"===d)return!0}else k=!1;else k=!1;else if(b&&
b[e]===a[e]){if("or"===d)return!0}else if(b&&b[e]&&b[e]instanceof Array&&a[e]&&"object"!==typeof a[e]){c=!1;for(g=0;g<b[e].length&&!(c=this._match(b[e][g],a[e],void 0));g++);if(c){if("or"===d)return!0}else k=!1}else k=!1;if("and"===d&&!k)return!1}return k};b.prototype.count=function(b,a){return b?this.find(b,a).length:this._data.length};b.prototype.link=function(b,a){if(window.jQuery){this._links=this._links||{};var d,c;a&&"object"===typeof a?a.template&&"string"===typeof a.template&&(d=this.objectId(a.template),
c=a.template):d=a;if(!this._links[d]){if(jQuery(b).length){if(!jQuery.templates[d]){if(!c)if(c=jQuery(a),c.length)c=jQuery(c[0]).html();else throw"Unable to bind collection to target because template does not exist: "+a;jQuery.views.templates(d,c)}jQuery.templates[d].link(b,this._data);this._links[d]=b;this._linked++;this.debug()&&console.log('ForerunnerDB.Collection: Added binding collection "'+this.name()+'" to output target: '+b);return this}throw'Cannot bind view data to output target selector "'+
b+'" because it does not exist in the DOM!';}throw"Cannot create a duplicate link to the target: "+b+" with the template: "+d;}throw"Cannot data-bind without jQuery, please add jQuery to your page!";};b.prototype.unlink=function(b,a){if(window.jQuery){this._links=this._links||{};var d;a&&"object"===typeof a?a.template&&"string"===typeof a.template&&(d=this.objectId(a.template)):d=a;if(this._links[d])return jQuery.templates[d].unlink(b),delete this._links[d],this._linked--,this.debug()&&console.log('ForerunnerDB.Collection: Removed binding collection "'+
this.name()+'" to output target: '+b),this;console.log("Cannot remove link, one does not exist to the target: "+b+" with the template: "+a)}else throw"Cannot data-bind without jQuery, please add jQuery to your page!";return this};b.prototype.isLinked=function(){return Boolean(this._data._linked)};b.prototype.findSub=function(b,a,d,g){var e=new c(a);b=this.find(b);var k=b.length,h,m,q=this._db.collection("__FDB_temp_"+this.objectId()),p={parents:k,subDocTotal:0,subDocs:[],pathFound:!1,err:""};for(h=
0;h<k;h++)if(m=e.value(b[h])[0]){q.setData(m);m=q.find(d,g);if(g.returnFirst&&m.length)return m[0];p.subDocs.push(m);p.subDocTotal+=m.length;p.pathFound=!0}q.drop();if(g.noStats)return p.subDocs;p.pathFound||(p.err="No objects found in the parent documents with a matching path of: "+a);return p};b.prototype.insertIndexViolation=function(b){var a,d=this._indexByName,c,g;if(this._primaryIndex.get(b[this._primaryKey]))a=this._primaryIndex;else for(c in d)if(d.hasOwnProperty(c)&&(g=d[c],g.unique()&&g.violation(b))){a=
g;break}return a?a.name():!1};b.prototype.ensureIndex=function(b,d){this._indexByName=this._indexByName||{};this._indexById=this._indexById||{};var c=new a(b,d,this),g={start:(new Date).getTime()};if(this._indexByName[c.name()])return{err:"Index with that name already exists"};if(this._indexById[c.id()])return{err:"Index with those keys already exists"};c.rebuild();this._indexByName[c.name()]=c;this._indexById[c.id()]=c;g.end=(new Date).getTime();g.total=g.end-g.start;this._lastOp={type:"ensureIndex",
stats:{time:g}};return{index:c,id:c.id(),name:c.name(),state:c.state()}};b.prototype.index=function(b){if(this._indexByName)return this._indexByName[b]};b.prototype.lastOp=function(){return this._metrics.list()};b.prototype.objectId=h.common.objectId;b.prototype.diff=function(b){var a={insert:[],update:[],remove:[]},d=this.primaryKey(),c,g,e,k;if(d===b.primaryKey()){for(c=b._data;c&&!(c instanceof Array);)b=c,c=b._data;k=c.length;for(g=0;g<k;g++)e=c[g],this._primaryIndex.get(e[d])?this._primaryCrc.get(e[d])!==
b._primaryCrc.get(e[d])&&a.update.push(e):a.insert.push(e);c=this._data;k=c.length;for(g=0;g<k;g++)e=c[g],b._primaryIndex.get(e[d])||a.remove.push(e)}else throw"Collection diffing requires that both collections have the same primary key!";return a};e.prototype.collection=function(a,d){if(a)return this._collection[a]||this.debug()&&console.log("Creating collection "+a),this._collection[a]=this._collection[a]||(new b(a)).db(this),void 0!==d&&this._collection[a].primaryKey(d),this._collection[a];throw"Cannot get collection with undefined name!";
};e.prototype.collectionExists=function(b){return Boolean(this._collection[b])};e.prototype.collections=function(){var b=[],a;for(a in this._collection)this._collection.hasOwnProperty(a)&&b.push({name:a,count:this._collection[a].count()});return b};m.exports=b},{"./Crc":6,"./Index":9,"./KeyValueStore":10,"./Metrics":11,"./Path":16,"./Shared":19}],4:[function(e,m,h){var k,g;h=e("./Shared");var c=function(){this.init.apply(this,arguments)};c.prototype.init=function(a){this._name=a;this._data=new g("__FDB__cg_data_"+
this._name);this._collections=[];this._views=[]};h.addModule("CollectionGroup",c);h.inherit(c.prototype,h.chainReactor);g=e("./Collection");e=h.modules.Core;k=h.modules.Core.prototype.init;c.prototype.debug=h.common.debug;c.prototype.on=function(){this._data.on.apply(this._data,arguments)};c.prototype.off=function(){this._data.off.apply(this._data,arguments)};c.prototype.emit=function(){this._data.emit.apply(this._data,arguments)};c.prototype.primaryKey=function(a){return void 0!==a?(this._primaryKey=
a,this):this._primaryKey};h.synthesize(c.prototype,"db");c.prototype.addCollection=function(a){if(a&&-1===this._collections.indexOf(a)){if(this._collections.length){if(this._primaryKey!==a.primaryKey())throw"All collections in a collection group must have the same primary key!";}else this.primaryKey(a.primaryKey());this._collections.push(a);a._groups.push(this);a.chain(this);this._data.insert(a.find())}return this};c.prototype.removeCollection=function(a){if(a){var d=this._collections.indexOf(a);
-1!==d&&(a.unChain(this),this._collections.splice(d,1),d=a._groups.indexOf(this),-1!==d&&a._groups.splice(d,1));0===this._collections.length&&delete this._primaryKey}return this};c.prototype.decouple=h.common.decouple;c.prototype._chainHandler=function(a){switch(a.type){case "setData":a.data=this.decouple(a.data);this._data.remove(a.options.oldData);this._data.insert(a.data);break;case "insert":a.data=this.decouple(a.data);this._data.insert(a.data);break;case "update":this._data.update(a.data.query,
a.data.update,a.options);break;case "remove":this._data.remove(a.data.query,a.options)}};c.prototype.insert=function(){this._collectionsRun("insert",arguments)};c.prototype.update=function(){this._collectionsRun("update",arguments)};c.prototype.updateById=function(){this._collectionsRun("updateById",arguments)};c.prototype.remove=function(){this._collectionsRun("remove",arguments)};c.prototype._collectionsRun=function(a,d){for(var b=0;b<this._collections.length;b++)this._collections[b][a].apply(this._collections[b],
d)};c.prototype.find=function(a,d){return this._data.find(a,d)};c.prototype.removeById=function(a){for(var d=0;d<this._collections.length;d++)this._collections[d].removeById(a)};c.prototype.subset=function(a,d){var b=this.find(a,d);return(new g)._subsetOf(this).primaryKey(this._primaryKey).setData(b)};c.prototype.drop=function(){var a,d=[].concat(this._collections),b=[].concat(this._views);this._debug&&console.log("Dropping collection group "+this._name);for(a=0;a<d.length;a++)this.removeCollection(d[a]);
for(a=0;a<b.length;a++)this._removeView(b[a]);this.emit("drop");return!0};e.prototype.init=function(){this._collectionGroup={};k.apply(this,arguments)};e.prototype.collectionGroup=function(a){return a?(this._collectionGroup[a]=this._collectionGroup[a]||(new c(a)).db(this),this._collectionGroup[a]):this._collectionGroup};m.exports=c},{"./Collection":3,"./Shared":19}],5:[function(e,m,h){var k,g;k=e("./Shared.js");h=function(){this.init.apply(this,arguments)};h.prototype.init=function(){this._collection=
{};this._debug={};this._version="1.2.7"};h.prototype.moduleLoaded=k.overload({string:function(c){if(void 0!==c){c=c.replace(/ /g,"");var a=c.split(","),d;for(d=0;d<a.length;d++)if(!k.modules[c])return!1;return!0}return!1},"string, function":function(c,a){if(void 0!==c){c=c.replace(/ /g,"");var d=c.split(","),b;for(b=0;b<d.length;b++)if(!k.modules[c])return!1;a()}},"string, function, function":function(c,a,d){if(void 0!==c){c=c.replace(/ /g,"");var b=c.split(","),f;for(f=0;f<b.length;f++)if(!k.modules[c])return d(),
!1;a()}}});h.moduleLoaded=h.prototype.moduleLoaded;h.shared=k;h.prototype.shared=k;k.addModule("Core",h);k.inherit(h.prototype,k.chainReactor);g=e("./Collection.js");e("./Metrics.js");e=e("./Crc.js");h.prototype._isServer=!1;h.prototype.isClient=function(){return!this._isServer};h.prototype.isServer=function(){return this._isServer};h.prototype.crc=e;h.prototype.isClient=function(){return!this._isServer};h.prototype.isServer=function(){return this._isServer};h.prototype.decouple=k.common.decouple;
h.prototype.debug=k.common.debug;h.prototype.arrayToCollection=function(c){return(new g).setData(c)};h.prototype.on=function(c,a){this._listeners=this._listeners||{};this._listeners[c]=this._listeners[c]||[];this._listeners[c].push(a);return this};h.prototype.off=function(c,a){if(c in this._listeners){var d=this._listeners[c],b=d.indexOf(a);-1<b&&d.splice(b,1)}return this};h.prototype.emit=function(c,a){this._listeners=this._listeners||{};if(c in this._listeners){var d=this._listeners[c],b=d.length,
f;for(f=0;f<b;f++)d[f].apply(this,Array.prototype.slice.call(arguments,1))}return this};h.prototype.objectId=k.common.objectId;h.prototype.peek=function(c){var a,d,b=[],f=typeof c;for(a in this._collection)this._collection.hasOwnProperty(a)&&(d=this._collection[a],b="string"===f?b.concat(d.peek(c)):b.concat(d.find(c)));return b};h.prototype.peekCat=function(c){var a,d,b={},f,g=typeof c;for(a in this._collection)this._collection.hasOwnProperty(a)&&(d=this._collection[a],(f="string"===g?d.peek(c):d.find(c))&&
f.length&&(b[d.name()]=f));return b};m.exports=h},{"./Collection.js":3,"./Crc.js":6,"./Metrics.js":11,"./Shared.js":19}],6:[function(e,m,h){var k=function(){var g=[],c,a,d;for(a=0;256>a;a++){c=a;for(d=0;8>d;d++)c=c&1?3988292384^c>>>1:c>>>1;g[a]=c}return g}();m.exports=function(g){var c=-1,a;for(a=0;a<g.length;a++)c=c>>>8^k[(c^g.charCodeAt(a))&255];return(c^-1)>>>0}},{}],7:[function(e,m,h){var k,g;h=e("./Shared");var c=function(){this.init.apply(this,arguments)};c.prototype.init=function(a){this._name=
a;this._data={}};h.addModule("Document",c);h.inherit(c.prototype,h.chainReactor);e=e("./Collection");k=h.modules.Core;g=h.modules.Core.prototype.init;h.synthesize(c.prototype,"db");h.synthesize(c.prototype,"name");c.prototype.setData=function(a){var d,b;if(a)if(a=this.decouple(a),this._linked){b={};for(d in this._data)"jQuery"!==d.substr(0,6)&&this._data.hasOwnProperty(d)&&void 0===a[d]&&(b[d]=1);a.$unset=b;this._updateObject(this._data,a,{})}else this._data=a;return this};c.prototype.decouple=h.common.decouple;
c.prototype.objectId=h.common.objectId;c.prototype.on=h.common.on;c.prototype.off=h.common.off;c.prototype.emit=h.common.emit;c.prototype.debug=h.common.debug;c.prototype.update=function(a,d,b){this._updateObject(this._data,d,a,b)};c.prototype._updateObject=e.prototype._updateObject;c.prototype._isPositionalKey=function(a){return".$"===a.substr(a.length-2,2)};c.prototype._updateProperty=function(a,d,b){this._linked?(jQuery.observable(a).setProperty(d,b),this.debug()&&console.log('ForerunnerDB.Document: Setting data-bound document property "'+
d+'" for collection "'+this.name()+'"')):(a[d]=b,this.debug()&&console.log('ForerunnerDB.Document: Setting non-data-bound document property "'+d+'" for collection "'+this.name()+'"'))};c.prototype._updateIncrement=function(a,d,b){this._linked?jQuery.observable(a).setProperty(d,a[d]+b):a[d]+=b};c.prototype._updateSpliceMove=function(a,d,b){this._linked?(jQuery.observable(a).move(d,b),this.debug()&&console.log('ForerunnerDB.Document: Moving data-bound document array index from "'+d+'" to "'+b+'" for collection "'+
this.name()+'"')):(a.splice(b,0,a.splice(d,1)[0]),this.debug()&&console.log('ForerunnerDB.Document: Moving non-data-bound document array index from "'+d+'" to "'+b+'" for collection "'+this.name()+'"'))};c.prototype._updateSplicePush=function(a,d,b){a.length>d?this._linked?jQuery.observable(a).insert(d,b):a.splice(d,0,b):this._linked?jQuery.observable(a).insert(b):a.push(b)};c.prototype._updatePush=function(a,d){this._linked?jQuery.observable(a).insert(d):a.push(d)};c.prototype._updatePull=function(a,
d){this._linked?jQuery.observable(a).remove(d):a.splice(d,1)};c.prototype._updateMultiply=function(a,d,b){this._linked?jQuery.observable(a).setProperty(d,a[d]*b):a[d]*=b};c.prototype._updateRename=function(a,d,b){var f=a[d];this._linked?(jQuery.observable(a).setProperty(b,f),jQuery.observable(a).removeProperty(d)):(a[b]=f,delete a[d])};c.prototype._updateUnset=function(a,d){this._linked?jQuery.observable(a).removeProperty(d):delete a[d]};c.prototype._updatePop=function(a,d){var b,f=!1;0<a.length&&
(this._linked?(1===d?b=a.length-1:-1===d&&(b=0),-1<b&&(jQuery.observable(arr).remove(b),f=!0)):1===d?(a.pop(),f=!0):-1===d&&(a.shift(),f=!0));return f};c.prototype.link=function(a,d){if(window.jQuery){this._links=this._links||{};this._linked||(this._linked=0);var b,f;d&&"object"===typeof d?d.template&&"string"===typeof d.template&&(b=this.objectId(d.template),f=d.template):b=d;if(!this._links[b]){if(jQuery(a).length){if(!jQuery.templates[b]){if(!f)if(f=jQuery(d),f.length)f=jQuery(f[0]).html();else throw"Unable to bind document to target because template does not exist: "+
d;jQuery.views.templates(b,f)}jQuery.templates[b].link(a,this._data);this._links[b]=a;this._linked++;this.debug()&&console.log('ForerunnerDB.Document: Added binding document "'+this.name()+'" to output target: '+a);return this}throw'Cannot bind view data to output target selector "'+a+'" because it does not exist in the DOM!';}throw"Cannot create a duplicate link to the target: "+a+" with the template: "+b;}throw"Cannot data-bind without jQuery, please add jQuery to your page!";};c.prototype.unlink=
function(a,d){if(window.jQuery){this._links=this._links||{};var b;d&&"object"===typeof d?d.template&&"string"===typeof d.template&&(b=this.objectId(d.template)):b=d;if(this._links[b])return jQuery.templates[b].unlink(a),delete this._links[b],this._linked--,this.debug()&&console.log('ForerunnerDB.Document: Removed binding document "'+this.name()+'" to output target: '+a),this;console.log("Cannot remove link, one does not exist to the target: "+a+" with the template: "+d)}else throw"Cannot data-bind without jQuery, please add jQuery to your page!";
};c.prototype.drop=function(){this._db&&this._name&&this._db&&this._db._document&&this._db._document[this._name]&&(delete this._db._document[this._name],this._data={})};k.prototype.init=function(){g.apply(this,arguments)};k.prototype.document=function(a){return a?(this._document=this._document||{},this._document[a]=this._document[a]||(new c(a)).db(this),this._document[a]):this._document};m.exports=c},{"./Collection":3,"./Shared":19}],8:[function(e,m,h){var k;e=e("./Shared");var g=function(c,a){this.init.apply(this,
arguments)};g.prototype.init=function(c,a){this._options=a;this._selector=$(this._options.selector);this._listeners={};this._collection=c;this._options.series=[];var d,b;switch(this._options.type){case "pie":this._selector.highcharts(this._options.chartOptions);this._chart=this._selector.highcharts();d=this._collection.find();b={allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!0,format:"<b>{point.name}</b>: {y} ({point.percentage:.0f}%)",style:{color:Highcharts.theme&&Highcharts.theme.contrastTextColor||
"black"}}};d=this.pieDataFromCollectionData(d,this._options.keyField,this._options.valField);$.extend(b,this._options.seriesOptions);$.extend(b,{type:"pie",name:this._options.seriesName,data:d});this._chart.addSeries(b);break;case "line":d=this.lineDataFromCollectionData(this._options.seriesField,this._options.keyField,this._options.valField,this._options.orderBy),this._options.chartOptions.xAxis=d.xAxis,this._options.chartOptions.series=d.series,this._selector.highcharts(this._options.chartOptions),
this._chart=this._selector.highcharts()}this._hookEvents()};e=e.modules.Collection;k=e.prototype.init;g.prototype.pieDataFromCollectionData=function(c,a,d){var b=[],f;for(f=0;f<c.length;f++)b.push([c[f][a],c[f][d]]);return b};g.prototype.lineDataFromCollectionData=function(c,a,d,b){var f=this._collection.distinct(c),g=[],e={categories:[]},k,h,m,w,v;for(w=0;w<f.length;w++){k=f[w];h={};h[c]=k;m=[];h=this._collection.find(h,{orderBy:b});for(v=0;v<h.length;v++)e.categories.push(h[v][a]),m.push(h[v][d]);
g.push({name:k,data:m})}return{xAxis:e,series:g}};g.prototype._hookEvents=function(){this._collection.on("change",this._changeListener);this._collection.on("drop",this._dropListener)};g.prototype._changeListener=function(){if("undefined"!==typeof this._collection&&this._chart){var c=this._collection.find();switch(this._options.type){case "pie":this._chart.series[0].setData(this.pieDataFromCollectionData(c,this._options.keyField,this._options.valField));break;case "line":c=this.lineDataFromCollectionData(this._options.seriesField,
this._options.keyField,this._options.valField,this._options.orderBy);this._chart.xAxis[0].setCategories(c.xAxis.categories);for(var a=0;a<c.series.length;a++)this._chart.series[a].setData(c.series[a].data)}}};g.prototype._dropListener=function(){this._collection.off("change",this._changeListener);this._collection.off("drop",this._dropListener)};g.prototype.drop=function(){this._chart.destroy();this._collection.off("change",this._changeListener);this._collection.off("drop",this._dropListener);delete this._collection._highcharts[this._options.selector];
delete this._chart;delete this._options;delete this._collection;return this};e.prototype.init=function(){this._highcharts={};k.apply(this,arguments)};e.prototype.chart=function(c){this._highcharts[c.selector]||(this._highcharts[c.selector]=new g(this,c));return this._highcharts[c.selector]};e.prototype.dropChart=function(c){this._highcharts[c]&&this._highcharts[c].drop()};m.exports=g},{"./Shared":19}],9:[function(e,m,h){h=e("./Shared");var k=e("./Path");e=function(){this.init.apply(this,arguments)};
e.prototype.init=function(g,c,a){this._crossRef={};this._size=0;this._id=this._itemKeyHash(g,g);this.data({});this.unique(c&&c.unique?c.unique:!1);void 0!==g&&this.keys(g);void 0!==a&&this.collection(a);this.name(c&&c.name?c.name:this._id)};h.addModule("Index",e);h.inherit(e.prototype,h.chainReactor);e.prototype.id=function(){return this._id};e.prototype.state=function(){return this._state};e.prototype.size=function(){return this._size};e.prototype.data=function(g){return void 0!==g?(this._data=g,
this):this._data};h.synthesize(e.prototype,"name");e.prototype.collection=function(g){return void 0!==g?(this._collection=g,this):this._collection};e.prototype.keys=function(g){return void 0!==g?(this._keys=g,this._keyCount=(new k).parse(this._keys).length,this):this._keys};e.prototype.type=function(g){return void 0!==g?(this._type=g,this):this._type};e.prototype.unique=function(g){return void 0!==g?(this._unique=g,this):this._unique};e.prototype.rebuild=function(){if(this._collection){var g=this._collection.subset({},
{$decouple:!1,$orderBy:this._keys}).find(),c,a=g.length;this._data={};this._unique&&(this._uniqueLookup={});for(c=0;c<a;c++)this.insert(g[c])}this._state={name:this._name,keys:this._keys,indexSize:this._size,built:new Date,updated:new Date,ok:!0}};e.prototype.insert=function(g,c){var a,d;this._unique&&(a=this._itemHash(g,this._keys),this._uniqueLookup[a]=g);a=this._itemHashArr(g,this._keys);for(d=0;d<a.length;d++)this.pushToPathValue(a[d],g)};e.prototype.remove=function(g,c){var a,d;this._unique&&
(a=this._itemHash(g,this._keys),delete this._uniqueLookup[a]);a=this._itemHashArr(g,this._keys);for(d=0;d<a.length;d++)this.pullFromPathValue(a[d],g)};e.prototype.violation=function(g){g=this._itemHash(g,this._keys);return Boolean(this._uniqueLookup[g])};e.prototype.hashViolation=function(g){return Boolean(this._uniqueLookup[g])};e.prototype.pushToPathValue=function(g,c){var a=this._data[g]=this._data[g]||[];-1===a.indexOf(c)&&(a.push(c),this._size++,this.pushToCrossRef(c,a))};e.prototype.pullFromPathValue=
function(g,c){var a=this._data[g],d;d=a.indexOf(c);-1<d&&(a.splice(d,1),this._size--,this.pullFromCrossRef(c,a));a.length||delete this._data[g]};e.prototype.pull=function(g){var c=g[this._collection.primaryKey()],a=this._crossRef[c],d,b=a.length,f;for(d=0;d<b;d++)f=a[d],this._pullFromArray(f,g);this._size--;delete this._crossRef[c]};e.prototype._pullFromArray=function(g,c){for(var a=g.length;a--;)g[a]===c&&g.splice(a,1)};e.prototype.pushToCrossRef=function(g,c){var a=g[this._collection.primaryKey()];
this._crossRef[a]=this._crossRef[a]||[];a=this._crossRef[a];-1===a.indexOf(c)&&a.push(c)};e.prototype.pullFromCrossRef=function(g,c){var a=g[this._collection.primaryKey()];delete this._crossRef[a]};e.prototype.lookup=function(g){return this._data[this._itemHash(g,this._keys)]||[]};e.prototype.match=function(g,c){return(new k).countObjectPaths(this._keys,g)};e.prototype._itemHash=function(g,c){var a=new k,d,b="",f;d=a.parse(c);for(f=0;f<d.length;f++)b&&(b+="_"),b+=a.value(g,d[f].path).join(":");return b};
e.prototype._itemKeyHash=function(g,c){var a=new k,d,b="",f;d=a.parse(c);for(f=0;f<d.length;f++)b&&(b+="_"),b+=a.keyValue(g,d[f].path);return b};e.prototype._itemHashArr=function(g,c){var a=new k,d,b=[],f,e,h,m;d=a.parse(c);for(h=0;h<d.length;h++)for(f=a.value(g,d[h].path),e=0;e<f.length;e++)if(0===h)b.push(f[e]);else for(m=0;m<b.length;m++)b[m]=b[m]+"_"+f[e];return b};m.exports=e},{"./Path":16,"./Shared":19}],10:[function(e,m,h){e=e("./Shared");h=function(e){this.init.apply(this,arguments)};h.prototype.init=
function(e){this._name=e;this._data={};this._primaryKey="_id"};e.addModule("KeyValueStore",h);e.inherit(h.prototype,e.chainReactor);e.synthesize(h.prototype,"name");h.prototype.primaryKey=function(e){return void 0!==e?(this._primaryKey=e,this):this._primaryKey};h.prototype.truncate=function(){this._data={};return this};h.prototype.set=function(e,g){this._data[e]=g?g:!0;return this};h.prototype.get=function(e){return this._data[e]};h.prototype.lookup=function(e){e=e[this._primaryKey];var g,c,a,d;if(e instanceof
Array){c=e.length;d=[];for(g=0;g<c;g++)(a=this._data[e[g]])&&d.push(a);return d}if(e instanceof RegExp){d=[];for(g in this._data)this._data.hasOwnProperty(g)&&e.test(g)&&d.push(this._data[g]);return d}if("object"===typeof e){if(e.$ne){d=[];for(g in this._data)this._data.hasOwnProperty(g)&&g!==e.$ne&&d.push(this._data[g]);return d}if(e.$in&&e.$in instanceof Array){d=[];for(g in this._data)this._data.hasOwnProperty(g)&&-1<e.$in.indexOf(g)&&d.push(this._data[g]);return d}if(e.$nin&&e.$nin instanceof
Array){d=[];for(g in this._data)this._data.hasOwnProperty(g)&&-1===e.$nin.indexOf(g)&&d.push(this._data[g]);return d}if(e.$or&&e.$or instanceof Array){d=[];for(g=0;g<e.$or.length;g++)d=d.concat(this.lookup(e.$or[g]));return d}}else return a=this._data[e],void 0!==a?[a]:[]};h.prototype.unSet=function(e){delete this._data[e];return this};h.prototype.uniqueSet=function(e,g){return void 0===this._data[e]?(this._data[e]=g,!0):!1};m.exports=h},{"./Shared":19}],11:[function(e,m,h){h=e("./Shared");var k=
e("./Operation");e=function(){this.init.apply(this,arguments)};e.prototype.init=function(){this._data=[]};h.addModule("Metrics",e);h.inherit(e.prototype,h.chainReactor);e.prototype.create=function(g){g=new k(g);this._enabled&&this._data.push(g);return g};e.prototype.start=function(){this._enabled=!0;return this};e.prototype.stop=function(){this._enabled=!1;return this};e.prototype.clear=function(){this._data=[];return this};e.prototype.list=function(){return this._data};m.exports=e},{"./Operation":14,
"./Shared":19}],12:[function(e,m,h){var k;e=e("./Shared").modules.OldView;k=e.prototype.init;e.prototype.init=function(){var g=this;this._binds=[];this._renderEnd=this._renderStart=0;this._deferQueue={insert:[],update:[],remove:[],upsert:[],_bindInsert:[],_bindUpdate:[],_bindRemove:[],_bindUpsert:[]};this._deferThreshold={insert:100,update:100,remove:100,upsert:100,_bindInsert:100,_bindUpdate:100,_bindRemove:100,_bindUpsert:100};this._deferTime={insert:100,update:1,remove:1,upsert:1,_bindInsert:100,
_bindUpdate:1,_bindRemove:1,_bindUpsert:1};k.apply(this,arguments);this.on("insert",function(c,a){g._bindEvent("insert",c,a)});this.on("update",function(c,a){g._bindEvent("update",c,a)});this.on("remove",function(c,a){g._bindEvent("remove",c,a)});this.on("change",g._bindChange)};e.prototype.bind=function(g,c){if(c&&c.template)this._binds[g]=c;else throw"Cannot bind data to element, missing options information!";return this};e.prototype.unBind=function(g){delete this._binds[g];return this};e.prototype.isBound=
function(g){return Boolean(this._binds[g])};e.prototype.bindSortDom=function(g,c){var a=$(g),d,b,f;this.debug()&&console.log("ForerunnerDB.OldView.Bind: Sorting data in DOM...",c);for(d=0;d<c.length;d++)b=c[d],f=a.find("#"+b[this._primaryKey]),f.length?0===d?(this.debug()&&console.log("ForerunnerDB.OldView.Bind: Sort, moving to index 0...",f),a.prepend(f)):(this.debug()&&console.log("ForerunnerDB.OldView.Bind: Sort, moving to index "+d+"...",f),f.insertAfter(a.children(":eq("+(d-1)+")"))):this.debug()&&
console.log("ForerunnerDB.OldView.Bind: Warning, element for array item not found!",b)};e.prototype.bindRefresh=function(g){var c=this._binds,a,d;g||(g={data:this.find()});for(a in c)c.hasOwnProperty(a)&&(d=c[a],this.debug()&&console.log("ForerunnerDB.OldView.Bind: Sorting DOM..."),this.bindSortDom(a,g.data),d.afterOperation&&d.afterOperation(),d.refresh&&d.refresh())};e.prototype.bindRender=function(g,c){var a=this._binds[g],d=$(g),b,f,e=$("<ul></ul>"),h;if(a){b=this._data.find();for(h=0;h<b.length;h++)f=
b[h],a.template(f,function(b){e.append(b)});c?c(g,e.html()):d.append(e.html())}};e.prototype.processQueue=function(g,c){var a=this._deferQueue[g],d=this._deferThreshold[g],b=this._deferTime[g];if(a.length){var f=this;a.length&&(a=a.length>d?a.splice(0,d):a.splice(0,a.length),this._bindEvent(g,a,[]));setTimeout(function(){f.processQueue(g,c)},b)}else c&&c(),this.emit("bindQueueComplete")};e.prototype._bindEvent=function(g,c,a){var d=this._binds,b=this.find({}),f,e;for(e in d)if(d.hasOwnProperty(e))switch(f=
d[e].reduce?this.find(d[e].reduce.query,d[e].reduce.options):b,g){case "insert":this._bindInsert(e,d[e],c,a,f);break;case "update":this._bindUpdate(e,d[e],c,a,f);break;case "remove":this._bindRemove(e,d[e],c,a,f)}};e.prototype._bindChange=function(g){this.debug()&&console.log("ForerunnerDB.OldView.Bind: Bind data change, refreshing bind...",g);this.bindRefresh(g)};e.prototype._bindInsert=function(g,c,a,d,b){var f=$(g),e;for(e=0;e<a.length;e++)g=f.find("#"+a[e][this._primaryKey]),g.length||c.template(a[e],
function(b,a,d,g){return function(b){c.insert?c.insert(b,a,d,g):c.prependInsert?f.prepend(b):f.append(b);c.afterInsert&&c.afterInsert(b,a,d,g)}}(g,a[e],d,b))};e.prototype._bindUpdate=function(g,c,a,d,b){var f=$(g);for(d=0;d<a.length;d++)g=f.find("#"+a[d][this._primaryKey]),c.template(a[d],function(a,d){return function(g){c.update?c.update(g,d,b,a.length?"update":"append"):a.length?a.replaceWith(g):c.prependUpdate?f.prepend(g):f.append(g);c.afterUpdate&&c.afterUpdate(g,d,b)}}(g,a[d]))};e.prototype._bindRemove=
function(g,c,a,d,b){g=$(g);var f;for(f=0;f<a.length;f++)d=g.find("#"+a[f][this._primaryKey]),d.length&&(c.beforeRemove?c.beforeRemove(d,a[f],b,function(b,a,f){return function(){c.remove?c.remove(b,a,f):(b.remove(),c.afterRemove&&c.afterRemove(b,a,f))}}(d,a[f],b)):c.remove?c.remove(d,a[f],b):(d.remove(),c.afterRemove&&c.afterRemove(d,a[f],b)))}},{"./Shared":19}],13:[function(e,m,h){var k,g,c,a,d;h=e("./Shared");var b=function(){this.init.apply(this,arguments)};b.prototype.init=function(b){var a=this;
this._name=b;this._groups=[];this._listeners={};this._query={query:{},options:{}};this._onFromSetData=function(){a._onSetData.apply(a,arguments)};this._onFromInsert=function(){a._onInsert.apply(a,arguments)};this._onFromUpdate=function(){a._onUpdate.apply(a,arguments)};this._onFromRemove=function(){a._onRemove.apply(a,arguments)};this._onFromChange=function(){a.debug()&&console.log("ForerunnerDB.OldView: Received change");a._onChange.apply(a,arguments)}};h.modules.OldView=b;k=e("./CollectionGroup");
g=e("./Collection");c=g.prototype.init;a=k.prototype.init;e=h.modules.Core;d=e.prototype.init;b.prototype.on=h.common.on;b.prototype.off=h.common.off;b.prototype.emit=h.common.emit;b.prototype.drop=function(){return(this._db||this._from)&&this._name?(this.debug()&&console.log("ForerunnerDB.OldView: Dropping view "+this._name),this.emit("drop"),this._db&&delete this._db._oldViews[this._name],this._from&&delete this._from._oldViews[this._name],!0):!1};b.prototype.debug=function(){return!1};b.prototype.db=
function(b){return void 0!==b?(this._db=b,this):this._db};b.prototype.from=function(b){if(void 0!==b){if("string"===typeof b)if(this._db.collectionExists(b))b=this._db.collection(b);else throw"Invalid collection in view.from() call.";this._from!==b&&(this._from&&this.removeFrom(),this.addFrom(b));return this}return this._from};b.prototype.addFrom=function(b){if(this._from=b)return this._from.on("setData",this._onFromSetData),this._from.on("change",this._onFromChange),this._from._addOldView(this),
this._primaryKey=this._from._primaryKey,this.refresh(),this;throw"Cannot determine collection type in view.from()";};b.prototype.removeFrom=function(){this._from.off("setData",this._onFromSetData);this._from.off("change",this._onFromChange);this._from._removeOldView(this)};b.prototype.primaryKey=function(){if(this._from)return this._from.primaryKey()};b.prototype.queryData=function(b,a,d){void 0!==b&&(this._query.query=b);void 0!==a&&(this._query.options=a);return void 0!==b||void 0!==a?(void 0!==
d&&!0!==d||this.refresh(),this):this._query};b.prototype.queryAdd=function(b,a,d){var c=this._query.query,g;if(void 0!==b)for(g in b)b.hasOwnProperty(g)&&(void 0===c[g]||void 0!==c[g]&&a)&&(c[g]=b[g]);void 0!==d&&!0!==d||this.refresh()};b.prototype.queryRemove=function(b,a){var d=this._query.query,c;if(void 0!==b)for(c in b)b.hasOwnProperty(c)&&delete d[c];void 0!==a&&!0!==a||this.refresh()};b.prototype.query=function(b,a){return void 0!==b?(this._query.query=b,void 0!==a&&!0!==a||this.refresh(),
this):this._query.query};b.prototype.queryOptions=function(b,a){return void 0!==b?(this._query.options=b,void 0!==a&&!0!==a||this.refresh(),this):this._query.options};b.prototype.refresh=function(b){if(this._from){var a=this._data,d,c,g,e,h,k=[],m=[],p=[],n;this.debug()&&(console.log("ForerunnerDB.OldView: Refreshing view "+this._name),console.log("ForerunnerDB.OldView: Existing data: "+("undefined"!==typeof this._data)),"undefined"!==typeof this._data&&console.log("ForerunnerDB.OldView: Current data rows: "+
this._data.find().length));this._query?(this.debug()&&console.log("ForerunnerDB.OldView: View has query and options, getting subset..."),this._data=this._from.subset(this._query.query,this._query.options)):this._query.options?(this.debug()&&console.log("ForerunnerDB.OldView: View has options, getting subset..."),this._data=this._from.subset({},this._query.options)):(this.debug()&&console.log("ForerunnerDB.OldView: View has no query or options, getting subset..."),this._data=this._from.subset({}));
if(!b&&a)if(this.debug()&&console.log("ForerunnerDB.OldView: Refresh not forced, old data detected..."),c=this._data,a.subsetOf()===c.subsetOf()){this.debug()&&console.log("ForerunnerDB.OldView: Old and new data are from same collection...");g=c.find();b=a.find();e=c._primaryKey;for(n=0;n<g.length;n++)h=g[n],d={},d[e]=h[e],(d=a.find(d)[0])?JSON.stringify(d)!==JSON.stringify(h)&&m.push(h):k.push(h);for(n=0;n<b.length;n++)h=b[n],d={},d[e]=h[e],c.find(d)[0]||p.push(h);this.debug()&&(console.log("ForerunnerDB.OldView: Removed "+
p.length+" rows"),console.log("ForerunnerDB.OldView: Inserted "+k.length+" rows"),console.log("ForerunnerDB.OldView: Updated "+m.length+" rows"));k.length&&this._onInsert(k,[]);m.length&&this._onUpdate(m,[]);p.length&&this._onRemove(p,[])}else this.debug()&&console.log("ForerunnerDB.OldView: Old and new data are from different collections..."),p=a.find(),p.length&&this._onRemove(p),k=c.find(),k.length&&this._onInsert(k);else this.debug()&&console.log("ForerunnerDB.OldView: Forcing data update",g),
this._data=this._from.subset(this._query.query,this._query.options),g=this._data.find(),this.debug()&&console.log("ForerunnerDB.OldView: Emitting change event with data",g),this._onInsert(g,[]);this.debug()&&console.log("ForerunnerDB.OldView: Emitting change");this.emit("change")}return this};b.prototype.count=function(){return this._data&&this._data._data?this._data._data.length:0};b.prototype.find=function(){return this._data?(this.debug()&&console.log("ForerunnerDB.OldView: Finding data in view collection...",
this._data),this._data.find.apply(this._data,arguments)):[]};b.prototype.insert=function(){return this._from?this._from.insert.apply(this._from,arguments):[]};b.prototype.update=function(){return this._from?this._from.update.apply(this._from,arguments):[]};b.prototype.remove=function(){return this._from?this._from.remove.apply(this._from,arguments):[]};b.prototype._onSetData=function(b,a){this.emit("remove",a,[]);this.emit("insert",b,[])};b.prototype._onInsert=function(b,a){this.emit("insert",b,a)};
b.prototype._onUpdate=function(b,a){this.emit("update",b,a)};b.prototype._onRemove=function(b,a){this.emit("remove",b,a)};b.prototype._onChange=function(){this.debug()&&console.log("ForerunnerDB.OldView: Refreshing data");this.refresh()};g.prototype.init=function(){this._oldViews=[];c.apply(this,arguments)};g.prototype._addOldView=function(b){void 0!==b&&(this._oldViews[b._name]=b);return this};g.prototype._removeOldView=function(b){void 0!==b&&delete this._oldViews[b._name];return this};k.prototype.init=
function(){this._oldViews=[];a.apply(this,arguments)};k.prototype._addOldView=function(b){void 0!==b&&(this._oldViews[b._name]=b);return this};k.prototype._removeOldView=function(b){void 0!==b&&delete this._oldViews[b._name];return this};e.prototype.init=function(){this._oldViews={};d.apply(this,arguments)};e.prototype.oldView=function(a){this._oldViews[a]||this.debug()&&console.log("ForerunnerDB.OldView: Creating view "+a);this._oldViews[a]=this._oldViews[a]||(new b(a)).db(this);return this._oldViews[a]};
e.prototype.oldViewExists=function(b){return Boolean(this._oldViews[b])};e.prototype.oldViews=function(){var b=[],a;for(a in this._oldViews)this._oldViews.hasOwnProperty(a)&&b.push({name:a,count:this._oldViews[a].count()});return b};m.exports=b},{"./Collection":3,"./CollectionGroup":4,"./Shared":19}],14:[function(e,m,h){h=e("./Shared");var k=e("./Path");e=function(g){this.pathSolver=new k;this.counter=0;this.init.apply(this,arguments)};e.prototype.init=function(g){this._data={operation:g,index:{potential:[],
used:!1},steps:[],time:{startMs:0,stopMs:0,totalMs:0,process:{}},flag:{},log:[]}};h.addModule("Operation",e);h.inherit(e.prototype,h.chainReactor);e.prototype.start=function(){this._data.time.startMs=(new Date).getTime()};e.prototype.log=function(g){if(g){var c=0<this._log.length?this._data.log[this._data.log.length-1].time:0;g={event:g,time:(new Date).getTime(),delta:0};this._data.log.push(g);c&&(g.delta=g.time-c);return this}return this._data.log};e.prototype.time=function(g){if(void 0!==g){var c=
this._data.time.process,c=c[g]=c[g]||{};c.startMs?(c.stopMs=(new Date).getTime(),c.totalMs=c.stopMs-c.startMs,c.stepObj.totalMs=c.totalMs,delete c.stepObj):(c.startMs=(new Date).getTime(),c.stepObj={name:g},this._data.steps.push(c.stepObj));return this}return this._data.time};e.prototype.flag=function(g,c){if(void 0!==g&&void 0!==c)this._data.flag[g]=c;else return void 0!==g?this._data.flag[g]:this._data.flag};e.prototype.data=function(g,c,a){return void 0!==c?(this.pathSolver.set(this._data,g,c),
this):this.pathSolver.get(this._data,g)};e.prototype.pushData=function(g,c,a){this.pathSolver.push(this._data,g,c)};e.prototype.stop=function(){this._data.time.stopMs=(new Date).getTime();this._data.time.totalMs=this._data.time.stopMs-this._data.time.startMs};m.exports=e},{"./Path":16,"./Shared":19}],15:[function(e,m,h){var k,g,c;h=e("./Shared");var a=function(){this.init.apply(this,arguments)};a.prototype.init=function(a){this._name=a;this._data=new c("__FDB__dc_data_"+this._name);this._collData=
new g;this._collections=[]};h.addModule("Overview",a);h.inherit(a.prototype,h.chainReactor);g=e("./Collection");c=e("./Document");e=h.modules.Core;k=h.modules.Core.prototype.init;h.synthesize(a.prototype,"db");h.synthesize(a.prototype,"name");h.synthesize(a.prototype,"query",function(a){var b=this.$super(a);void 0!==a&&this._refresh();return b});h.synthesize(a.prototype,"queryOptions",function(a){var b=this.$super(a);void 0!==a&&this._refresh();return b});h.synthesize(a.prototype,"reduce",function(a){var b=
this.$super(a);void 0!==a&&this._refresh();return b});a.prototype.debug=h.common.debug;a.prototype.objectId=h.common.objectId;a.prototype.from=function(a){void 0!==a&&("string"===typeof a&&(a=this._db.collection(a)),this._addCollection(a));return this};a.prototype.find=function(){return this._collData.find.apply(this._collData,arguments)};a.prototype.count=function(){return this._collData.count.apply(this._collData,arguments)};a.prototype._addCollection=function(a){-1===this._collections.indexOf(a)&&
(this._collections.push(a),a.chain(this),this._refresh());return this};a.prototype._removeCollection=function(a){-1<this._collections.indexOf(a)&&(this._collections.splice(a,1),a.unChain(this),this._refresh());return this};a.prototype._refresh=function(){if(this._collections&&this._collections[0]){this._collData.primaryKey(this._collections[0].primaryKey());var a=[],b;for(b=0;b<this._collections.length;b++)a=a.concat(this._collections[b].find(this._query,this._queryOptions));this._collData.setData(a)}this._reduce&&
(a=this._reduce(),this._data.setData(a))};a.prototype._chainHandler=function(a){switch(a.type){case "setData":case "insert":case "update":case "remove":this._refresh()}};a.prototype.link=function(a,b){this._data.link.apply(this._data,arguments);this._refresh()};a.prototype.unlink=function(a,b){this._data.unlink.apply(this._data,arguments);this._refresh()};a.prototype.isLinked=function(){return this._data.isLinked()};e.prototype.init=function(){this._overview={};k.apply(this,arguments)};e.prototype.overview=
function(d){return d?(this._overview[d]=this._overview[d]||(new a(d)).db(this),this._overview[d]):this._overview};m.exports=a},{"./Collection":3,"./Document":7,"./Shared":19}],16:[function(e,m,h){e=e("./Shared");h=function(e){this.init.apply(this,arguments)};h.prototype.init=function(e){e&&this.path(e)};e.addModule("Path",h);e.inherit(h.prototype,e.chainReactor);h.prototype.path=function(e){return void 0!==e?(this._path=this.clean(e),this._pathParts=this._path.split("."),this):this._path};h.prototype.hasObjectPaths=
function(e,g){var c=!0,a;for(a in e)if(e.hasOwnProperty(a)&&(void 0===g[a]||"object"===typeof e[a]&&(c=this.hasObjectPaths(e[a],g[a]),!c)))return!1;return c};h.prototype.countKeys=function(e){var g=0,c;for(c in e)e.hasOwnProperty(c)&&void 0!==e[c]&&("object"!==typeof e[c]?g++:g+=this.countKeys(e[c]));return g};h.prototype.countObjectPaths=function(e,g){var c,a={},d=0,b=0,f;for(f in g)g.hasOwnProperty(f)&&("object"===typeof g[f]?(c=this.countObjectPaths(e[f],g[f]),a[f]=c.matchedKeys,b+=c.totalKeyCount,
d+=c.matchedKeyCount):(b++,e&&e[f]&&"object"!==typeof e[f]?(a[f]=!0,d++):a[f]=!1));return{matchedKeys:a,matchedKeyCount:d,totalKeyCount:b}};h.prototype.parse=function(e,g){var c=[],a="",d,b,f;for(b in e)if(e.hasOwnProperty(b))if(a=b,"object"===typeof e[b])if(g)for(d=this.parse(e[b],g),f=0;f<d.length;f++)c.push({path:a+"."+d[f].path,value:d[f].value});else for(d=this.parse(e[b]),f=0;f<d.length;f++)c.push({path:a+"."+d[f].path});else g?c.push({path:a,value:e[b]}):c.push({path:a});return c};h.prototype.parseArr=
function(e,g){g=g||{};return this._parseArr(e,"",[],g)};h.prototype._parseArr=function(e,g,c,a){var d,b="";g=g||"";c=c||[];for(d in e)e.hasOwnProperty(d)&&(!a.ignore||a.ignore&&!a.ignore.test(d))&&(b=g?g+"."+d:d,"object"===typeof e[d]?this._parseArr(e[d],b,c,a):c.push(b));return c};h.prototype.value=function(e,g){if(void 0!==e&&"object"===typeof e){var c,a,d,b,f=[],h;void 0!==g&&(g=this.clean(g),c=g.split("."));c=c||this._pathParts;a=c.length;d=e;for(h=0;h<a;h++){d=d[c[h]];if(b instanceof Array){for(a=
0;a<b.length;a++)f=f.concat(this.value(b,a+"."+c[h]));return f}if(!d||"object"!==typeof d)break;b=d}return[d]}return[]};h.prototype.set=function(e,g,c){if(void 0!==e&&void 0!==g){var a;g=this.clean(g);g=g.split(".");a=g.shift();g.length?(e[a]=e[a]||{},this.set(e[a],g.join("."),c)):e[a]=c}return e};h.prototype.get=function(e,g){return this.value(e,g)[0]};h.prototype.push=function(e,g,c){if(void 0!==e&&void 0!==g){var a;g=this.clean(g);g=g.split(".");a=g.shift();if(g.length)e[a]=e[a]||{},this.set(e[a],
g.join("."),c);else if(e[a]=e[a]||[],e[a]instanceof Array)e[a].push(c);else throw"Cannot push to a path whose endpoint is not an array!";}return e};h.prototype.keyValue=function(e,g){var c,a,d,b,f;void 0!==g&&(g=this.clean(g),c=g.split("."));c=c||this._pathParts;a=c.length;d=e;for(f=0;f<a;f++)if(d=d[c[f]],!d||"object"!==typeof d){b=c[f]+":"+d;break}return b};h.prototype.clean=function(e){"."===e.substr(0,1)&&(e=e.substr(1,e.length-1));return e};m.exports=h},{"./Shared":19}],17:[function(e,m,h){h=
e("./Shared");var k,g,c,a;a=function(){this.init.apply(this,arguments)};a.prototype.init=function(a){a.isClient()&&void 0!==Storage&&this.mode("localStorage")};h.addModule("Persist",a);h.inherit(a.prototype,h.chainReactor);h=h.modules.Core;k=e("./Collection");g=k.prototype.drop;e("./CollectionGroup");c=h.prototype.init;a.prototype.mode=function(a){return void 0!==a?(this._mode=a,this):this._mode};a.prototype.save=function(a,b,c){switch(this.mode()){case "localStorage":b="object"===typeof b?"json::fdb::"+
JSON.stringify(b):"raw::fdb::"+b;try{localStorage.setItem(a,b)}catch(e){if(c)c(e);else throw e;break}if(c)c(!1);else return!1;break;default:if(c)c("No data handler.");else throw"No data handler.";}};a.prototype.load=function(a,b){var c,e;switch(this.mode()){case "localStorage":try{c=localStorage.getItem(a)}catch(g){b(g,null)}if(c){c=c.split("::fdb::");switch(c[0]){case "json":e=JSON.parse(c[1]);break;case "raw":e=c[1]}if(b)b(!1,e);else return e}break;default:if(b)b("No data handler or unrecognised data type.");
else throw"No data handler or unrecognised data type.";}};a.prototype.drop=function(a,b){switch(this.mode()){case "localStorage":try{localStorage.removeItem(a)}catch(c){b&&b(c)}b&&b(!1);break;default:b&&b("No data handler or unrecognised data type.")}};k.prototype.drop=function(a){if(a)if(this._name)if(this._db)this._db.persist.drop(this._name);else return callback&&callback("Cannot drop a collection's persistent storage when the collection is not attached to a database!"),"Cannot drop a collection's persistent storage when the collection is not attached to a database!";
else return callback&&callback("Cannot drop a collection's persistent storage when no name assigned to collection!"),"Cannot drop a collection's persistent storage when no name assigned to collection!";g.apply(this)};k.prototype.save=function(a){if(this._name)if(this._db)this._db.persist.save(this._name,this._data,a);else return a&&a("Cannot save a collection that is not attached to a database!"),"Cannot save a collection that is not attached to a database!";else return a&&a("Cannot save a collection with no assigned name!"),
"Cannot save a collection with no assigned name!"};k.prototype.load=function(a){var b=this;if(this._name)if(this._db)this._db.persist.load(this._name,function(c,e){if(c)return a&&a(c),c;e&&b.setData(e);a&&a(!1)});else return a&&a("Cannot load a collection that is not attached to a database!"),"Cannot load a collection that is not attached to a database!";else return a&&a("Cannot load a collection with no assigned name!"),"Cannot load a collection with no assigned name!"};h.prototype.init=function(){this.persist=
new a(this);c.apply(this,arguments)};m.exports=a},{"./Collection":3,"./CollectionGroup":4,"./Shared":19}],18:[function(e,m,h){e=e("./Shared");h=function(e,g,c){if(e&&g&&c){this._reactorIn=e;this._reactorOut=g;this._chainHandler=c;if(!e.chain||!g.chainReceive)throw"ReactorIO requires passed in and out objects to implement the ChainReactor mixin!";e.chain(this);this.chain(g)}else throw"ReactorIO requires an in, out and process argument to instantiate!";};h.prototype.drop=function(){this._reactorIn.unChain(this);
this.unChain(this._reactorOut);delete this._reactorIn;delete this._reactorOut;delete this._chainHandler};e.addModule("ReactorIO",h);e.inherit(h.prototype,e.chainReactor);m.exports=h},{"./Shared":19}],19:[function(e,m,h){var k=0,g=function(c){var a=[],d,b=["string","object","number","function","undefined"],f;if(-1<c.indexOf("*"))for(f=0;f<b.length;f++)d=c.replace("*",b[f]),a=a.concat(g(d));else a.push(c);return a};h=function(c){if(c){var a,d,b,f,e;if(!(c instanceof Array)){b={};for(a in c)if(c.hasOwnProperty(a))if(f=
a.replace(/ /g,""),-1===f.indexOf("*"))b[f]=c[a];else for(e=g(f),f=0;f<e.length;f++)b[e[f]]||(b[e[f]]=c[a]);c=b}return function(){if(c instanceof Array)for(d=c.length,a=0;a<d;a++){if(c[a].length===arguments.length)return c[a].apply(this,arguments)}else{var b=[],f;for(a=0;a<arguments.length;a++)b.push(typeof arguments[a]);f=b.join(",");if(c[f])return c[f].apply(this,arguments);for(a=b.length;0<=a;a--)if(f=b.slice(0,a).join(","),c[f+",..."])return c[f+",..."].apply(this,arguments)}throw"Overloaded method does not have a matching signature for the passed arguments!";
}}return function(){}};e={modules:{},common:{decouple:function(c){if(void 0!==c)return JSON.parse(JSON.stringify(c))},objectId:function(c){var a=Math.pow(10,17);if(c){var d=0,b=c.length,f;for(f=0;f<b;f++)d+=c.charCodeAt(f)*a;c=d.toString(16)}else k++,c=(k+(Math.random()*a+Math.random()*a+Math.random()*a+Math.random()*a)).toString(16);return c},debug:new h([function(){return this._debug&&this._debug.all},function(c){return void 0!==c?"boolean"===typeof c?(this._debug=this._debug||{},this._debug.all=
c,this.chainSend("debug",this._debug),this):this._debug&&this._debug[c]||this._db&&this._db._debug&&this._db._debug[c]||this._debug&&this._debug.all:this._debug&&this._debug.all},function(c,a){return void 0!==c?void 0!==a?(this._debug=this._debug||{},this._debug[c]=a,this.chainSend("debug",this._debug),this):this._debug&&this._debug[a]||this._db&&this._db._debug&&this._db._debug[c]:this._debug&&this._debug.all}]),on:new h({"string, function":function(c,a){this._listeners=this._listeners||{};this._listeners[c]=
this._listeners[c]||{};this._listeners[c]["*"]=this._listeners[c]["*"]||[];this._listeners[c]["*"].push(a);return this},"string, *, function":function(c,a,d){this._listeners=this._listeners||{};this._listeners[c]=this._listeners[c]||{};this._listeners[c][a]=this._listeners[c][a]||[];this._listeners[c][a].push(d);return this}}),off:new h({string:function(c){this._listeners&&this._listeners[c]&&c in this._listeners&&delete this._listeners[c];return this},"string, function":function(c,a){var d,b;"string"===
typeof a?this._listeners&&this._listeners[c]&&this._listeners[c][a]&&delete this._listeners[c][a]:c in this._listeners&&(d=this._listeners[c]["*"],b=d.indexOf(a),-1<b&&d.splice(b,1));return this},"string, *, function":function(c,a,d){this._listeners&&c in this._listeners&&a in this.listeners[c]&&(c=this._listeners[c][a],d=c.indexOf(d),-1<d&&c.splice(d,1))},"string, *":function(c,a){this._listeners&&c in this._listeners&&a in this._listeners[c]&&delete this._listeners[c][a]}}),emit:function(c,a){this._listeners=
this._listeners||{};if(c in this._listeners){if(this._listeners[c]["*"]){var d=this._listeners[c]["*"],b=d.length,f;for(f=0;f<b;f++)d[f].apply(this,Array.prototype.slice.call(arguments,1))}if(a instanceof Array&&a[0]&&a[0][this._primaryKey]){var d=this._listeners[c],e,g,b=a.length;for(f=0;f<b;f++)if(d[a[f][this._primaryKey]])for(e=d[a[f][this._primaryKey]].length,g=0;g<e;g++)d[a[f][this._primaryKey]][g].apply(this,Array.prototype.slice.call(arguments,1))}}return this}},_synth:{},addModule:function(c,
a){this.modules[c]=a},inherit:function(c,a){for(var d in a)a.hasOwnProperty(d)&&(c[d]=a[d])},synthesize:function(c,a,d){this._synth[a]=this._synth[a]||function(b){return void 0!==b?(this["_"+a]=b,this):this["_"+a]};if(d){var b=this;c[a]=function(){var c=this.$super,e;this.$super=b._synth[a];e=d.apply(this,arguments);this.$super=c;return e}}else c[a]=this._synth[a]},overload:h,chainReactor:e("./ChainReactor")};m.exports=e},{"./ChainReactor":2}],20:[function(e,m,h){var k,g,c,a;h=e("./Shared");var d=
function(a,c,d){this.init.apply(this,arguments)};d.prototype.init=function(a,c,d){this._name=a;this._groups=[];this._listeners={};this._querySettings={query:c,options:d};this._debug={};this._privateData=new k("__FDB__view_privateData_"+this._name)};h.addModule("View",d);h.inherit(d.prototype,h.chainReactor);k=e("./Collection");CollectionGroup=e("./CollectionGroup");a=e("./ReactorIO");g=k.prototype.init;e=h.modules.Core;c=e.prototype.init;h.synthesize(d.prototype,"name");d.prototype.debug=h.common.debug;
d.prototype.insert=function(){this._from.insert.apply(this._from,arguments)};d.prototype.update=function(){this._from.update.apply(this._from,arguments)};d.prototype.updateById=function(){this._from.updateById.apply(this._from,arguments)};d.prototype.remove=function(){this._from.remove.apply(this._from,arguments)};d.prototype.find=function(a,c){return this.publicData().find(a,c)};d.prototype.link=function(a,c){var d=this.publicData();this.debug()&&console.log('ForerunnerDB.View: Setting up data binding on view "'+
this.name()+'" in underlying (internal) view collection "'+d.name()+'" for output target: '+a);d.link(a,c);return this};d.prototype.unlink=function(a,c){var d=this.publicData();this.debug()&&console.log('ForerunnerDB.View: Removing data binding on view "'+this.name()+'" in underlying (internal) view collection "'+d.name()+'" for output target: '+a);d.unlink(a,c);return this};d.prototype.isLinked=function(){return this._privateData.isLinked()};d.prototype.decouple=h.common.decouple;d.prototype.from=
function(b){var c=this;if(void 0!==b){"string"===typeof b&&(b=this._db.collection(b));this._from=b;this._io=new a(b,this,function(a){var b,d,e;if("insert"===a.type){if(c._querySettings.query){b=a.data;if(b instanceof Array)for(d=[],a=0;a<b.length;a++)c._privateData._match(b[a],c._querySettings.query,"and")&&(d.push(b[a]),e=!0);else c._privateData._match(b,c._querySettings.query,"and")&&(d=b,e=!0);e&&this.chainSend("insert",d);return!0}return!1}if("update"===a.type){if(c._querySettings.query&&(d=c._privateData.diff(c._from.subset(c._querySettings.query,
c._querySettings.options)),d.insert.length||d.remove.length)){d.insert.length&&this.chainSend("insert",d.insert);if(d.update.length)for(b=c._privateData.primaryKey(),a=0;a<d.update.length;a++)e={},e[b]=d.update[a][b],this.chainSend("update",{query:e,update:d.update[a]});if(d.remove.length){e=[];var g={$or:e};for(a=0;a<d.remove.length;a++)e.push({_id:d.remove[a][b]});this.chainSend("remove",g)}return!0}return!1}});var d=b.find(this._querySettings.query,this._querySettings.options);this._transformPrimaryKey(b.primaryKey());
this._transformInsert(d);this._privateData.primaryKey(b.primaryKey());this._privateData.insert(d)}return this};d.prototype.ensureIndex=function(){return this._privateData.ensureIndex.apply(this._privateData,arguments)};d.prototype._chainHandler=function(a){var c,d,e,g;switch(a.type){case "setData":this.debug()&&console.log('ForerunnerDB.View: Setting data on view "'+this.name()+'" in underlying (internal) view collection "'+this._privateData.name()+'"');a.data=this.decouple(a.data);this._transformSetData(a.data);
this._privateData.setData(a.data);break;case "insert":this.debug()&&console.log('ForerunnerDB.View: Inserting some data on view "'+this.name()+'" in underlying (internal) view collection "'+this._privateData.name()+'"');a.data=this.decouple(a.data);a.data instanceof Array||(a.data=[a.data]);c=this._privateData._data.length;this._transformInsert(a.data,c);this._privateData._insertHandle(a.data,c);this._refreshSort(a.data);break;case "update":this.debug()&&console.log('ForerunnerDB.View: Updating some data on view "'+
this.name()+'" in underlying (internal) view collection "'+this._privateData.name()+'"');this._privateData.primaryKey();a=this._privateData.update(a.data.query,a.data.update,a.data.options);this._refreshSort(a);if(this._transformEnabled&&this._transformIn)for(c=this._publicData.primaryKey(),g=0;g<a.length;g++)d={},e=a[g],d[c]=e[c],this._transformUpdate(d,e);break;case "remove":this.debug()&&console.log('ForerunnerDB.View: Removing some data on view "'+this.name()+'" in underlying (internal) view collection "'+
this._privateData.name()+'"'),this._transformRemove(a.data.query,a.options),this._privateData.remove(a.data.query,a.options)}};d.prototype._refreshSort=function(){this._querySettings.options&&this._querySettings.options.$orderBy&&this._refreshSortAction()};d.prototype._refreshSortAction=function(){var a,c,d,e;delete this._refreshSortDebounce;a=this._privateData.find({},{$orderBy:this._querySettings.options.$orderBy,$decouple:!1});for(e=0;e<a.length;e++)c=this._privateData._data.indexOf(a[e]),d=a.indexOf(a[e]),
c!==d&&this._privateData._updateSpliceMove(this._privateData._data,c,d)};d.prototype.on=function(){this._privateData.on.apply(this._privateData,arguments)};d.prototype.off=function(){this._privateData.off.apply(this._privateData,arguments)};d.prototype.emit=function(){this._privateData.emit.apply(this._privateData,arguments)};d.prototype.drop=function(){return this._from?((this.debug()||this._db&&this._db.debug())&&console.log("ForerunnerDB.View: Dropping view "+this._name),this._io.drop(),this._privateData.drop(),
!0):!1};d.prototype.db=function(a){return void 0!==a?(this._db=a,this.privateData().db(a),this.publicData().db(a),this):this._db};d.prototype.primaryKey=function(){return this._privateData.primaryKey()};d.prototype.queryData=function(a,c,d){void 0!==a&&(this._querySettings.query=a);void 0!==c&&(this._querySettings.options=c);return void 0!==a||void 0!==c?(void 0!==d&&!0!==d||this.refresh(),this):this._querySettings};d.prototype.queryAdd=function(a,c,d){var e=this._querySettings.query,g;if(void 0!==
a)for(g in a)a.hasOwnProperty(g)&&(void 0===e[g]||void 0!==e[g]&&c)&&(e[g]=a[g]);void 0!==d&&!0!==d||this.refresh()};d.prototype.queryRemove=function(a,c){var d=this._querySettings.query,e;if(void 0!==a)for(e in a)a.hasOwnProperty(e)&&delete d[e];void 0!==c&&!0!==c||this.refresh()};d.prototype.query=function(a,c){return void 0!==a?(this._querySettings.query=a,void 0!==c&&!0!==c||this.refresh(),this):this._querySettings.query};d.prototype.queryOptions=function(a,c){return void 0!==a?(this._querySettings.options=
a,void 0===a.$decouple&&(a.$decouple=!0),void 0!==c&&!0!==c||this.refresh(),this):this._querySettings.options};d.prototype.refresh=function(){if(this._from){var a=this.publicData();this._privateData.remove();a.remove();this._privateData.insert(this._from.find(this._querySettings.query,this._querySettings.options))}return this};d.prototype.count=function(){return this._privateData&&this._privateData._data?this._privateData._data.length:0};d.prototype.transform=function(a){return void 0!==a?("object"===
typeof a?(void 0!==a.enabled&&(this._transformEnabled=a.enabled),void 0!==a.dataIn&&(this._transformIn=a.dataIn),void 0!==a.dataOut&&(this._transformOut=a.dataOut)):this._transformEnabled=!1===a?!1:!0,this._transformPrimaryKey(this.privateData().primaryKey()),this._transformSetData(this.privateData().find()),this):{enabled:this._transformEnabled,dataIn:this._transformIn,dataOut:this._transformOut}};d.prototype.privateData=function(){return this._privateData};d.prototype.publicData=function(){return this._transformEnabled?
this._publicData:this._privateData};d.prototype._transformSetData=function(a){this._transformEnabled&&(this._publicData=new k("__FDB__view_publicData_"+this._name),this._publicData.db(this._privateData._db),this._publicData.transform({enabled:!0,dataIn:this._transformIn,dataOut:this._transformOut}),this._publicData.setData(a))};d.prototype._transformInsert=function(a,c){this._transformEnabled&&this._publicData&&this._publicData.insert(a,c)};d.prototype._transformUpdate=function(a,c,d){this._transformEnabled&&
this._publicData&&this._publicData.update(a,c,d)};d.prototype._transformRemove=function(a,c){this._transformEnabled&&this._publicData&&this._publicData.remove(a,c)};d.prototype._transformPrimaryKey=function(a){this._transformEnabled&&this._publicData&&this._publicData.primaryKey(a)};k.prototype.init=function(){this._views=[];g.apply(this,arguments)};k.prototype.view=function(a,c,e){if(this._db&&this._db._views){if(this._db._views[a])throw"Cannot create a view using this collection because one with this name already exists: "+
a;a=(new d(a,c,e)).db(this._db)._addCollection(this);this._views=this._views||[];this._views.push(a);return a}};k.prototype._addView=CollectionGroup.prototype._addView=function(a){void 0!==a&&this._views.push(a);return this};k.prototype._removeView=CollectionGroup.prototype._removeView=function(a){void 0!==a&&(a=this._views.indexOf(a),-1<a&&this._views.splice(a,1));return this};e.prototype.init=function(){this._views={};c.apply(this,arguments)};e.prototype.view=function(a){this._views[a]||(this.debug()||
this._db&&this._db.debug())&&console.log("Core.View: Creating view "+a);this._views[a]=this._views[a]||(new d(a)).db(this);return this._views[a]};e.prototype.viewExists=function(a){return Boolean(this._views[a])};e.prototype.views=function(){var a=[],c;for(c in this._views)this._views.hasOwnProperty(c)&&a.push({name:c,count:this._views[c].count()});return a};m.exports=d},{"./Collection":3,"./CollectionGroup":4,"./ReactorIO":18,"./Shared":19}]},{},[1])(1)});
