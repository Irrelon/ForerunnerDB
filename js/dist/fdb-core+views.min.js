!function(x){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=x();else if("function"==typeof define&&define.amd)define([],x);else{var k;"undefined"!=typeof window?k=window:"undefined"!=typeof global?k=global:"undefined"!=typeof self&&(k=self);k.ForerunnerDB=x()}}(function(){return function k(q,m,g){function a(b,e){if(!m[b]){if(!q[b]){var f="function"==typeof require&&require;if(!e&&f)return f(b,!0);if(c)return c(b,!0);f=Error("Cannot find module '"+b+"'");throw f.code="MODULE_NOT_FOUND",
f;}f=m[b]={exports:{}};q[b][0].call(f.exports,function(d){var h=q[b][1][d];return a(h?h:d)},f,f.exports,k,q,m,g)}return m[b].exports}for(var c="function"==typeof require&&require,e=0;e<g.length;e++)a(g[e]);return a}({1:[function(k,q,m){m=k("../lib/Core");k("../lib/View");q.exports=m},{"../lib/Core":3,"../lib/View":12}],2:[function(k,q,m){var g,a,c,e,b,l;g=k("./Shared");var f=function(d){this.init.apply(this,arguments)};f.prototype.init=function(d){this._primaryKey="_id";this._primaryIndex=new c("primary");
this._primaryCrc=new c("primaryCrc");this._crcLookup=new c("crcLookup");this._name=d;this._data=[];this._groups=[];this._metrics=new a;this._linked=0;this._debug={};this._deferQueue={insert:[],update:[],remove:[],upsert:[]};this._deferThreshold={insert:100,update:100,remove:100,upsert:100};this._deferTime={insert:1,update:1,remove:1,upsert:1};this._subsetOf(this)};g.modules.Collection=f;m=k("./Overload");a=k("./Metrics");c=k("./KeyValueStore");e=k("./Path");b=k("./Index");l=k("./Crc");k=g.modules.Core;
f.prototype.debug=new m([function(){return this._debug.all},function(d){if(void 0!==d){if("boolean"===typeof d){this._debug.all=d;for(var h=0;h<this._views.length;h++)this._views[h].debug(d);return this}return this._debug[d]||this._db&&this._db._debug&&this._db._debug[d]||this._debug.all}return this._debug.all},function(d,h){if(void 0!==d){if(void 0!==h){this._debug[d]=h;for(var r=0;r<this._views.length;r++)this._views[r].debug(d,h);return this}return this._debug[d]||this._db&&this._db._debug&&this._db._debug[d]}return this._debug.all}]);
f.prototype.crc=l;f.prototype.name=function(d){return void 0!==d?(this._name=d,this):this._name};f.prototype.on=new m([function(d,h){this._listeners=this._listeners||{};this._listeners[d]=this._listeners[d]||{};this._listeners[d]["*"]=this._listeners[d]["*"]||[];this._listeners[d]["*"].push(h);return this},function(d,h,r){this._listeners=this._listeners||{};this._listeners[d]=this._listeners[d]||{};this._listeners[d][h]=this._listeners[d][h]||[];this._listeners[d][h].push(r);return this}]);f.prototype.off=
new m([function(d){this._listeners&&this._listeners[d]&&d in this._listeners&&delete this._listeners[d];return this},function(d,h){var r,b;"string"===typeof h?this._listeners&&this._listeners[d]&&this._listeners[d][h]&&delete this._listeners[d][h]:d in this._listeners&&(r=this._listeners[d]["*"],b=r.indexOf(h),-1<b&&r.splice(b,1));return this},function(d,h,r){this._listeners&&d in this._listeners&&(d=this._listeners[d][h],r=d.indexOf(r),-1<r&&d.splice(r,1))}]);f.prototype.emit=function(d,h){this._listeners=
this._listeners||{};if(d in this._listeners){if(this._listeners[d]["*"]){var r=this._listeners[d]["*"],b=r.length,a;for(a=0;a<b;a++)r[a].apply(this,Array.prototype.slice.call(arguments,1))}if(h instanceof Array&&h[0]&&h[0][this._primaryKey]){var r=this._listeners[d],e,f,b=h.length;for(a=0;a<b;a++)if(r[h[a][this._primaryKey]])for(e=r[h[a][this._primaryKey]].length,f=0;f<e;f++)r[h[a][this._primaryKey]][f].apply(this,Array.prototype.slice.call(arguments,1))}}return this};f.prototype.drop=function(){if(this._db&&
this._name){this.debug()&&console.log("Dropping collection "+this._name);this.emit("drop");delete this._db._collection[this._name];var d=[],h;for(h=0;h<this._groups.length;h++)d.push(this._groups[h]);for(h=0;h<d.length;h++)this._groups[h].removeCollection(this);return!0}return!1};f.prototype.primaryKey=function(d){return void 0!==d?(this._primaryKey=d,this._primaryIndex.primaryKey(d),this._rebuildPrimaryKeyIndex(),this):this._primaryKey};f.prototype._onInsert=function(d,h){this.emit("insert",d,h)};
f.prototype._onUpdate=function(d){this.emit("update",d)};f.prototype._onRemove=function(d){this.emit("remove",d)};f.prototype.db=function(d){return void 0!==d?(this._db=d,this):this._db};f.prototype.setData=function(d,h,b){if(d){var a=this._metrics.create("setData");a.start();d instanceof Array||(d=[d]);a.time("transformIn");d=this.transformIn(d);a.time("transformIn");var e=this._data;this._data=[];d.length&&(this._data=this._data.concat(d));a.time("_rebuildPrimaryKeyIndex");this._rebuildPrimaryKeyIndex(h);
a.time("_rebuildPrimaryKeyIndex");a.stop();this.emit("setData",this._data,e)}b&&b(!1);return this};f.prototype._rebuildPrimaryKeyIndex=function(d){var h=d&&void 0!==d.ensureKeys?d.ensureKeys:!0;d=d&&void 0!==d.violationCheck?d.violationCheck:!0;var b,a,e,f=this._primaryIndex,c=this._primaryCrc,g=this._crcLookup,l=this._primaryKey,k;f.truncate();c.truncate();g.truncate();b=this._data;for(a=b.length;a--;)if(e=b[a],h&&this._ensurePrimaryKey(e),d){if(!f.uniqueSet(e[l],e))throw"Call to setData failed because your data violates the primary key unique constraint. One or more documents are using the same primary key: "+
e[this._primaryKey];}else k=JSON.stringify(e),f.set(e[l],e),c.set(e[l],k),g.set(k,e)};f.prototype._ensurePrimaryKey=function(d){void 0===d[this._primaryKey]&&(d[this._primaryKey]=this.objectId())};f.prototype.truncate=function(){this.emit("truncate",this._data);this._data.length=0;this.deferEmit("change");return this};f.prototype.upsert=function(d,h){if(d){var b=this._deferQueue.upsert,a=this._deferThreshold.upsert,e={},f;if(d instanceof Array){if(d.length>a){this._deferQueue.upsert=b.concat(d);this.processQueue("upsert",
h);return}e=[];for(b=0;b<d.length;b++)e.push(this.upsert(d[b]));h&&h();return e}d[this._primaryKey]?(f={},f[this._primaryKey]=d[this._primaryKey],this.count(f)?e.op="update":e.op="insert"):e.op="insert";switch(e.op){case "insert":e.result=this.insert(d);break;case "update":e.result=this.update(f,d)}return e}h&&h()};f.prototype.update=function(d,h,b){h=this.decouple(h);h=this.transformIn(h);this.debug()&&console.log('Updating some collection data for collection "'+this.name()+'"');var e=this,a=this._metrics.create("update"),
f=this._primaryKey,c,g,l=function(a){if(h&&void 0!==h[f]&&h[f]!=a[f]){e._primaryIndex.unSet(a[f]);var c=e._updateObject(a,h,d,b,"");if(e._primaryIndex.uniqueSet(a[f],a))return c;throw"Primary key violation in update! Key violated: "+a[f];}return e._updateObject(a,h,d,b,"")},k=this._views;a.start();a.time("Retrieve documents to update");c=this.find(d,{decouple:!1});a.time("Retrieve documents to update");if(c.length&&(a.time("Update documents"),g=c.filter(l),a.time("Update documents"),g.length)){if(k&&
k.length){this.debug("views")&&console.log("Updating views from collection: "+this.name());a.time("Inform views of update");for(c=0;c<k.length;c++)k[c].update(d,h);a.time("Inform views of update")}this._onUpdate(g);this.deferEmit("change",{type:"update",data:g})}a.stop();return g||[]};f.prototype.updateById=function(d,h){var b={};b[this._primaryKey]=d;return this.update(b,h)};f.prototype._updateObject=function(d,h,b,a,f){h=this.decouple(h);f=f||"";"."===f.substr(0,1)&&(f=f.substr(1,f.length-1));var c=
!1,g=!1,l,k,m,p,n;for(p in h)if(h.hasOwnProperty(p)){l=!1;if("$"===p.substr(0,1))switch(p){case "$inc":l=!0;for(n in h[p])if(h[p].hasOwnProperty(n)&&"$"!==n.substr(0,1))if("number"===typeof d[n])this._updateIncrement(d,n,h[p][n]),c=!0;else throw"Cannot increment field that is not a number! ("+n+")!";break;case "$push":l=!0;for(n in h[p])if(h[p].hasOwnProperty(n)&&"$"!==n.substr(0,1))if(void 0===d[n]&&(d[n]=[]),d[n]instanceof Array)this._updatePush(d[n],h[p][n]),c=!0;else throw"Cannot push to a key that is not an array! ("+
n+")!";break;case "$addToSet":l=!0;for(n in h[p])if(h[p].hasOwnProperty(n)&&"$"!==n.substr(0,1))if(d[n]instanceof Array){k=d[n];var q;m=k.length;var u,g=!0;q=a&&a.$addToSet;var s,v;q&&q.key?(s=!1,v=new e(q.key),u=v.value(h[p][n])[0]):(u=JSON.stringify(h[p][n]),s=!0);for(q=0;q<m;q++)if(s){if(JSON.stringify(k[q])===u){g=!1;break}}else if(u===v.value(k[q])[0]){g=!1;break}g&&(this._updatePush(d[n],h[p][n]),c=!0)}else throw"Cannot push to a key that is not an array! ("+n+")!";break;case "$splicePush":l=
!0;for(n in h[p])if(h[p].hasOwnProperty(n)&&"$"!==n.substr(0,1))if(d[n]instanceof Array)if(c=h[p].$index,void 0!==c)delete h[p][n].$index,this._updateSplicePush(d[n],c,h[p][n]),c=!0;else throw"Cannot splicePush without a $index integer value!";else throw"Cannot splicePush with a key that is not an array! ("+n+")!";break;case "$move":l=!0;for(n in h[p])if(h[p].hasOwnProperty(n)&&"$"!==n.substr(0,1))if(d[n]instanceof Array)for(m=0;m<d[n].length;m++){if(this._match(d[n][m],h[p][n])){c=h[p].$index;if(void 0!==
c)this._updateSpliceMove(d[n],m,c),c=!0;else throw"Cannot move without a $index integer value!";break}}else throw"Cannot pull from a key that is not an array! ("+n+")!";break;case "$pull":for(n in l=!0,h[p])if(h[p].hasOwnProperty(n)&&"$"!==n.substr(0,1))if(d[n]instanceof Array){k=[];for(m=0;m<d[n].length;m++)this._match(d[n][m],h[p][n])&&k.push(m);for(m=k.length;m--;)this._updatePull(d[n],k[m]),c=!0}else throw"Cannot pull from a key that is not an array! ("+n+")!";}if(".$"===p.substr(p.length-2,2)&&
(l=!0,p=p.substr(0,p.length-2),g=new e(f+"."+p),d[p]&&d[p]instanceof Array&&d[p].length)){k=[];for(m=0;m<d[p].length;m++)this._match(d[p][m],g.value(b)[0])&&k.push(m);for(m=0;m<k.length;m++)(g=this._updateObject(d[p][k[m]],h[p+".$"],b,a,f+"."+p))&&(c=!0)}if(!l)if("object"===typeof h[p])if(null!==d[p]&&"object"===typeof d[p])if(l=d[p]instanceof Array,k=h[p]instanceof Array,l||k)if(!k&&l)for(m=0;m<d[p].length;m++)(g=this._updateObject(d[p][m],h[p],b,a,f+"."+p))&&(c=!0);else this._updateProperty(d,p,
h[p]),c=!0;else(g=this._updateObject(d[p],h[p],b,a,f+"."+p))&&(c=!0);else this._updateProperty(d,p,h[p]),c=!0;else d[p]!==h[p]&&(this._updateProperty(d,p,h[p]),c=!0)}return c};f.prototype._updateProperty=function(d,h,b){this._linked?($.observable(d).setProperty(h,b),this.debug()&&console.log('ForerunnerDB.Collection: Setting data-bound document property "'+h+'" for collection "'+this.name()+'"')):(d[h]=b,this.debug()&&console.log('ForerunnerDB.Collection: Setting non-data-bound document property "'+
h+'" for collection "'+this.name()+'"'))};f.prototype._updateSpliceMove=function(d,h,b){this._linked?($.observable(d).move(h,b),this.debug()&&console.log('ForerunnerDB.Collection: Moving data-bound document array index from "'+h+'" to "'+b+'" for collection "'+this.name()+'"')):(d.splice(b,0,d.splice(h,1)[0]),this.debug()&&console.log('ForerunnerDB.Collection: Moving non-data-bound document array index from "'+h+'" to "'+b+'" for collection "'+this.name()+'"'))};f.prototype._updateSplicePush=function(d,
h,b){d.length>h?this._linked?$.observable(d).insert(h,b):d.splice(h,0,b):this._linked?$.observable(d).insert(b):d.push(b)};f.prototype._updatePush=function(d,h){this._linked?$.observable(d).insert(h):d.push(h)};f.prototype._updatePull=function(d,h){this._linked?$.observable(d).remove(h):d.splice(h,1)};f.prototype._updateIncrement=function(d,h,b){this._linked?$.observable(d).setProperty(h,d[h]+b):d[h]+=b};f.prototype.remove=function(d){var h,b,a=this._views,e;if(d instanceof Array){a=[];for(h=0;h<
d.length;h++)a.push(this.remove(d[h]));return a}h=this.find(d,{decouple:!1});if(h.length){for(e=0;e<h.length;e++)b=h[e],this._removeIndex(b),b=this._data.indexOf(b),this._linked?$.observable(this._data).remove(b):this._data.splice(b,1);if(a&&a.length)for(e=0;e<a.length;e++)a[e].remove(d);this._onRemove(h);this.deferEmit("change",{type:"remove",data:h})}return h};f.prototype.removeById=function(d){var h={};h[this._primaryKey]=d;return this.remove(h)};f.prototype.deferEmit=function(){var d=this,h;this._noEmitDefer||
this._db&&(!this._db||this._db._noEmitDefer)?this.emit.apply(this,arguments):(h=arguments,this._changeTimeout&&clearTimeout(this._changeTimeout),this._changeTimeout=setTimeout(function(){d.debug()&&console.log("ForerunnerDB.Collection: Emitting "+h[0]);d.emit.apply(d,h)},100))};f.prototype.processQueue=function(d,h){var b=this._deferQueue[d],a=this._deferThreshold[d],e=this._deferTime[d];if(b.length){var f=this;b.length&&(b=b.length>a?b.splice(0,a):b.splice(0,b.length),this[d](b));setTimeout(function(){f.processQueue(d,
h)},e)}else h&&h()};f.prototype.insert=function(d,h,b){"function"===typeof h?(b=h,h=this._data.length):void 0===h&&(h=this._data.length);d=this.transformIn(d);return this._insertHandle(d,h,b)};f.prototype._insertHandle=function(d,h,b){var a=this._deferQueue.insert,e=this._deferThreshold.insert,f=[],c=[],g=this._views;if(d instanceof Array){if(d.length>e){this._deferQueue.insert=a.concat(d);this.processQueue("insert",b);return}for(e=0;e<d.length;e++)a=this._insert(d[e],h+e),!0===a?f.push(d[e]):c.push({doc:d[e],
reason:a})}else a=this._insert(d,h),!0===a?f.push(d):c.push({doc:d,reason:a});if(g&&g.length)for(a=0;a<g.length;a++)g[a].insert(d,h);this._onInsert(f,c);b&&b();this.deferEmit("change",{type:"insert",data:f});return{inserted:f,failed:c}};f.prototype._insert=function(d,h){if(d){var b;this._ensurePrimaryKey(d);if(b=this.insertIndexViolation(d))return"Index violation in index: "+b;this._insertIndex(d);this._linked?$.observable(this._data).insert(h,d):this._data.splice(h,0,d);return!0}return"No document passed to insert"};
f.prototype._insertIndex=function(d){var h=this._indexByName,b,a=JSON.stringify(d);this._primaryIndex.uniqueSet(d[this._primaryKey],d);this._primaryCrc.uniqueSet(d[this._primaryKey],a);this._crcLookup.uniqueSet(a,d);for(b in h)h.hasOwnProperty(b)&&h[b].insert(d)};f.prototype._removeIndex=function(d){var h=this._indexByName,b,a=JSON.stringify(d);this._primaryIndex.unSet(d[this._primaryKey]);this._primaryCrc.unSet(d[this._primaryKey]);this._crcLookup.unSet(a);for(b in h)h.hasOwnProperty(b)&&h[b].remove(d)};
f.prototype.subset=function(d,h){var b=this.find(d,h);return(new f)._subsetOf(this).primaryKey(this._primaryKey).setData(b)};f.prototype.subsetOf=function(){return this.__subsetOf};f.prototype._subsetOf=function(d){this.__subsetOf=d;return this};f.prototype.distinct=function(d,h,b){h=this.find(h,b);d=new e(d);b={};var a=[],f,c;for(c=0;c<h.length;c++)(f=d.value(h[c])[0])&&!b[f]&&(b[f]=!0,a.push(f));return a};f.prototype.decouple=function(d){return JSON.parse(JSON.stringify(d))};f.prototype.findById=
function(d,h){var b={};b[this._primaryKey]=d;return this.find(b,h)[0]};f.prototype.peek=function(d,b){var a=this._data,e=a.length,c,g,l=new f;if("string"===typeof d){for(c=0;c<e;c++)g=JSON.stringify(a[c]),-1<g.indexOf(d)&&l.insert(a[c]);return l.find({},b)}return this.find(d,b)};f.prototype.explain=function(d,b){return this.find(d,b).__fdbOp._data};f.prototype.find=function(d,b){d=d||{};b=b||{};b.decouple=void 0!==b.decouple?b.decouple:!0;var a=this._metrics.create("find"),f=this,c,g=!0,l,k,m,q,p,
n,w,u,s,v=[];k=function(b){return f._match(b,d,"and")};a.start();if(d){a.time("analyseQuery");c=this._analyseQuery(d,b,a);a.time("analyseQuery");a.data("analysis",c);if(c.hasJoin&&c.queriesJoin){a.time("joinReferences");for(m=0;m<c.joinsOn.length;m++)p=c.joinsOn[m],q=new e(c.joinQueries[p]),q=q.value(d)[0],this._db.collection(c.joinsOn[m]).subset(q);a.time("joinReferences")}c.indexMatch.length&&(!b||b&&!b.skipIndex)?(a.data("index.potential",c.indexMatch),a.data("index.used",c.indexMatch[0].index),
a.time("indexLookup"),l=c.indexMatch[0].lookup,a.time("indexLookup"),c.indexMatch[0].keyData.totalKeyCount===c.indexMatch[0].keyData.matchedKeyCount&&(g=!1)):a.flag("usedIndex",!1);g&&(l&&l.length?(c=l.length,a.time("tableScan: "+c),l=l.filter(k)):(c=this._data.length,a.time("tableScan: "+c),l=this._data.filter(k)),b.sort&&(a.time("sort"),l=this.sort(b.sort,l),a.time("sort")),a.time("tableScan: "+c));b.limit&&l&&l.length>b.limit&&(l.length=b.limit,a.data("limit",b.limit));b.decouple&&(a.time("decouple"),
l=this.decouple(l),a.time("decouple"),a.data("flag.decouple",!0));if(b.join){for(k=0;k<b.join.length;k++)for(p in b.join[k])if(b.join[k].hasOwnProperty(p))for(u=p,c=this._db.collection(p),g=b.join[k][p],s=0;s<l.length;s++){w={};q=m=!1;for(n in g)if(g.hasOwnProperty(n))if("$"===n.substr(0,1))switch(n){case "$as":u=g[n];break;case "$multi":m=g[n];break;case "$require":q=g[n];break;default:n.substr(0,3)}else w[n]=(new e(g[n])).value(l[s])[0];w=c.find(w);!q||q&&w[0]?l[s][u]=!1===m?w[0]:w:v.push(l[s])}a.data("flag.join",
!0)}if(v.length){a.time("removalQueue");for(n=0;n<v.length;n++)p=l.indexOf(v[n]),-1<p&&l.splice(p,1);a.time("removalQueue")}if(b.transform){a.time("transform");for(n=0;n<l.length;n++)l.splice(n,1,b.transform(l[n]));a.time("transform");a.data("flag.transform",!0)}this._transformEnabled&&this._transformOut&&(a.time("transformOut"),l=this.transformOut(l),a.time("transformOut"));a.data("results",l.length);a.stop()}else a.stop(),l=[];l.__fdbOp=a;return l};f.prototype.transform=function(d){return void 0!==
d?("object"===typeof d?(void 0!==d.enabled&&(this._transformEnabled=d.enabled),void 0!==d.dataIn&&(this._transformIn=d.dataIn),void 0!==d.dataOut&&(this._transformOut=d.dataOut)):this._transformEnabled=!1===d?!1:!0,this):{enabled:this._transformEnabled,dataIn:this._transformIn,dataOut:this._transformOut}};f.prototype.transformIn=function(d){if(this._transformEnabled&&this._transformIn){if(d instanceof Array){var b=[],a;for(a=0;a<d.length;a++)b[a]=this._transformIn(d[a]);return b}return this._transformIn(d)}return d};
f.prototype.transformOut=function(d){if(this._transformEnabled&&this._transformOut){if(d instanceof Array){var b=[],a;for(a=0;a<d.length;a++)b[a]=this._transformOut(d[a]);return b}return this._transformOut(d)}return d};f.prototype.sort=function(d,b){b=b||[];var a=[],e,c;for(e in d)d.hasOwnProperty(e)&&(c={},c[e]=d[e],c.___fdbKey=e,a.push(c));return 2>a.length?this._sort(d,b):this._bucketSort(a,b)};f.prototype._bucketSort=function(d,b){var a=d.shift(),e,c,f=[];if(0<d.length){b=this._sort(a,b);e=this.bucket(a.___fdbKey,
b);for(c in e)e.hasOwnProperty(c)&&(a=[].concat(d),f=f.concat(this._bucketSort(a,e[c])));return f}return this._sort(a,b)};f.prototype._sort=function(d,b){var a=new e,c=a.parse(d,!0)[0];a.path(c.path);return b.sort(1===c.value?function(d,b){var h=a.value(d)[0],e=a.value(b)[0];return"string"===typeof h&&"string"===typeof e?h.localeCompare(e):h>e?1:h<e?-1:0}:function(d,b){var h=a.value(d)[0],e=a.value(b)[0];return"string"===typeof h&&"string"===typeof e?1===h.localeCompare(e)?-1:1:h>e?-1:h<e?1:0})};
f.prototype.bucket=function(d,b){var a,e={};for(a=0;a<b.length;a++)e[b[a][d]]=e[b[a][d]]||[],e[b[a][d]].push(b[a]);return e};f.prototype._analyseQuery=function(d,b,a){var c={queriesOn:[this._name],indexMatch:[],hasJoin:!1,queriesJoin:!1,joinQueries:{},query:d,options:b},f,g=[],l=[],k,m,q,p,n;a.time("checkIndexes");void 0!==d[this._primaryKey]&&(a.time("checkIndexMatch: Primary Key"),k=new e,c.indexMatch.push({lookup:this._primaryIndex.lookup(d,b),keyData:{matchedKeys:[this._primaryKey],matchedKeyCount:1,
totalKeyCount:k.countKeys(d)},index:this._primaryIndex}),a.time("checkIndexMatch: Primary Key"));for(n in this._indexById)if(this._indexById.hasOwnProperty(n)&&(m=this._indexById[n],q=m.name(),a.time("checkIndexMatch: "+q),k=m.match(d,b),p=m.lookup(d,b),0<k.matchedKeyCount&&c.indexMatch.push({lookup:p,keyData:k,index:m}),a.time("checkIndexMatch: "+q),k.totalKeyCount===k.matchedKeyCount))break;a.time("checkIndexes");1<c.indexMatch.length&&(a.time("findOptimalIndex"),c.indexMatch.sort(function(d,b){return d.keyData.totalKeyCount===
d.keyData.matchedKeyCount?-1:b.keyData.totalKeyCount===b.keyData.matchedKeyCount?1:d.keyData.matchedKeyCount===b.keyData.matchedKeyCount?d.lookup.length-b.lookup.length:b.keyData.matchedKeyCount-d.keyData.matchedKeyCount}),a.time("findOptimalIndex"));if(b.join){c.hasJoin=!0;for(a=0;a<b.join.length;a++)for(f in b.join[a])b.join[a].hasOwnProperty(f)&&(g.push(f),"$as"in b.join[a][f]?l.push(b.join[a][f].$as):l.push(f));for(f=0;f<l.length;f++)if(b=this._queryReferencesCollection(d,l[f],""))c.joinQueries[g[f]]=
b,c.queriesJoin=!0;c.joinsOn=g;c.queriesOn=c.queriesOn.concat(g)}return c};f.prototype._queryReferencesCollection=function(d,b,a){for(var e in d)if(d.hasOwnProperty(e)){if(e===b)return a&&(a+="."),a+e;if("object"===typeof d[e])return a&&(a+="."),a+=e,this._queryReferencesCollection(d[e],b,a)}return!1};f.prototype._match=function(b,a,e){var c,f;c=typeof b;f=typeof a;var g=!0,l;if(!("string"!==c&&"number"!==c||"string"!==f&&"number"!==f))b!==a&&(g=!1);else for(l in a)if(a.hasOwnProperty(l)){c=!1;if("$"===
l.substr(0,1))switch(l){case "$gt":if(b>a[l]){if("or"===e)return!0}else g=!1;c=!0;break;case "$gte":if(b>=a[l]){if("or"===e)return!0}else g=!1;c=!0;break;case "$lt":if(b<a[l]){if("or"===e)return!0}else g=!1;c=!0;break;case "$lte":if(b<=a[l]){if("or"===e)return!0}else g=!1;c=!0;break;case "$exists":if(void 0===b!==a[l]){if("or"===e)return!0}else g=!1;c=!0;break;case "$or":c=!0;for(f=0;f<a[l].length;f++){if(this._match(b,a[l][f],"and"))return!0;g=!1}break;case "$and":c=!0;for(f=0;f<a[l].length;f++)if(!this._match(b,
a[l][f],"and"))return!1;break;case "$in":if(a[l]instanceof Array){c=a[l];f=c.length;var k,m=!1;for(k=0;k<f;k++)if(c[k]===b){m=!0;break}if(m){if("or"===e)return!0}else g=!1}else throw"Cannot use a $nin operator on a non-array key: "+l;c=!0;break;case "$nin":if(a[l]instanceof Array){c=a[l];f=c.length;m=!0;for(k=0;k<f;k++)if(c[k]===b){m=!1;break}if(m){if("or"===e)return!0}else g=!1}else throw"Cannot use a $nin operator on a non-array key: "+l;c=!0;break;case "$ne":if(b!=a[l]){if("or"===e)return!0}else g=
!1;c=!0}if(!c&&a[l]instanceof RegExp)if(c=!0,"object"===typeof b&&void 0!==b[l]&&a[l].test(b[l])){if("or"===e)return!0}else g=!1;if(!c)if("object"===typeof a[l])if(void 0!==b[l]){if(b[l]instanceof Array&&!(a[l]instanceof Array))for(c=!1,f=0;f<b[l].length&&!(c=this._match(b[l][f],a[l],void 0));f++);else if(!(b[l]instanceof Array)&&a[l]instanceof Array)for(c=!1,f=0;f<a[l].length&&!(c=this._match(b[l],a[l][f],void 0));f++);else c="object"===typeof b?this._match(b[l],a[l],void 0):this._match(void 0,a[l],
void 0);if(c){if("or"===e)return!0}else g=!1}else if(a[l]&&void 0!==a[l].$exists)if(c=this._match(void 0,a[l],void 0)){if("or"===e)return!0}else g=!1;else g=!1;else if(b&&b[l]===a[l]){if("or"===e)return!0}else if(b&&b[l]&&b[l]instanceof Array&&a[l]&&"object"!==typeof a[l]){c=!1;for(f=0;f<b[l].length&&!(c=this._match(b[l][f],a[l],void 0));f++);if(c){if("or"===e)return!0}else g=!1}else g=!1;if("and"===e&&!g)return!1}return g};f.prototype.count=function(b,a){return b?this.find(b,a).length:this._data.length};
f.prototype.link=function(b,a){this._links=this._links||{};if(!this._links[a]){if($(b).length){if(!$.templates[a]){var e=$(a);if(e.length)$.views.templates(a,$(e[0]).html());else throw"Unable to bind collection to target because template does not exist: "+a;}$.templates[a].link(b,this._data);this._links[a]=b;this._linked++;this.debug()&&console.log('ForerunnerDB.Collection: Added binding collection "'+this.name()+'" to output target: '+b);return this}throw'Cannot bind view data to output target selector "'+
b+'" because it does not exist in the DOM!';}throw"Cannot create a duplicate link to the target: "+b+" with the template: "+a;};f.prototype.unlink=function(b,a){this._links=this._links||{};if(this._links[a])return $.templates[a].unlink(b),delete this._links[a],this._linked--,this.debug()&&console.log('ForerunnerDB.Collection: Removed binding collection "'+this.name()+'" to output target: '+b),this;console.log("Cannot remove link, one does not exist to the target: "+b+" with the template: "+a)};f.prototype.findSub=
function(b,a,c,f){var l=new e(a);b=this.find(b);var g=b.length,k,m,q=this._db.collection("__FDB_temp_"+this.objectId()),t={parents:g,subDocTotal:0,subDocs:[],pathFound:!1,err:""};for(k=0;k<g;k++)if(m=l.value(b[k])[0]){q.setData(m);m=q.find(c,f);if(f.returnFirst&&m.length)return m[0];t.subDocs.push(m);t.subDocTotal+=m.length;t.pathFound=!0}q.drop();if(f.noStats)return t.subDocs;t.pathFound||(t.err="No objects found in the parent documents with a matching path of: "+a);return t};f.prototype.insertIndexViolation=
function(b){var a,e=this._indexByName,c,f;if(this._primaryIndex.get(b[this._primaryKey]))a=this._primaryIndex;else for(c in e)if(e.hasOwnProperty(c)&&(f=e[c],f.unique()&&f.violation(b))){a=f;break}return a?a.name():!1};f.prototype.ensureIndex=function(a,e){this._indexByName=this._indexByName||{};this._indexById=this._indexById||{};var c=new b(a,e,this),f={start:(new Date).getTime()};if(this._indexByName[c.name()])return{err:"Index with that name already exists"};if(this._indexById[c.id()])return{err:"Index with those keys already exists"};
c.rebuild();this._indexByName[c.name()]=c;this._indexById[c.id()]=c;f.end=(new Date).getTime();f.total=f.end-f.start;this._lastOp={type:"ensureIndex",stats:{time:f}};return{index:c,id:c.id(),name:c.name(),state:c.state()}};f.prototype.index=function(b){if(this._indexByName)return this._indexByName[b]};f.prototype.lastOp=function(){return this._metrics.list()};f.prototype.objectId=function(b){var a=Math.pow(10,17);if(b){var e=0,c=b.length,f;for(f=0;f<c;f++)e+=b.charCodeAt(f)*a;b=e.toString(16)}else g.idCounter++,
b=(g.idCounter+(Math.random()*a+Math.random()*a+Math.random()*a+Math.random()*a)).toString(16);return b};f.prototype.diff=function(b){var a={insert:[],update:[],remove:[]},e=this.primaryKey(),c,f,l,g;if(e===b.primaryKey()){c=b._data;g=c.length;for(f=0;f<g;f++)l=c[f],this._primaryIndex.get(l[e])?this._primaryCrc.get(l[e])!==b._primaryCrc.get(l[e])&&a.update.push(l):a.insert.push(l);c=this._data;g=c.length;for(f=0;f<g;f++)l=c[f],b._primaryIndex.get(l[e])||a.remove.push(l)}return a};k.prototype.collection=
function(b,a){if(b)return this._collection[b]||this.debug()&&console.log("Creating collection "+b),this._collection[b]=this._collection[b]||(new f(b)).db(this),void 0!==a&&this._collection[b].primaryKey(a),this._collection[b];throw"Cannot get collection with undefined name!";};k.prototype.collectionExists=function(b){return Boolean(this._collection[b])};k.prototype.collections=function(){var b=[],a;for(a in this._collection)this._collection.hasOwnProperty(a)&&b.push({name:a,count:this._collection[a].count()});
return b};q.exports=f},{"./Crc":4,"./Index":5,"./KeyValueStore":6,"./Metrics":7,"./Overload":9,"./Path":10,"./Shared":11}],3:[function(k,q,m){var g,a;g=k("./Shared.js");var c=function(){this.init.apply(this,arguments)};c.prototype.init=function(){this._collection={};this._debug={}};g.modules.Core=c;m=k("./Overload.js");a=k("./Collection.js");k("./Metrics.js");k=k("./Crc.js");c.prototype._isServer=!1;c.prototype.isClient=function(){return!this._isServer};c.prototype.isServer=function(){return this._isServer};
c.prototype.crc=k;c.prototype.isClient=function(){return!this._isServer};c.prototype.isServer=function(){return this._isServer};c.prototype.decouple=function(a){return JSON.parse(JSON.stringify(a))};c.prototype.debug=new m([function(){return this._debug.all},function(a){return void 0!==a&&"boolean"===typeof a?(this._debug.all=a,this):this._debug.all},function(a,b){return void 0!==a?void 0!==b?(this._debug[a]=b,this):this._debug[a]:this._debug.all}]);c.prototype.arrayToCollection=function(e){return(new a).setData(e)};
c.prototype.on=function(a,b){this._listeners=this._listeners||{};this._listeners[a]=this._listeners[a]||[];this._listeners[a].push(b);return this};c.prototype.off=function(a,b){if(a in this._listeners){var c=this._listeners[a],f=c.indexOf(b);-1<f&&c.splice(f,1)}return this};c.prototype.emit=function(a,b){this._listeners=this._listeners||{};if(a in this._listeners){var c=this._listeners[a],f=c.length,d;for(d=0;d<f;d++)c[d].apply(this,Array.prototype.slice.call(arguments,1))}return this};c.prototype.objectId=
function(a){var b,c,f=Math.pow(10,17),d;if(a){b=0;c=a.length;for(d=0;d<c;d++)b+=a.charCodeAt(d)*f;a=b.toString(16)}else g.idCounter++,a=(g.idCounter+(Math.random()*f+Math.random()*f+Math.random()*f+Math.random()*f)).toString(16);return a};c.prototype.peek=function(a){var b,c,f=[],d=typeof a;for(b in this._collection)this._collection.hasOwnProperty(b)&&(c=this._collection[b],f="string"===d?f.concat(c.peek(a)):f.concat(c.find(a)));return f};c.prototype.peekCat=function(a){var b,c,f={},d,g=typeof a;
for(b in this._collection)this._collection.hasOwnProperty(b)&&(c=this._collection[b],(d="string"===g?c.peek(a):c.find(a))&&d.length&&(f[c.name()]=d));return f};q.exports=c},{"./Collection.js":2,"./Crc.js":4,"./Metrics.js":7,"./Overload.js":9,"./Shared.js":11}],4:[function(k,q,m){var g=function(){var a=[],c,e,b;for(e=0;256>e;e++){c=e;for(b=0;8>b;b++)c=c&1?3988292384^c>>>1:c>>>1;a[e]=c}return a}();q.exports=function(a){var c=-1,e;for(e=0;e<a.length;e++)c=c>>>8^g[(c^a.charCodeAt(e))&255];return(c^-1)>>>
0}},{}],5:[function(k,q,m){m=k("./Shared");var g=k("./Path");k=function(){this.init.apply(this,arguments)};k.prototype.init=function(a,c,e){this._crossRef={};this._size=0;this._id=this._itemKeyHash(a,a);this.data({});this.unique(c&&c.unique?c.unique:!1);void 0!==a&&this.keys(a);void 0!==e&&this.collection(e);this.name(c&&c.name?c.name:this._id)};m.modules.Index=k;k.prototype.id=function(){return this._id};k.prototype.state=function(){return this._state};k.prototype.size=function(){return this._size};
k.prototype.data=function(a){return void 0!==a?(this._data=a,this):this._data};k.prototype.name=function(a){return void 0!==a?(this._name=a,this):this._name};k.prototype.collection=function(a){return void 0!==a?(this._collection=a,this):this._collection};k.prototype.keys=function(a){return void 0!==a?(this._keys=a,this._keyCount=(new g).parse(this._keys).length,this):this._keys};k.prototype.type=function(a){return void 0!==a?(this._type=a,this):this._type};k.prototype.unique=function(a){return void 0!==
a?(this._unique=a,this):this._unique};k.prototype.rebuild=function(){if(this._collection){var a=this._collection.subset({},{decouple:!1,sort:this._keys}).find(),c,e=a.length;this._data={};this._unique&&(this._uniqueLookup={});for(c=0;c<e;c++)this.insert(a[c])}this._state={name:this._name,keys:this._keys,indexSize:this._size,built:new Date,updated:new Date,ok:!0}};k.prototype.insert=function(a,c){var e,b;this._unique&&(e=this._itemHash(a,this._keys),this._uniqueLookup[e]=a);e=this._itemHashArr(a,this._keys);
for(b=0;b<e.length;b++)this.pushToPathValue(e[b],a)};k.prototype.remove=function(a,c){var e,b;this._unique&&(e=this._itemHash(a,this._keys),delete this._uniqueLookup[e]);e=this._itemHashArr(a,this._keys);for(b=0;b<e.length;b++)this.pullFromPathValue(e[b],a)};k.prototype.violation=function(a){a=this._itemHash(a,this._keys);return Boolean(this._uniqueLookup[a])};k.prototype.hashViolation=function(a){return Boolean(this._uniqueLookup[a])};k.prototype.pushToPathValue=function(a,c){var e=this._data[a]=
this._data[a]||[];-1===e.indexOf(c)&&(e.push(c),this._size++,this.pushToCrossRef(c,e))};k.prototype.pullFromPathValue=function(a,c){var e=this._data[a],b;b=e.indexOf(c);-1<b&&(e.splice(b,1),this._size--,this.pullFromCrossRef(c,e));e.length||delete this._data[a]};k.prototype.pull=function(a){var c=a[this._collection.primaryKey()],e=this._crossRef[c],b,l=e.length,f;for(b=0;b<l;b++)f=e[b],this._pullFromArray(f,a);this._size--;delete this._crossRef[c]};k.prototype._pullFromArray=function(a,c){for(var e=
a.length;e--;)a[e]===c&&a.splice(e,1)};k.prototype.pushToCrossRef=function(a,c){var e=a[this._collection.primaryKey()];this._crossRef[e]=this._crossRef[e]||[];e=this._crossRef[e];-1===e.indexOf(c)&&e.push(c)};k.prototype.pullFromCrossRef=function(a,c){var e=a[this._collection.primaryKey()];delete this._crossRef[e]};k.prototype.lookup=function(a){return this._data[this._itemHash(a,this._keys)]||[]};k.prototype.match=function(a,c){return(new g).countObjectPaths(this._keys,a)};k.prototype._itemHash=
function(a,c){var e=new g,b,l="",f;b=e.parse(c);for(f=0;f<b.length;f++)l&&(l+="_"),l+=e.value(a,b[f].path).join(":");return l};k.prototype._itemKeyHash=function(a,c){var e=new g,b,l="",f;b=e.parse(c);for(f=0;f<b.length;f++)l&&(l+="_"),l+=e.keyValue(a,b[f].path);return l};k.prototype._itemHashArr=function(a,c){var e=new g,b,l=[],f,d,h,k;b=e.parse(c);for(h=0;h<b.length;h++)for(f=e.value(a,b[h].path),d=0;d<f.length;d++)if(0===h)l.push(f[d]);else for(k=0;k<l.length;k++)l[k]=l[k]+"_"+f[d];return l};q.exports=
k},{"./Path":10,"./Shared":11}],6:[function(k,q,m){k=k("./Shared");m=function(g){this.init.apply(this,arguments)};m.prototype.init=function(g){this._name=g;this._data={};this._primaryKey="_id"};k.modules.KeyValueStore=m;m.prototype.name=function(g){return void 0!==g?(this._name=g,this):this._name};m.prototype.primaryKey=function(g){return void 0!==g?(this._primaryKey=g,this):this._primaryKey};m.prototype.truncate=function(){this._data={};return this};m.prototype.set=function(g,a){this._data[g]=a?
a:!0;return this};m.prototype.get=function(g){return this._data[g]};m.prototype.lookup=function(g){g=g[this._primaryKey];var a,c,e,b;if(g instanceof Array){c=g.length;b=[];for(a=0;a<c;a++)(e=this._data[g[a]])&&b.push(e);return b}if(g instanceof RegExp){b=[];for(a in this._data)this._data.hasOwnProperty(a)&&g.test(a)&&b.push(this._data[a]);return b}if("object"===typeof g){if(g.$ne){b=[];for(a in this._data)this._data.hasOwnProperty(a)&&a!==g.$ne&&b.push(this._data[a]);return b}if(g.$in&&g.$in instanceof
Array){b=[];for(a in this._data)this._data.hasOwnProperty(a)&&-1<g.$in.indexOf(a)&&b.push(this._data[a]);return b}if(g.$nin&&g.$nin instanceof Array){b=[];for(a in this._data)this._data.hasOwnProperty(a)&&-1===g.$nin.indexOf(a)&&b.push(this._data[a]);return b}if(g.$or&&g.$or instanceof Array){b=[];for(a=0;a<g.$or.length;a++)b=b.concat(this.lookup(g.$or[a]));return b}}else return e=this._data[g],void 0!==e?[e]:[]};m.prototype.unSet=function(g){delete this._data[g];return this};m.prototype.uniqueSet=
function(g,a){return void 0===this._data[g]?(this._data[g]=a,!0):!1};q.exports=m},{"./Shared":11}],7:[function(k,q,m){m=k("./Shared");var g=k("./Operation");k=function(){this.init.apply(this,arguments)};k.prototype.init=function(){this._data=[]};m.modules.Metrics=k;k.prototype.create=function(a){a=new g(a);this._enabled&&this._data.push(a);return a};k.prototype.start=function(){this._enabled=!0;return this};k.prototype.stop=function(){this._enabled=!1;return this};k.prototype.clear=function(){this._data=
[];return this};k.prototype.list=function(){return this._data};q.exports=k},{"./Operation":8,"./Shared":11}],8:[function(k,q,m){m=k("./Shared");var g=k("./Path");k=function(a){this.pathSolver=new g;this.counter=0;this.init.apply(this,arguments)};k.prototype.init=function(a){this._data={operation:a,index:{potential:[],used:!1},steps:[],time:{startMs:0,stopMs:0,totalMs:0,process:{}},flag:{},log:[]}};m.modules.Operation=k;k.prototype.start=function(){this._data.time.startMs=(new Date).getTime()};k.prototype.log=
function(a){if(a){var c=0<this._log.length?this._data.log[this._data.log.length-1].time:0;a={event:a,time:(new Date).getTime(),delta:0};this._data.log.push(a);c&&(a.delta=a.time-c);return this}return this._data.log};k.prototype.time=function(a){if(void 0!==a){var c=this._data.time.process,c=c[a]=c[a]||{};c.startMs?(c.stopMs=(new Date).getTime(),c.totalMs=c.stopMs-c.startMs,c.stepObj.totalMs=c.totalMs,delete c.stepObj):(c.startMs=(new Date).getTime(),c.stepObj={name:a},this._data.steps.push(c.stepObj));
return this}return this._data.time};k.prototype.flag=function(a,c){if(void 0!==a&&void 0!==c)this._data.flag[a]=c;else return void 0!==a?this._data.flag[a]:this._data.flag};k.prototype.data=function(a,c,e){return void 0!==c?(this.pathSolver.set(this._data,a,c),this):this.pathSolver.get(this._data,a)};k.prototype.pushData=function(a,c,e){this.pathSolver.push(this._data,a,c)};k.prototype.stop=function(){this._data.time.stopMs=(new Date).getTime();this._data.time.totalMs=this._data.time.stopMs-this._data.time.startMs};
q.exports=k},{"./Path":10,"./Shared":11}],9:[function(k,q,m){m=function(g){if(g){var a,c=g.length;return function(){for(a=0;a<c;a++)if(g[a].length===arguments.length)return g[a].apply(this,arguments);return null}}return function(){}};k("./Shared").modules.Overload=m;q.exports=m},{"./Shared":11}],10:[function(k,q,m){k=k("./Shared");m=function(g){this.init.apply(this,arguments)};m.prototype.init=function(g){g&&this.path(g)};k.modules.Path=m;m.prototype.path=function(g){return void 0!==g?(this._path=
this.clean(g),this._pathParts=this._path.split("."),this):this._path};m.prototype.hasObjectPaths=function(g,a){var c=!0,e;for(e in g)if(g.hasOwnProperty(e)&&(void 0===a[e]||"object"===typeof g[e]&&(c=this.hasObjectPaths(g[e],a[e]),!c)))return!1;return c};m.prototype.countKeys=function(g){var a=0,c;for(c in g)g.hasOwnProperty(c)&&void 0!==g[c]&&("object"!==typeof g[c]?a++:a+=this.countKeys(g[c]));return a};m.prototype.countObjectPaths=function(g,a){var c,e={},b=0,l=0,f;for(f in a)a.hasOwnProperty(f)&&
("object"===typeof a[f]?(c=this.countObjectPaths(g[f],a[f]),e[f]=c.matchedKeys,l+=c.totalKeyCount,b+=c.matchedKeyCount):(l++,g&&g[f]&&"object"!==typeof g[f]?(e[f]=!0,b++):e[f]=!1));return{matchedKeys:e,matchedKeyCount:b,totalKeyCount:l}};m.prototype.parse=function(g,a){var c=[],e="",b,l,f;for(l in g)if(g.hasOwnProperty(l))if(e=l,"object"===typeof g[l])if(a)for(b=this.parse(g[l],a),f=0;f<b.length;f++)c.push({path:e+"."+b[f].path,value:b[f].value});else for(b=this.parse(g[l]),f=0;f<b.length;f++)c.push({path:e+
"."+b[f].path});else a?c.push({path:e,value:g[l]}):c.push({path:e});return c};m.prototype.parseArr=function(g,a){a=a||{};return this._parseArr(g,"",[],a)};m.prototype._parseArr=function(g,a,c,e){var b,l="";a=a||"";c=c||[];for(b in g)g.hasOwnProperty(b)&&(!e.ignore||e.ignore&&!e.ignore.test(b))&&(l=a?a+"."+b:b,"object"===typeof g[b]?this._parseArr(g[b],l,c,e):c.push(l));return c};m.prototype.value=function(g,a){if(void 0!==g&&"object"===typeof g){var c,e,b,l,f=[],d;void 0!==a&&(a=this.clean(a),c=a.split("."));
c=c||this._pathParts;e=c.length;b=g;for(d=0;d<e;d++){b=b[c[d]];if(l instanceof Array){for(e=0;e<l.length;e++)f=f.concat(this.value(l,e+"."+c[d]));return f}if(!b||"object"!==typeof b)break;l=b}return[b]}return[]};m.prototype.set=function(g,a,c){if(void 0!==g&&void 0!==a){var e;a=this.clean(a);a=a.split(".");e=a.shift();a.length?(g[e]=g[e]||{},this.set(g[e],a.join("."),c)):g[e]=c}return g};m.prototype.get=function(g,a){return this.value(g,a)[0]};m.prototype.push=function(g,a,c){if(void 0!==g&&void 0!==
a){var e;a=this.clean(a);a=a.split(".");e=a.shift();if(a.length)g[e]=g[e]||{},this.set(g[e],a.join("."),c);else if(g[e]=g[e]||[],g[e]instanceof Array)g[e].push(c);else throw"Cannot push to a path whose endpoint is not an array!";}return g};m.prototype.keyValue=function(g,a){var c,e,b,l,f;void 0!==a&&(a=this.clean(a),c=a.split("."));c=c||this._pathParts;e=c.length;b=g;for(f=0;f<e;f++)if(b=b[c[f]],!b||"object"!==typeof b){l=c[f]+":"+b;break}return l};m.prototype.clean=function(g){"."===g.substr(0,1)&&
(g=g.substr(1,g.length-1));return g};q.exports=m},{"./Shared":11}],11:[function(k,q,m){q.exports={idCounter:0,modules:{},prototypes:{}}},{}],12:[function(k,q,m){var g,a,c;m=k("./Shared");var e=function(b,a,c){this.init.apply(this,arguments)};e.prototype.init=function(b,a,c){this._name=b;this._collections=[];this._groups=[];this._listeners={};this._querySettings={query:a,options:c};this._debug={};this._privateData=new g("__FDB__view_privateData_"+this._name)};m.modules.View=e;g=k("./Collection");k=
k("./Overload");a=g.prototype.init;m=m.modules.Core;c=m.prototype.init;e.prototype.debug=new k([function(){return this._debug.all},function(b){return void 0!==b&&"boolean"===typeof b?(this._debug.all=b,this.privateData().debug(b),this.publicData().debug(b),this):this._debug.all},function(b,a){return void 0!==b?void 0!==a?(this._debug[b]=a,this.privateData().debug(b,a),this.publicData().debug(b,a),this):this._debug[b]:this._debug.all}]);e.prototype.name=function(a){return void 0!==a?(this._name=a,
this):this._name};e.prototype.find=function(a,c){return this.publicData().find(a,c)};e.prototype.insert=function(a,c,f){a=this._privateData.decouple(a);"function"===typeof c?(f=c,c=this._privateData.length):void 0===c&&(c=this._privateData.length);this._transformInsert(a,c);this.debug()&&console.log('ForerunnerDB.View: Inserting some data on view "'+this.name()+'" in underlying (internal) view collection "'+this._privateData.name()+'"');return this._privateData._insertHandle(a,c,f)};e.prototype.update=
function(a,c){this.debug()&&console.log('ForerunnerDB.View: Updating some data on view "'+this.name()+'" in underlying (internal) view collection "'+this._privateData.name()+'"');var f=this._privateData.update(a,c),d,e,g;if(this._transformEnabled&&this._transformIn){d=this._publicData.primaryKey();for(var k=0;k<f.length;k++)e={},g=f[k],e[d]=g[d],this._transformUpdate(e,g)}return f};e.prototype.remove=function(a){this._transformRemove(a);this.debug()&&console.log('ForerunnerDB.View: Removing some data on view "'+
this.name()+'" in underlying (internal) view collection "'+this._privateData.name()+'"');return this._privateData.remove(a)};e.prototype.link=function(a,c){var e=this.publicData();this.debug()&&console.log('ForerunnerDB.View: Setting up data binding on view "'+this.name()+'" in underlying (internal) view collection "'+e.name()+'" for output target: '+a);return e.link(a,c)};e.prototype.unlink=function(a,c){var e=this.publicData();this.debug()&&console.log('ForerunnerDB.View: Removing data binding on view "'+
this.name()+'" in underlying (internal) view collection "'+e.name()+'" for output target: '+a);return e.unlink(a,c)};e.prototype.from=function(a){void 0!==a&&("string"===typeof a&&(a=this._db.collection(a)),this._addCollection(a));return this};e.prototype._addCollection=function(a){if(-1===this._collections.indexOf(a)){this._collections.push(a);a._addView(this);var c=a.find(this._querySettings.query,this._querySettings.options);this._transformPrimaryKey(a.primaryKey());this._transformInsert(c);this._privateData.primaryKey(a.primaryKey());
this._privateData.insert(c)}return this};e.prototype._removeCollection=function(a){-1<this._collections.indexOf(a)&&(this._collections.splice(a,1),a._removeView(this),this._privateData.remove(a.find(this._querySettings.query,this._querySettings.options)));return this};e.prototype.on=function(){this._privateData.on.apply(this._privateData,arguments)};e.prototype.off=function(){this._privateData.off.apply(this._privateData,arguments)};e.prototype.emit=function(){this._privateData.emit.apply(this._privateData,
arguments)};e.prototype.drop=function(){if(this._collections&&this._collections.length){(this.debug()||this._db&&this._db.debug())&&console.log("ForerunnerDB.View: Dropping view "+this._name);this.emit("drop");for(var a=this._collections.length;a--;)this._removeCollection(this._collections[a]);this._privateData.drop();return!0}return!1};e.prototype.db=function(a){return void 0!==a?(this._db=a,this.privateData().db(a),this.publicData().db(a),this):this._db};e.prototype.primaryKey=function(){return this._privateData.primaryKey()};
e.prototype.queryData=function(a,c,e){void 0!==a&&(this._querySettings.query=a);void 0!==c&&(this._querySettings.options=c);return void 0!==a||void 0!==c?(void 0!==e&&!0!==e||this.refresh(),this):this._querySettings};e.prototype.queryAdd=function(a,c,e){var d=this._querySettings.query,g;if(void 0!==a)for(g in a)a.hasOwnProperty(g)&&(void 0===d[g]||void 0!==d[g]&&c)&&(d[g]=a[g]);void 0!==e&&!0!==e||this.refresh()};e.prototype.queryRemove=function(a,c){var e=this._querySettings.query,d;if(void 0!==
a)for(d in a)a.hasOwnProperty(d)&&delete e[d];void 0!==c&&!0!==c||this.refresh()};e.prototype.query=function(a,c){return void 0!==a?(this._querySettings.query=a,void 0!==c&&!0!==c||this.refresh(),this):this._querySettings.query};e.prototype.queryOptions=function(a,c){return void 0!==a?(this._querySettings.options=a,void 0===a.decouple&&(a.decouple=!0),void 0!==c&&!0!==c||this.refresh(),this):this._querySettings.options};e.prototype.refresh=function(a){var c;a=this.publicData();var e;this._privateData.remove();
a.remove();for(e=0;e<this._collections.length;e++)c=this._collections[e],this._privateData.insert(c.find(this._querySettings.query,this._querySettings.options));c=this._privateData.find({},this._querySettings.options);a._linked?$.observable(a._data).refresh(c):(this._privateData._data.length=0,this._privateData._data=this._privateData._data.concat(c));return this};e.prototype.count=function(){return this._privateData&&this._privateData._data?this._privateData._data.length:0};e.prototype.transform=
function(a){return void 0!==a?("object"===typeof a?(void 0!==a.enabled&&(this._transformEnabled=a.enabled),void 0!==a.dataIn&&(this._transformIn=a.dataIn),void 0!==a.dataOut&&(this._transformOut=a.dataOut)):this._transformEnabled=!1===a?!1:!0,this._transformPrimaryKey(this.privateData().primaryKey()),this._transformSetData(this.privateData().find()),this):{enabled:this._transformEnabled,dataIn:this._transformIn,dataOut:this._transformOut}};e.prototype.privateData=function(){return this._privateData};
e.prototype.publicData=function(){return this._transformEnabled?this._publicData:this._privateData};e.prototype._transformSetData=function(a){this._transformEnabled&&(this._publicData=new g("__FDB__view_publicData_"+this._name),this._publicData.db(this._privateData._db),this._publicData.transform({enabled:!0,dataIn:this._transformIn,dataOut:this._transformOut}),this._publicData.setData(a))};e.prototype._transformInsert=function(a,c){this._transformEnabled&&this._publicData&&this._publicData.insert(a,
c)};e.prototype._transformUpdate=function(a,c){this._transformEnabled&&this._publicData&&this._publicData.update(a,c)};e.prototype._transformRemove=function(a){this._transformEnabled&&this._publicData&&this._publicData.remove(a)};e.prototype._transformPrimaryKey=function(a){this._transformEnabled&&this._publicData&&this._publicData.primaryKey(a)};g.prototype.init=function(){this._views=[];a.apply(this,arguments)};g.prototype.view=function(a,c,f){a=(new e(a,c,f)).db(this._db)._addCollection(this);
this._views=this._views||[];this._views.push(a);return a};g.prototype._addView=function(a){void 0!==a&&this._views.push(a);return this};g.prototype._removeView=function(a){void 0!==a&&(a=this._views.indexOf(a),-1<a&&this._views.splice(a,1));return this};m.prototype.init=function(){this._views={};c.apply(this,arguments)};m.prototype.view=function(a){this._views[a]||(this.debug()||this._db&&this._db.debug())&&console.log("Core.View: Creating view "+a);this._views[a]=this._views[a]||(new e(a)).db(this);
return this._views[a]};m.prototype.viewExists=function(a){return Boolean(this._views[a])};m.prototype.views=function(){var a=[],c;for(c in this._views)this._views.hasOwnProperty(c)&&a.push({name:c,count:this._views[c].count()});return a};q.exports=e},{"./Collection":2,"./Overload":9,"./Shared":11}]},{},[1])(1)});
