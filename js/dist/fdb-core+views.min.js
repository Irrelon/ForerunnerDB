!function(w){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=w();else if("function"==typeof define&&define.amd)define([],w);else{var k;"undefined"!=typeof window?k=window:"undefined"!=typeof global?k=global:"undefined"!=typeof self&&(k=self);k.ForerunnerDB=w()}}(function(){return function k(p,m,d){function b(a,e){if(!m[a]){if(!p[a]){var f="function"==typeof require&&require;if(!e&&f)return f(a,!0);if(h)return h(a,!0);f=Error("Cannot find module '"+a+"'");throw f.code="MODULE_NOT_FOUND",
f;}f=m[a]={exports:{}};p[a][0].call(f.exports,function(c){var g=p[a][1][c];return b(g?g:c)},f,f.exports,k,p,m,d)}return m[a].exports}for(var h="function"==typeof require&&require,e=0;e<d.length;e++)b(d[e]);return b}({1:[function(k,p,m){m=k("../lib/Core");k("../lib/View");p.exports=m},{"../lib/Core":3,"../lib/View":12}],2:[function(k,p,m){var d,b,h,e,a,n;d=k("./Shared");var f=function(c){this.init.apply(this,arguments)};f.prototype.init=function(c){this._primaryKey="_id";this._primaryIndex=new h("primary");
this._primaryCrc=new h("primaryCrc");this._crcLookup=new h("crcLookup");this._name=c;this._data=[];this._groups=[];this._metrics=new b;this._linked=0;this._debug={};this._deferQueue={insert:[],update:[],remove:[],upsert:[]};this._deferThreshold={insert:100,update:100,remove:100,upsert:100};this._deferTime={insert:1,update:1,remove:1,upsert:1};this._subsetOf(this)};d.modules.Collection=f;m=k("./Overload");b=k("./Metrics");h=k("./KeyValueStore");e=k("./Path");a=k("./Index");n=k("./Crc");k=d.modules.Core;
f.prototype.debug=new m([function(){return this._debug.all},function(c){if(void 0!==c){if("boolean"===typeof c){this._debug.all=c;for(var g=0;g<this._views.length;g++)this._views[g].debug(c);return this}return this._debug[c]||this._db&&this._db._debug&&this._db._debug[c]||this._debug.all}return this._debug.all},function(c,g){if(void 0!==c){if(void 0!==g){this._debug[c]=g;for(var r=0;r<this._views.length;r++)this._views[r].debug(c,g);return this}return this._debug[c]||this._db&&this._db._debug&&this._db._debug[c]}return this._debug.all}]);
f.prototype.crc=n;f.prototype.name=function(c){return void 0!==c?(this._name=c,this):this._name};f.prototype.on=new m([function(c,g){this._listeners=this._listeners||{};this._listeners[c]=this._listeners[c]||{};this._listeners[c]["*"]=this._listeners[c]["*"]||[];this._listeners[c]["*"].push(g);return this},function(c,g,r){this._listeners=this._listeners||{};this._listeners[c]=this._listeners[c]||{};this._listeners[c][g]=this._listeners[c][g]||[];this._listeners[c][g].push(r);return this}]);f.prototype.off=
new m([function(c){this._listeners&&this._listeners[c]&&c in this._listeners&&delete this._listeners[c];return this},function(c,g){var r,a;"string"===typeof g?this._listeners&&this._listeners[c]&&this._listeners[c][g]&&delete this._listeners[c][g]:c in this._listeners&&(r=this._listeners[c]["*"],a=r.indexOf(g),-1<a&&r.splice(a,1));return this},function(c,g,r){this._listeners&&c in this._listeners&&(c=this._listeners[c][g],r=c.indexOf(r),-1<r&&c.splice(r,1))}]);f.prototype.emit=function(c,g){this._listeners=
this._listeners||{};if(c in this._listeners){if(this._listeners[c]["*"]){var r=this._listeners[c]["*"],a=r.length,b;for(b=0;b<a;b++)r[b].apply(this,Array.prototype.slice.call(arguments,1))}if(g instanceof Array&&g[0]&&g[0][this._primaryKey]){var r=this._listeners[c],e,f,a=g.length;for(b=0;b<a;b++)if(r[g[b][this._primaryKey]])for(e=r[g[b][this._primaryKey]].length,f=0;f<e;f++)r[g[b][this._primaryKey]][f].apply(this,Array.prototype.slice.call(arguments,1))}}return this};f.prototype.drop=function(){if(this._db&&
this._name){this.debug()&&console.log("Dropping collection "+this._name);this.emit("drop");delete this._db._collection[this._name];var c=[],g;for(g=0;g<this._groups.length;g++)c.push(this._groups[g]);for(g=0;g<c.length;g++)this._groups[g].removeCollection(this);return!0}return!1};f.prototype.primaryKey=function(c){return void 0!==c?(this._primaryKey=c,this._primaryIndex.primaryKey(c),this._rebuildPrimaryKeyIndex(),this):this._primaryKey};f.prototype._onInsert=function(c,g){this.emit("insert",c,g)};
f.prototype._onUpdate=function(c){this.emit("update",c)};f.prototype._onRemove=function(c){this.emit("remove",c)};f.prototype.db=function(c){return void 0!==c?(this._db=c,this):this._db};f.prototype.setData=function(c,g,r){if(c){var a=this._metrics.create("setData");a.start();g=g||{};g.decouple=void 0!==g.decouple?g.decouple:!0;g.decouple&&(c=this.decouple(c));c instanceof Array||(c=[c]);a.time("transformIn");c=this.transformIn(c);a.time("transformIn");var b=this._data;this._data=[];c.length&&(this._data=
this._data.concat(c));a.time("_rebuildPrimaryKeyIndex");this._rebuildPrimaryKeyIndex(g);a.time("_rebuildPrimaryKeyIndex");a.stop();this.emit("setData",this._data,b)}r&&r(!1);return this};f.prototype._rebuildPrimaryKeyIndex=function(c){var g=c&&void 0!==c.ensureKeys?c.ensureKeys:!0;c=c&&void 0!==c.violationCheck?c.violationCheck:!0;var r,a,b,e=this._primaryIndex,f=this._primaryCrc,h=this._crcLookup,d=this._primaryKey,n;e.truncate();f.truncate();h.truncate();r=this._data;for(a=r.length;a--;)if(b=r[a],
g&&this._ensurePrimaryKey(b),c){if(!e.uniqueSet(b[d],b))throw"Call to setData failed because your data violates the primary key unique constraint. One or more documents are using the same primary key: "+b[this._primaryKey];}else n=JSON.stringify(b),e.set(b[d],b),f.set(b[d],n),h.set(n,b)};f.prototype._ensurePrimaryKey=function(c){void 0===c[this._primaryKey]&&(c[this._primaryKey]=this.objectId())};f.prototype.truncate=function(){this.emit("truncate",this._data);this._data.length=0;this.deferEmit("change");
return this};f.prototype.upsert=function(c,g){if(c){var a=this._deferQueue.upsert,b=this._deferThreshold.upsert,e={},f;if(c instanceof Array){if(c.length>b){this._deferQueue.upsert=a.concat(c);this.processQueue("upsert",g);return}e=[];for(a=0;a<c.length;a++)e.push(this.upsert(c[a]));g&&g();return e}c[this._primaryKey]?(f={},f[this._primaryKey]=c[this._primaryKey],this.count(f)?e.op="update":e.op="insert"):e.op="insert";switch(e.op){case "insert":e.result=this.insert(c);break;case "update":e.result=
this.update(f,c)}return e}g&&g()};f.prototype.update=function(c,g,a){g=this.decouple(g);g=this.transformIn(g);this.debug()&&console.log('Updating some collection data for collection "'+this.name()+'"');var b=this,e=this._metrics.create("update"),f=this._primaryKey,h,d,n=function(e){if(g&&void 0!==g[f]&&g[f]!=e[f]){b._primaryIndex.unSet(e[f]);var h=b._updateObject(e,g,c,a,"");if(b._primaryIndex.uniqueSet(e[f],e))return h;throw"Primary key violation in update! Key violated: "+e[f];}return b._updateObject(e,
g,c,a,"")},k=this._views;e.start();e.time("Retrieve documents to update");h=this.find(c,{decouple:!1});e.time("Retrieve documents to update");if(h.length&&(e.time("Update documents"),d=h.filter(n),e.time("Update documents"),d.length)){if(k&&k.length){this.debug("views")&&console.log("Updating views from collection: "+this.name());e.time("Inform views of update");for(h=0;h<k.length;h++)k[h].update(c,g);e.time("Inform views of update")}this._onUpdate(d);this.deferEmit("change",{type:"update",data:d})}e.stop();
return d||[]};f.prototype.updateById=function(c,g){var a={};a[this._primaryKey]=c;return this.update(a,g)};f.prototype._updateObject=function(c,g,a,b,f,h){g=this.decouple(g);f=f||"";"."===f.substr(0,1)&&(f=f.substr(1,f.length-1));var d=!1,n=!1,k,m,q,l;for(l in g)if(g.hasOwnProperty(l)){k=!1;if("$"===l.substr(0,1))switch(l){case "$index":break;default:k=!0,(n=this._updateObject(c,g[l],a,b,f,l))&&(d=!0)}if(this._isPositionalKey(l)&&(k=!0,l=l.substr(0,l.length-2),n=new e(f+"."+l),c[l]&&c[l]instanceof
Array&&c[l].length)){m=[];for(q=0;q<c[l].length;q++)this._match(c[l][q],n.value(a)[0])&&m.push(q);for(q=0;q<m.length;q++)(n=this._updateObject(c[l][m[q]],g[l+".$"],a,b,f+"."+l,h))&&(d=!0)}if(!k)if(h||"object"!==typeof g[l])switch(h){case "$inc":this._updateIncrement(c,l,g[l]);d=!0;break;case "$push":void 0===c[l]&&(c[l]=[]);if(c[l]instanceof Array){if(void 0!==g[l].$position&&g[l].$each instanceof Array)for(n=g[l].$position,k=g[l].$each.length,q=0;q<k;q++)this._updateSplicePush(c[l],n+q,g[l].$each[q]);
else if(g[l].$each instanceof Array)for(k=g[l].$each.length,q=0;q<k;q++)this._updatePush(c[l],g[l].$each[q]);else this._updatePush(c[l],g[l]);d=!0}else throw"Cannot push to a key that is not an array! ("+l+")";break;case "$pull":if(c[l]instanceof Array){m=[];for(q=0;q<c[l].length;q++)this._match(c[l][q],g[l])&&m.push(q);for(k=m.length;k--;)this._updatePull(c[l],m[k]),d=!0}break;case "$pullAll":if(c[l]instanceof Array)if(g[l]instanceof Array){if(m=c[l],k=m.length,0<k)for(;k--;){for(n=0;n<g[l].length;n++)m[k]===
g[l][n]&&(this._updatePull(c[l],k),k--,d=!0);if(0>k)break}}else throw"Cannot pullAll without being given an array of values to pull! ("+l+")";break;case "$addToSet":void 0===c[l]&&(c[l]=[]);if(c[l]instanceof Array){q=c[l];var p;m=q.length;var u;k=!0;p=b&&b.$addToSet;var s;p&&p.key?(n=!1,s=new e(p.key),u=s.value(g[l])[0]):(u=JSON.stringify(g[l]),n=!0);for(p=0;p<m;p++)if(n){if(JSON.stringify(q[p])===u){k=!1;break}}else if(u===s.value(q[p])[0]){k=!1;break}k&&(this._updatePush(c[l],g[l]),d=!0)}else throw"Cannot addToSet on a key that is not an array! (undefined)!";
break;case "$splicePush":void 0===c[l]&&(c[l]=[]);if(c[l]instanceof Array)if(n=g.$index,void 0!==n)delete g.$index,this._updateSplicePush(c[l],n,g[l]),d=!0;else throw"Cannot splicePush without a $index integer value!";else throw"Cannot splicePush with a key that is not an array! ("+l+")";break;case "$move":if(c[l]instanceof Array)for(q=0;q<c[l].length;q++){if(this._match(c[l][q],g[l])){d=g[l].$index;if(void 0!==d)this._updateSpliceMove(c[l],q,d),d=!0;else throw"Cannot move without a $index integer value!";
break}}else throw"Cannot move on a key that is not an array! ("+l+")";break;case "$mul":this._updateMultiply(c,l,g[l]);d=!0;break;case "$rename":this._updateRename(c,l,g[l]);d=!0;break;case "$unset":this._updateUnset(c,l);d=!0;break;case "$pop":if(c[l]instanceof Array)this._updatePop(c[l],g[l])&&(d=!0);else throw"Cannot pop from a key that is not an array! ("+l+")";break;default:c[l]!==g[l]&&(this._updateProperty(c,l,g[l]),d=!0)}else if(null!==c[l]&&"object"===typeof c[l])if(q=c[l]instanceof Array,
m=g[l]instanceof Array,q||m)if(!m&&q)for(q=0;q<c[l].length;q++)(n=this._updateObject(c[l][q],g[l],a,b,f+"."+l,h))&&(d=!0);else c[l]!==g[l]&&(this._updateProperty(c,l,g[l]),d=!0);else(n=this._updateObject(c[l],g[l],a,b,f+"."+l,h))&&(d=!0);else c[l]!==g[l]&&(this._updateProperty(c,l,g[l]),d=!0)}return d};f.prototype._isPositionalKey=function(c){return".$"===c.substr(c.length-2,2)};f.prototype._updateProperty=function(c,g,a){this._linked?($.observable(c).setProperty(g,a),this.debug()&&console.log('ForerunnerDB.Collection: Setting data-bound document property "'+
g+'" for collection "'+this.name()+'"')):(c[g]=a,this.debug()&&console.log('ForerunnerDB.Collection: Setting non-data-bound document property "'+g+'" for collection "'+this.name()+'"'))};f.prototype._updateIncrement=function(c,g,a){this._linked?$.observable(c).setProperty(g,c[g]+a):c[g]+=a};f.prototype._updateSpliceMove=function(c,g,a){this._linked?($.observable(c).move(g,a),this.debug()&&console.log('ForerunnerDB.Collection: Moving data-bound document array index from "'+g+'" to "'+a+'" for collection "'+
this.name()+'"')):(c.splice(a,0,c.splice(g,1)[0]),this.debug()&&console.log('ForerunnerDB.Collection: Moving non-data-bound document array index from "'+g+'" to "'+a+'" for collection "'+this.name()+'"'))};f.prototype._updateSplicePush=function(c,g,a){c.length>g?this._linked?$.observable(c).insert(g,a):c.splice(g,0,a):this._linked?$.observable(c).insert(a):c.push(a)};f.prototype._updatePush=function(c,g){this._linked?$.observable(c).insert(g):c.push(g)};f.prototype._updatePull=function(c,g){this._linked?
$.observable(c).remove(g):c.splice(g,1)};f.prototype._updateMultiply=function(c,g,a){this._linked?$.observable(c).setProperty(g,c[g]*a):c[g]*=a};f.prototype._updateRename=function(c,g,a){var b=c[g];this._linked?($.observable(c).setProperty(a,b),$.observable(c).removeProperty(g)):(c[a]=b,delete c[g])};f.prototype._updateUnset=function(c,g){this._linked?$.observable(c).removeProperty(g):delete c[g]};f.prototype._updatePop=function(c,g){var a,b=!1;0<c.length&&(this._linked?(1===g?a=c.length-1:-1===g&&
(a=0),-1<a&&($.observable(arr).remove(a),b=!0)):1===g?(c.pop(),b=!0):-1===g&&(c.shift(),b=!0));return b};f.prototype.remove=function(c){var g,a,b=this._views,e;if(c instanceof Array){b=[];for(g=0;g<c.length;g++)b.push(this.remove(c[g]));return b}g=this.find(c,{decouple:!1});if(g.length){for(e=0;e<g.length;e++)a=g[e],this._removeIndex(a),a=this._data.indexOf(a),this._linked?$.observable(this._data).remove(a):this._data.splice(a,1);if(b&&b.length)for(e=0;e<b.length;e++)b[e].remove(c);this._onRemove(g);
this.deferEmit("change",{type:"remove",data:g})}return g};f.prototype.removeById=function(c){var g={};g[this._primaryKey]=c;return this.remove(g)};f.prototype.deferEmit=function(){var c=this,g;this._noEmitDefer||this._db&&(!this._db||this._db._noEmitDefer)?this.emit.apply(this,arguments):(g=arguments,this._changeTimeout&&clearTimeout(this._changeTimeout),this._changeTimeout=setTimeout(function(){c.debug()&&console.log("ForerunnerDB.Collection: Emitting "+g[0]);c.emit.apply(c,g)},100))};f.prototype.processQueue=
function(c,g){var a=this._deferQueue[c],b=this._deferThreshold[c],e=this._deferTime[c];if(a.length){var f=this;a.length&&(a=a.length>b?a.splice(0,b):a.splice(0,a.length),this[c](a));setTimeout(function(){f.processQueue(c,g)},e)}else g&&g()};f.prototype.insert=function(c,g,a){"function"===typeof g?(a=g,g=this._data.length):void 0===g&&(g=this._data.length);c=this.transformIn(c);return this._insertHandle(c,g,a)};f.prototype._insertHandle=function(c,g,a){var b=this._deferQueue.insert,e=this._deferThreshold.insert,
f=[],d=[],h=this._views;if(c instanceof Array){if(c.length>e){this._deferQueue.insert=b.concat(c);this.processQueue("insert",a);return}for(e=0;e<c.length;e++)b=this._insert(c[e],g+e),!0===b?f.push(c[e]):d.push({doc:c[e],reason:b})}else b=this._insert(c,g),!0===b?f.push(c):d.push({doc:c,reason:b});if(h&&h.length)for(b=0;b<h.length;b++)h[b].insert(c,g);this._onInsert(f,d);a&&a();this.deferEmit("change",{type:"insert",data:f});return{inserted:f,failed:d}};f.prototype._insert=function(c,g){if(c){var a;
this._ensurePrimaryKey(c);if(a=this.insertIndexViolation(c))return"Index violation in index: "+a;this._insertIndex(c);this._linked?$.observable(this._data).insert(g,c):this._data.splice(g,0,c);return!0}return"No document passed to insert"};f.prototype._insertIndex=function(c){var g=this._indexByName,a,b=JSON.stringify(c);this._primaryIndex.uniqueSet(c[this._primaryKey],c);this._primaryCrc.uniqueSet(c[this._primaryKey],b);this._crcLookup.uniqueSet(b,c);for(a in g)g.hasOwnProperty(a)&&g[a].insert(c)};
f.prototype._removeIndex=function(c){var g=this._indexByName,a,b=JSON.stringify(c);this._primaryIndex.unSet(c[this._primaryKey]);this._primaryCrc.unSet(c[this._primaryKey]);this._crcLookup.unSet(b);for(a in g)g.hasOwnProperty(a)&&g[a].remove(c)};f.prototype.subset=function(c,g){var a=this.find(c,g);return(new f)._subsetOf(this).primaryKey(this._primaryKey).setData(a)};f.prototype.subsetOf=function(){return this.__subsetOf};f.prototype._subsetOf=function(c){this.__subsetOf=c;return this};f.prototype.distinct=
function(c,g,a){g=this.find(g,a);c=new e(c);a={};var b=[],f,d;for(d=0;d<g.length;d++)(f=c.value(g[d])[0])&&!a[f]&&(a[f]=!0,b.push(f));return b};f.prototype.decouple=function(c){return JSON.parse(JSON.stringify(c))};f.prototype.findById=function(c,g){var a={};a[this._primaryKey]=c;return this.find(a,g)[0]};f.prototype.peek=function(c,g){var a=this._data,b=a.length,e,d,h=new f;if("string"===typeof c){for(e=0;e<b;e++)d=JSON.stringify(a[e]),-1<d.indexOf(c)&&h.insert(a[e]);return h.find({},g)}return this.find(c,
g)};f.prototype.explain=function(c,g){return this.find(c,g).__fdbOp._data};f.prototype.find=function(c,g){c=c||{};g=g||{};g.decouple=void 0!==g.decouple?g.decouple:!0;var a=this._metrics.create("find"),b=this,f,d=!0,h,n,k,m,q,l,p,u,s,v=[];n=function(a){return b._match(a,c,"and")};a.start();if(c){a.time("analyseQuery");f=this._analyseQuery(c,g,a);a.time("analyseQuery");a.data("analysis",f);if(f.hasJoin&&f.queriesJoin){a.time("joinReferences");for(k=0;k<f.joinsOn.length;k++)q=f.joinsOn[k],m=new e(f.joinQueries[q]),
m=m.value(c)[0],this._db.collection(f.joinsOn[k]).subset(m);a.time("joinReferences")}f.indexMatch.length&&(!g||g&&!g.skipIndex)?(a.data("index.potential",f.indexMatch),a.data("index.used",f.indexMatch[0].index),a.time("indexLookup"),h=f.indexMatch[0].lookup,a.time("indexLookup"),f.indexMatch[0].keyData.totalKeyCount===f.indexMatch[0].keyData.matchedKeyCount&&(d=!1)):a.flag("usedIndex",!1);d&&(h&&h.length?(f=h.length,a.time("tableScan: "+f),h=h.filter(n)):(f=this._data.length,a.time("tableScan: "+
f),h=this._data.filter(n)),g.sort&&(a.time("sort"),h=this.sort(g.sort,h),a.time("sort")),a.time("tableScan: "+f));g.limit&&h&&h.length>g.limit&&(h.length=g.limit,a.data("limit",g.limit));g.decouple&&(a.time("decouple"),h=this.decouple(h),a.time("decouple"),a.data("flag.decouple",!0));if(g.join){for(n=0;n<g.join.length;n++)for(q in g.join[n])if(g.join[n].hasOwnProperty(q))for(u=q,f=this._db.collection(q),d=g.join[n][q],s=0;s<h.length;s++){p={};m=k=!1;for(l in d)if(d.hasOwnProperty(l))if("$"===l.substr(0,
1))switch(l){case "$as":u=d[l];break;case "$multi":k=d[l];break;case "$require":m=d[l];break;default:l.substr(0,3)}else p[l]=(new e(d[l])).value(h[s])[0];p=f.find(p);!m||m&&p[0]?h[s][u]=!1===k?p[0]:p:v.push(h[s])}a.data("flag.join",!0)}if(v.length){a.time("removalQueue");for(l=0;l<v.length;l++)q=h.indexOf(v[l]),-1<q&&h.splice(q,1);a.time("removalQueue")}if(g.transform){a.time("transform");for(l=0;l<h.length;l++)h.splice(l,1,g.transform(h[l]));a.time("transform");a.data("flag.transform",!0)}this._transformEnabled&&
this._transformOut&&(a.time("transformOut"),h=this.transformOut(h),a.time("transformOut"));a.data("results",h.length);a.stop()}else a.stop(),h=[];h.__fdbOp=a;return h};f.prototype.transform=function(c){return void 0!==c?("object"===typeof c?(void 0!==c.enabled&&(this._transformEnabled=c.enabled),void 0!==c.dataIn&&(this._transformIn=c.dataIn),void 0!==c.dataOut&&(this._transformOut=c.dataOut)):this._transformEnabled=!1===c?!1:!0,this):{enabled:this._transformEnabled,dataIn:this._transformIn,dataOut:this._transformOut}};
f.prototype.transformIn=function(c){if(this._transformEnabled&&this._transformIn){if(c instanceof Array){var a=[],b;for(b=0;b<c.length;b++)a[b]=this._transformIn(c[b]);return a}return this._transformIn(c)}return c};f.prototype.transformOut=function(c){if(this._transformEnabled&&this._transformOut){if(c instanceof Array){var a=[],b;for(b=0;b<c.length;b++)a[b]=this._transformOut(c[b]);return a}return this._transformOut(c)}return c};f.prototype.sort=function(c,a){a=a||[];var b=[],e,f;for(e in c)c.hasOwnProperty(e)&&
(f={},f[e]=c[e],f.___fdbKey=e,b.push(f));return 2>b.length?this._sort(c,a):this._bucketSort(b,a)};f.prototype._bucketSort=function(c,a){var b=c.shift(),e,f,h=[];if(0<c.length){a=this._sort(b,a);e=this.bucket(b.___fdbKey,a);for(f in e)e.hasOwnProperty(f)&&(b=[].concat(c),h=h.concat(this._bucketSort(b,e[f])));return h}return this._sort(b,a)};f.prototype._sort=function(c,a){var b=new e,f=b.parse(c,!0)[0];b.path(f.path);return a.sort(1===f.value?function(c,a){var g=b.value(c)[0],e=b.value(a)[0];return"string"===
typeof g&&"string"===typeof e?g.localeCompare(e):g>e?1:g<e?-1:0}:function(c,a){var g=b.value(c)[0],e=b.value(a)[0];return"string"===typeof g&&"string"===typeof e?1===g.localeCompare(e)?-1:1:g>e?-1:g<e?1:0})};f.prototype.bucket=function(c,a){var b,e={};for(b=0;b<a.length;b++)e[a[b][c]]=e[a[b][c]]||[],e[a[b][c]].push(a[b]);return e};f.prototype._analyseQuery=function(c,a,b){var f={queriesOn:[this._name],indexMatch:[],hasJoin:!1,queriesJoin:!1,joinQueries:{},query:c,options:a},h,d=[],n=[],k,m,p,q,l;
b.time("checkIndexes");void 0!==c[this._primaryKey]&&(b.time("checkIndexMatch: Primary Key"),k=new e,f.indexMatch.push({lookup:this._primaryIndex.lookup(c,a),keyData:{matchedKeys:[this._primaryKey],matchedKeyCount:1,totalKeyCount:k.countKeys(c)},index:this._primaryIndex}),b.time("checkIndexMatch: Primary Key"));for(l in this._indexById)if(this._indexById.hasOwnProperty(l)&&(m=this._indexById[l],p=m.name(),b.time("checkIndexMatch: "+p),k=m.match(c,a),q=m.lookup(c,a),0<k.matchedKeyCount&&f.indexMatch.push({lookup:q,
keyData:k,index:m}),b.time("checkIndexMatch: "+p),k.totalKeyCount===k.matchedKeyCount))break;b.time("checkIndexes");1<f.indexMatch.length&&(b.time("findOptimalIndex"),f.indexMatch.sort(function(c,a){return c.keyData.totalKeyCount===c.keyData.matchedKeyCount?-1:a.keyData.totalKeyCount===a.keyData.matchedKeyCount?1:c.keyData.matchedKeyCount===a.keyData.matchedKeyCount?c.lookup.length-a.lookup.length:a.keyData.matchedKeyCount-c.keyData.matchedKeyCount}),b.time("findOptimalIndex"));if(a.join){f.hasJoin=
!0;for(b=0;b<a.join.length;b++)for(h in a.join[b])a.join[b].hasOwnProperty(h)&&(d.push(h),"$as"in a.join[b][h]?n.push(a.join[b][h].$as):n.push(h));for(h=0;h<n.length;h++)if(a=this._queryReferencesCollection(c,n[h],""))f.joinQueries[d[h]]=a,f.queriesJoin=!0;f.joinsOn=d;f.queriesOn=f.queriesOn.concat(d)}return f};f.prototype._queryReferencesCollection=function(c,a,b){for(var e in c)if(c.hasOwnProperty(e)){if(e===a)return b&&(b+="."),b+e;if("object"===typeof c[e])return b&&(b+="."),b+=e,this._queryReferencesCollection(c[e],
a,b)}return!1};f.prototype._match=function(c,a,b){var e,f;e=typeof c;f=typeof a;var h=!0,d;if(!("string"!==e&&"number"!==e||"string"!==f&&"number"!==f))c!==a&&(h=!1);else for(d in a)if(a.hasOwnProperty(d)){e=!1;if("$"===d.substr(0,1))switch(d){case "$gt":if(c>a[d]){if("or"===b)return!0}else h=!1;e=!0;break;case "$gte":if(c>=a[d]){if("or"===b)return!0}else h=!1;e=!0;break;case "$lt":if(c<a[d]){if("or"===b)return!0}else h=!1;e=!0;break;case "$lte":if(c<=a[d]){if("or"===b)return!0}else h=!1;e=!0;break;
case "$exists":if(void 0===c!==a[d]){if("or"===b)return!0}else h=!1;e=!0;break;case "$or":e=!0;for(f=0;f<a[d].length;f++){if(this._match(c,a[d][f],"and"))return!0;h=!1}break;case "$and":e=!0;for(f=0;f<a[d].length;f++)if(!this._match(c,a[d][f],"and"))return!1;break;case "$in":if(a[d]instanceof Array){e=a[d];f=e.length;var n,k=!1;for(n=0;n<f;n++)if(e[n]===c){k=!0;break}if(k){if("or"===b)return!0}else h=!1}else throw"Cannot use a $nin operator on a non-array key: "+d;e=!0;break;case "$nin":if(a[d]instanceof
Array){e=a[d];f=e.length;k=!0;for(n=0;n<f;n++)if(e[n]===c){k=!1;break}if(k){if("or"===b)return!0}else h=!1}else throw"Cannot use a $nin operator on a non-array key: "+d;e=!0;break;case "$ne":if(c!=a[d]){if("or"===b)return!0}else h=!1;e=!0}if(!e&&a[d]instanceof RegExp)if(e=!0,"object"===typeof c&&void 0!==c[d]&&a[d].test(c[d])){if("or"===b)return!0}else h=!1;if(!e)if("object"===typeof a[d])if(void 0!==c[d]){if(c[d]instanceof Array&&!(a[d]instanceof Array))for(e=!1,f=0;f<c[d].length&&!(e=this._match(c[d][f],
a[d],void 0));f++);else if(!(c[d]instanceof Array)&&a[d]instanceof Array)for(e=!1,f=0;f<a[d].length&&!(e=this._match(c[d],a[d][f],void 0));f++);else e="object"===typeof c?this._match(c[d],a[d],void 0):this._match(void 0,a[d],void 0);if(e){if("or"===b)return!0}else h=!1}else if(a[d]&&void 0!==a[d].$exists)if(e=this._match(void 0,a[d],void 0)){if("or"===b)return!0}else h=!1;else h=!1;else if(c&&c[d]===a[d]){if("or"===b)return!0}else if(c&&c[d]&&c[d]instanceof Array&&a[d]&&"object"!==typeof a[d]){e=
!1;for(f=0;f<c[d].length&&!(e=this._match(c[d][f],a[d],void 0));f++);if(e){if("or"===b)return!0}else h=!1}else h=!1;if("and"===b&&!h)return!1}return h};f.prototype.count=function(a,b){return a?this.find(a,b).length:this._data.length};f.prototype.link=function(a,b){this._links=this._links||{};if(!this._links[b]){if($(a).length){if(!$.templates[b]){var e=$(b);if(e.length)$.views.templates(b,$(e[0]).html());else throw"Unable to bind collection to target because template does not exist: "+b;}$.templates[b].link(a,
this._data);this._links[b]=a;this._linked++;this.debug()&&console.log('ForerunnerDB.Collection: Added binding collection "'+this.name()+'" to output target: '+a);return this}throw'Cannot bind view data to output target selector "'+a+'" because it does not exist in the DOM!';}throw"Cannot create a duplicate link to the target: "+a+" with the template: "+b;};f.prototype.unlink=function(a,b){this._links=this._links||{};if(this._links[b])return $.templates[b].unlink(a),delete this._links[b],this._linked--,
this.debug()&&console.log('ForerunnerDB.Collection: Removed binding collection "'+this.name()+'" to output target: '+a),this;console.log("Cannot remove link, one does not exist to the target: "+a+" with the template: "+b)};f.prototype.findSub=function(a,b,f,d){var h=new e(b);a=this.find(a);var n=a.length,k,m,p=this._db.collection("__FDB_temp_"+this.objectId()),t={parents:n,subDocTotal:0,subDocs:[],pathFound:!1,err:""};for(k=0;k<n;k++)if(m=h.value(a[k])[0]){p.setData(m);m=p.find(f,d);if(d.returnFirst&&
m.length)return m[0];t.subDocs.push(m);t.subDocTotal+=m.length;t.pathFound=!0}p.drop();if(d.noStats)return t.subDocs;t.pathFound||(t.err="No objects found in the parent documents with a matching path of: "+b);return t};f.prototype.insertIndexViolation=function(a){var b,e=this._indexByName,f,d;if(this._primaryIndex.get(a[this._primaryKey]))b=this._primaryIndex;else for(f in e)if(e.hasOwnProperty(f)&&(d=e[f],d.unique()&&d.violation(a))){b=d;break}return b?b.name():!1};f.prototype.ensureIndex=function(c,
b){this._indexByName=this._indexByName||{};this._indexById=this._indexById||{};var e=new a(c,b,this),f={start:(new Date).getTime()};if(this._indexByName[e.name()])return{err:"Index with that name already exists"};if(this._indexById[e.id()])return{err:"Index with those keys already exists"};e.rebuild();this._indexByName[e.name()]=e;this._indexById[e.id()]=e;f.end=(new Date).getTime();f.total=f.end-f.start;this._lastOp={type:"ensureIndex",stats:{time:f}};return{index:e,id:e.id(),name:e.name(),state:e.state()}};
f.prototype.index=function(a){if(this._indexByName)return this._indexByName[a]};f.prototype.lastOp=function(){return this._metrics.list()};f.prototype.objectId=function(a){var b=Math.pow(10,17);if(a){var e=0,f=a.length,h;for(h=0;h<f;h++)e+=a.charCodeAt(h)*b;a=e.toString(16)}else d.idCounter++,a=(d.idCounter+(Math.random()*b+Math.random()*b+Math.random()*b+Math.random()*b)).toString(16);return a};f.prototype.diff=function(a){var b={insert:[],update:[],remove:[]},e=this.primaryKey(),f,d,h,n;if(e===
a.primaryKey()){f=a._data;n=f.length;for(d=0;d<n;d++)h=f[d],this._primaryIndex.get(h[e])?this._primaryCrc.get(h[e])!==a._primaryCrc.get(h[e])&&b.update.push(h):b.insert.push(h);f=this._data;n=f.length;for(d=0;d<n;d++)h=f[d],a._primaryIndex.get(h[e])||b.remove.push(h)}return b};k.prototype.collection=function(a,b){if(a)return this._collection[a]||this.debug()&&console.log("Creating collection "+a),this._collection[a]=this._collection[a]||(new f(a)).db(this),void 0!==b&&this._collection[a].primaryKey(b),
this._collection[a];throw"Cannot get collection with undefined name!";};k.prototype.collectionExists=function(a){return Boolean(this._collection[a])};k.prototype.collections=function(){var a=[],b;for(b in this._collection)this._collection.hasOwnProperty(b)&&a.push({name:b,count:this._collection[b].count()});return a};p.exports=f},{"./Crc":4,"./Index":5,"./KeyValueStore":6,"./Metrics":7,"./Overload":9,"./Path":10,"./Shared":11}],3:[function(k,p,m){var d,b;d=k("./Shared.js");var h=function(){this.init.apply(this,
arguments)};h.prototype.init=function(){this._collection={};this._debug={}};d.modules.Core=h;m=k("./Overload.js");b=k("./Collection.js");k("./Metrics.js");k=k("./Crc.js");h.prototype._isServer=!1;h.prototype.isClient=function(){return!this._isServer};h.prototype.isServer=function(){return this._isServer};h.prototype.crc=k;h.prototype.isClient=function(){return!this._isServer};h.prototype.isServer=function(){return this._isServer};h.prototype.decouple=function(b){return JSON.parse(JSON.stringify(b))};
h.prototype.debug=new m([function(){return this._debug.all},function(b){return void 0!==b&&"boolean"===typeof b?(this._debug.all=b,this):this._debug.all},function(b,a){return void 0!==b?void 0!==a?(this._debug[b]=a,this):this._debug[b]:this._debug.all}]);h.prototype.arrayToCollection=function(e){return(new b).setData(e)};h.prototype.on=function(b,a){this._listeners=this._listeners||{};this._listeners[b]=this._listeners[b]||[];this._listeners[b].push(a);return this};h.prototype.off=function(b,a){if(b in
this._listeners){var d=this._listeners[b],f=d.indexOf(a);-1<f&&d.splice(f,1)}return this};h.prototype.emit=function(b,a){this._listeners=this._listeners||{};if(b in this._listeners){var d=this._listeners[b],f=d.length,c;for(c=0;c<f;c++)d[c].apply(this,Array.prototype.slice.call(arguments,1))}return this};h.prototype.objectId=function(b){var a,h,f=Math.pow(10,17),c;if(b){a=0;h=b.length;for(c=0;c<h;c++)a+=b.charCodeAt(c)*f;b=a.toString(16)}else d.idCounter++,b=(d.idCounter+(Math.random()*f+Math.random()*
f+Math.random()*f+Math.random()*f)).toString(16);return b};h.prototype.peek=function(b){var a,d,f=[],c=typeof b;for(a in this._collection)this._collection.hasOwnProperty(a)&&(d=this._collection[a],f="string"===c?f.concat(d.peek(b)):f.concat(d.find(b)));return f};h.prototype.peekCat=function(b){var a,d,f={},c,h=typeof b;for(a in this._collection)this._collection.hasOwnProperty(a)&&(d=this._collection[a],(c="string"===h?d.peek(b):d.find(b))&&c.length&&(f[d.name()]=c));return f};p.exports=h},{"./Collection.js":2,
"./Crc.js":4,"./Metrics.js":7,"./Overload.js":9,"./Shared.js":11}],4:[function(k,p,m){var d=function(){var b=[],d,e,a;for(e=0;256>e;e++){d=e;for(a=0;8>a;a++)d=d&1?3988292384^d>>>1:d>>>1;b[e]=d}return b}();p.exports=function(b){var h=-1,e;for(e=0;e<b.length;e++)h=h>>>8^d[(h^b.charCodeAt(e))&255];return(h^-1)>>>0}},{}],5:[function(k,p,m){m=k("./Shared");var d=k("./Path");k=function(){this.init.apply(this,arguments)};k.prototype.init=function(b,d,e){this._crossRef={};this._size=0;this._id=this._itemKeyHash(b,
b);this.data({});this.unique(d&&d.unique?d.unique:!1);void 0!==b&&this.keys(b);void 0!==e&&this.collection(e);this.name(d&&d.name?d.name:this._id)};m.modules.Index=k;k.prototype.id=function(){return this._id};k.prototype.state=function(){return this._state};k.prototype.size=function(){return this._size};k.prototype.data=function(b){return void 0!==b?(this._data=b,this):this._data};k.prototype.name=function(b){return void 0!==b?(this._name=b,this):this._name};k.prototype.collection=function(b){return void 0!==
b?(this._collection=b,this):this._collection};k.prototype.keys=function(b){return void 0!==b?(this._keys=b,this._keyCount=(new d).parse(this._keys).length,this):this._keys};k.prototype.type=function(b){return void 0!==b?(this._type=b,this):this._type};k.prototype.unique=function(b){return void 0!==b?(this._unique=b,this):this._unique};k.prototype.rebuild=function(){if(this._collection){var b=this._collection.subset({},{decouple:!1,sort:this._keys}).find(),d,e=b.length;this._data={};this._unique&&
(this._uniqueLookup={});for(d=0;d<e;d++)this.insert(b[d])}this._state={name:this._name,keys:this._keys,indexSize:this._size,built:new Date,updated:new Date,ok:!0}};k.prototype.insert=function(b,d){var e,a;this._unique&&(e=this._itemHash(b,this._keys),this._uniqueLookup[e]=b);e=this._itemHashArr(b,this._keys);for(a=0;a<e.length;a++)this.pushToPathValue(e[a],b)};k.prototype.remove=function(b,d){var e,a;this._unique&&(e=this._itemHash(b,this._keys),delete this._uniqueLookup[e]);e=this._itemHashArr(b,
this._keys);for(a=0;a<e.length;a++)this.pullFromPathValue(e[a],b)};k.prototype.violation=function(b){b=this._itemHash(b,this._keys);return Boolean(this._uniqueLookup[b])};k.prototype.hashViolation=function(b){return Boolean(this._uniqueLookup[b])};k.prototype.pushToPathValue=function(b,d){var e=this._data[b]=this._data[b]||[];-1===e.indexOf(d)&&(e.push(d),this._size++,this.pushToCrossRef(d,e))};k.prototype.pullFromPathValue=function(b,d){var e=this._data[b],a;a=e.indexOf(d);-1<a&&(e.splice(a,1),this._size--,
this.pullFromCrossRef(d,e));e.length||delete this._data[b]};k.prototype.pull=function(b){var d=b[this._collection.primaryKey()],e=this._crossRef[d],a,n=e.length,f;for(a=0;a<n;a++)f=e[a],this._pullFromArray(f,b);this._size--;delete this._crossRef[d]};k.prototype._pullFromArray=function(b,d){for(var e=b.length;e--;)b[e]===d&&b.splice(e,1)};k.prototype.pushToCrossRef=function(b,d){var e=b[this._collection.primaryKey()];this._crossRef[e]=this._crossRef[e]||[];e=this._crossRef[e];-1===e.indexOf(d)&&e.push(d)};
k.prototype.pullFromCrossRef=function(b,d){var e=b[this._collection.primaryKey()];delete this._crossRef[e]};k.prototype.lookup=function(b){return this._data[this._itemHash(b,this._keys)]||[]};k.prototype.match=function(b,h){return(new d).countObjectPaths(this._keys,b)};k.prototype._itemHash=function(b,h){var e=new d,a,n="",f;a=e.parse(h);for(f=0;f<a.length;f++)n&&(n+="_"),n+=e.value(b,a[f].path).join(":");return n};k.prototype._itemKeyHash=function(b,h){var e=new d,a,n="",f;a=e.parse(h);for(f=0;f<
a.length;f++)n&&(n+="_"),n+=e.keyValue(b,a[f].path);return n};k.prototype._itemHashArr=function(b,h){var e=new d,a,n=[],f,c,g,k;a=e.parse(h);for(g=0;g<a.length;g++)for(f=e.value(b,a[g].path),c=0;c<f.length;c++)if(0===g)n.push(f[c]);else for(k=0;k<n.length;k++)n[k]=n[k]+"_"+f[c];return n};p.exports=k},{"./Path":10,"./Shared":11}],6:[function(k,p,m){k=k("./Shared");m=function(d){this.init.apply(this,arguments)};m.prototype.init=function(d){this._name=d;this._data={};this._primaryKey="_id"};k.modules.KeyValueStore=
m;m.prototype.name=function(d){return void 0!==d?(this._name=d,this):this._name};m.prototype.primaryKey=function(d){return void 0!==d?(this._primaryKey=d,this):this._primaryKey};m.prototype.truncate=function(){this._data={};return this};m.prototype.set=function(d,b){this._data[d]=b?b:!0;return this};m.prototype.get=function(d){return this._data[d]};m.prototype.lookup=function(d){d=d[this._primaryKey];var b,h,e,a;if(d instanceof Array){h=d.length;a=[];for(b=0;b<h;b++)(e=this._data[d[b]])&&a.push(e);
return a}if(d instanceof RegExp){a=[];for(b in this._data)this._data.hasOwnProperty(b)&&d.test(b)&&a.push(this._data[b]);return a}if("object"===typeof d){if(d.$ne){a=[];for(b in this._data)this._data.hasOwnProperty(b)&&b!==d.$ne&&a.push(this._data[b]);return a}if(d.$in&&d.$in instanceof Array){a=[];for(b in this._data)this._data.hasOwnProperty(b)&&-1<d.$in.indexOf(b)&&a.push(this._data[b]);return a}if(d.$nin&&d.$nin instanceof Array){a=[];for(b in this._data)this._data.hasOwnProperty(b)&&-1===d.$nin.indexOf(b)&&
a.push(this._data[b]);return a}if(d.$or&&d.$or instanceof Array){a=[];for(b=0;b<d.$or.length;b++)a=a.concat(this.lookup(d.$or[b]));return a}}else return e=this._data[d],void 0!==e?[e]:[]};m.prototype.unSet=function(d){delete this._data[d];return this};m.prototype.uniqueSet=function(d,b){return void 0===this._data[d]?(this._data[d]=b,!0):!1};p.exports=m},{"./Shared":11}],7:[function(k,p,m){m=k("./Shared");var d=k("./Operation");k=function(){this.init.apply(this,arguments)};k.prototype.init=function(){this._data=
[]};m.modules.Metrics=k;k.prototype.create=function(b){b=new d(b);this._enabled&&this._data.push(b);return b};k.prototype.start=function(){this._enabled=!0;return this};k.prototype.stop=function(){this._enabled=!1;return this};k.prototype.clear=function(){this._data=[];return this};k.prototype.list=function(){return this._data};p.exports=k},{"./Operation":8,"./Shared":11}],8:[function(k,p,m){m=k("./Shared");var d=k("./Path");k=function(b){this.pathSolver=new d;this.counter=0;this.init.apply(this,
arguments)};k.prototype.init=function(b){this._data={operation:b,index:{potential:[],used:!1},steps:[],time:{startMs:0,stopMs:0,totalMs:0,process:{}},flag:{},log:[]}};m.modules.Operation=k;k.prototype.start=function(){this._data.time.startMs=(new Date).getTime()};k.prototype.log=function(b){if(b){var d=0<this._log.length?this._data.log[this._data.log.length-1].time:0;b={event:b,time:(new Date).getTime(),delta:0};this._data.log.push(b);d&&(b.delta=b.time-d);return this}return this._data.log};k.prototype.time=
function(b){if(void 0!==b){var d=this._data.time.process,d=d[b]=d[b]||{};d.startMs?(d.stopMs=(new Date).getTime(),d.totalMs=d.stopMs-d.startMs,d.stepObj.totalMs=d.totalMs,delete d.stepObj):(d.startMs=(new Date).getTime(),d.stepObj={name:b},this._data.steps.push(d.stepObj));return this}return this._data.time};k.prototype.flag=function(b,d){if(void 0!==b&&void 0!==d)this._data.flag[b]=d;else return void 0!==b?this._data.flag[b]:this._data.flag};k.prototype.data=function(b,d,e){return void 0!==d?(this.pathSolver.set(this._data,
b,d),this):this.pathSolver.get(this._data,b)};k.prototype.pushData=function(b,d,e){this.pathSolver.push(this._data,b,d)};k.prototype.stop=function(){this._data.time.stopMs=(new Date).getTime();this._data.time.totalMs=this._data.time.stopMs-this._data.time.startMs};p.exports=k},{"./Path":10,"./Shared":11}],9:[function(k,p,m){m=function(d){if(d){var b,h=d.length;return function(){for(b=0;b<h;b++)if(d[b].length===arguments.length)return d[b].apply(this,arguments);return null}}return function(){}};k("./Shared").modules.Overload=
m;p.exports=m},{"./Shared":11}],10:[function(k,p,m){k=k("./Shared");m=function(d){this.init.apply(this,arguments)};m.prototype.init=function(d){d&&this.path(d)};k.modules.Path=m;m.prototype.path=function(d){return void 0!==d?(this._path=this.clean(d),this._pathParts=this._path.split("."),this):this._path};m.prototype.hasObjectPaths=function(d,b){var h=!0,e;for(e in d)if(d.hasOwnProperty(e)&&(void 0===b[e]||"object"===typeof d[e]&&(h=this.hasObjectPaths(d[e],b[e]),!h)))return!1;return h};m.prototype.countKeys=
function(d){var b=0,h;for(h in d)d.hasOwnProperty(h)&&void 0!==d[h]&&("object"!==typeof d[h]?b++:b+=this.countKeys(d[h]));return b};m.prototype.countObjectPaths=function(d,b){var h,e={},a=0,k=0,f;for(f in b)b.hasOwnProperty(f)&&("object"===typeof b[f]?(h=this.countObjectPaths(d[f],b[f]),e[f]=h.matchedKeys,k+=h.totalKeyCount,a+=h.matchedKeyCount):(k++,d&&d[f]&&"object"!==typeof d[f]?(e[f]=!0,a++):e[f]=!1));return{matchedKeys:e,matchedKeyCount:a,totalKeyCount:k}};m.prototype.parse=function(d,b){var h=
[],e="",a,k,f;for(k in d)if(d.hasOwnProperty(k))if(e=k,"object"===typeof d[k])if(b)for(a=this.parse(d[k],b),f=0;f<a.length;f++)h.push({path:e+"."+a[f].path,value:a[f].value});else for(a=this.parse(d[k]),f=0;f<a.length;f++)h.push({path:e+"."+a[f].path});else b?h.push({path:e,value:d[k]}):h.push({path:e});return h};m.prototype.parseArr=function(d,b){b=b||{};return this._parseArr(d,"",[],b)};m.prototype._parseArr=function(d,b,h,e){var a,k="";b=b||"";h=h||[];for(a in d)d.hasOwnProperty(a)&&(!e.ignore||
e.ignore&&!e.ignore.test(a))&&(k=b?b+"."+a:a,"object"===typeof d[a]?this._parseArr(d[a],k,h,e):h.push(k));return h};m.prototype.value=function(d,b){if(void 0!==d&&"object"===typeof d){var h,e,a,k,f=[],c;void 0!==b&&(b=this.clean(b),h=b.split("."));h=h||this._pathParts;e=h.length;a=d;for(c=0;c<e;c++){a=a[h[c]];if(k instanceof Array){for(e=0;e<k.length;e++)f=f.concat(this.value(k,e+"."+h[c]));return f}if(!a||"object"!==typeof a)break;k=a}return[a]}return[]};m.prototype.set=function(d,b,h){if(void 0!==
d&&void 0!==b){var e;b=this.clean(b);b=b.split(".");e=b.shift();b.length?(d[e]=d[e]||{},this.set(d[e],b.join("."),h)):d[e]=h}return d};m.prototype.get=function(d,b){return this.value(d,b)[0]};m.prototype.push=function(d,b,h){if(void 0!==d&&void 0!==b){var e;b=this.clean(b);b=b.split(".");e=b.shift();if(b.length)d[e]=d[e]||{},this.set(d[e],b.join("."),h);else if(d[e]=d[e]||[],d[e]instanceof Array)d[e].push(h);else throw"Cannot push to a path whose endpoint is not an array!";}return d};m.prototype.keyValue=
function(d,b){var h,e,a,k,f;void 0!==b&&(b=this.clean(b),h=b.split("."));h=h||this._pathParts;e=h.length;a=d;for(f=0;f<e;f++)if(a=a[h[f]],!a||"object"!==typeof a){k=h[f]+":"+a;break}return k};m.prototype.clean=function(d){"."===d.substr(0,1)&&(d=d.substr(1,d.length-1));return d};p.exports=m},{"./Shared":11}],11:[function(k,p,m){p.exports={idCounter:0,modules:{},prototypes:{}}},{}],12:[function(k,p,m){var d,b,h;m=k("./Shared");var e=function(a,b,d){this.init.apply(this,arguments)};e.prototype.init=
function(a,b,e){this._name=a;this._collections=[];this._groups=[];this._listeners={};this._querySettings={query:b,options:e};this._debug={};this._privateData=new d("__FDB__view_privateData_"+this._name)};m.modules.View=e;d=k("./Collection");k=k("./Overload");b=d.prototype.init;m=m.modules.Core;h=m.prototype.init;e.prototype.debug=new k([function(){return this._debug.all},function(a){return void 0!==a&&"boolean"===typeof a?(this._debug.all=a,this.privateData().debug(a),this.publicData().debug(a),this):
this._debug.all},function(a,b){return void 0!==a?void 0!==b?(this._debug[a]=b,this.privateData().debug(a,b),this.publicData().debug(a,b),this):this._debug[a]:this._debug.all}]);e.prototype.name=function(a){return void 0!==a?(this._name=a,this):this._name};e.prototype.find=function(a,b){return this.publicData().find(a,b)};e.prototype.insert=function(a,b,d){a=this._privateData.decouple(a);"function"===typeof b?(d=b,b=this._privateData.length):void 0===b&&(b=this._privateData.length);this._transformInsert(a,
b);this.debug()&&console.log('ForerunnerDB.View: Inserting some data on view "'+this.name()+'" in underlying (internal) view collection "'+this._privateData.name()+'"');return this._privateData._insertHandle(a,b,d)};e.prototype.update=function(a,b){this.debug()&&console.log('ForerunnerDB.View: Updating some data on view "'+this.name()+'" in underlying (internal) view collection "'+this._privateData.name()+'"');var d=this._privateData.update(a,b),c,e,h;if(this._transformEnabled&&this._transformIn){c=
this._publicData.primaryKey();for(var k=0;k<d.length;k++)e={},h=d[k],e[c]=h[c],this._transformUpdate(e,h)}return d};e.prototype.remove=function(a){this._transformRemove(a);this.debug()&&console.log('ForerunnerDB.View: Removing some data on view "'+this.name()+'" in underlying (internal) view collection "'+this._privateData.name()+'"');return this._privateData.remove(a)};e.prototype.link=function(a,b){var d=this.publicData();this.debug()&&console.log('ForerunnerDB.View: Setting up data binding on view "'+
this.name()+'" in underlying (internal) view collection "'+d.name()+'" for output target: '+a);return d.link(a,b)};e.prototype.unlink=function(a,b){var d=this.publicData();this.debug()&&console.log('ForerunnerDB.View: Removing data binding on view "'+this.name()+'" in underlying (internal) view collection "'+d.name()+'" for output target: '+a);return d.unlink(a,b)};e.prototype.from=function(a){void 0!==a&&("string"===typeof a&&(a=this._db.collection(a)),this._addCollection(a));return this};e.prototype._addCollection=
function(a){if(-1===this._collections.indexOf(a)){this._collections.push(a);a._addView(this);var b=a.find(this._querySettings.query,this._querySettings.options);this._transformPrimaryKey(a.primaryKey());this._transformInsert(b);this._privateData.primaryKey(a.primaryKey());this._privateData.insert(b)}return this};e.prototype._removeCollection=function(a){-1<this._collections.indexOf(a)&&(this._collections.splice(a,1),a._removeView(this),this._privateData.remove(a.find(this._querySettings.query,this._querySettings.options)));
return this};e.prototype.on=function(){this._privateData.on.apply(this._privateData,arguments)};e.prototype.off=function(){this._privateData.off.apply(this._privateData,arguments)};e.prototype.emit=function(){this._privateData.emit.apply(this._privateData,arguments)};e.prototype.drop=function(){if(this._collections&&this._collections.length){(this.debug()||this._db&&this._db.debug())&&console.log("ForerunnerDB.View: Dropping view "+this._name);this.emit("drop");for(var a=this._collections.length;a--;)this._removeCollection(this._collections[a]);
this._privateData.drop();return!0}return!1};e.prototype.db=function(a){return void 0!==a?(this._db=a,this.privateData().db(a),this.publicData().db(a),this):this._db};e.prototype.primaryKey=function(){return this._privateData.primaryKey()};e.prototype.queryData=function(a,b,d){void 0!==a&&(this._querySettings.query=a);void 0!==b&&(this._querySettings.options=b);return void 0!==a||void 0!==b?(void 0!==d&&!0!==d||this.refresh(),this):this._querySettings};e.prototype.queryAdd=function(a,b,d){var c=this._querySettings.query,
e;if(void 0!==a)for(e in a)a.hasOwnProperty(e)&&(void 0===c[e]||void 0!==c[e]&&b)&&(c[e]=a[e]);void 0!==d&&!0!==d||this.refresh()};e.prototype.queryRemove=function(a,b){var d=this._querySettings.query,c;if(void 0!==a)for(c in a)a.hasOwnProperty(c)&&delete d[c];void 0!==b&&!0!==b||this.refresh()};e.prototype.query=function(a,b){return void 0!==a?(this._querySettings.query=a,void 0!==b&&!0!==b||this.refresh(),this):this._querySettings.query};e.prototype.queryOptions=function(a,b){return void 0!==a?
(this._querySettings.options=a,void 0===a.decouple&&(a.decouple=!0),void 0!==b&&!0!==b||this.refresh(),this):this._querySettings.options};e.prototype.refresh=function(a){var b;a=this.publicData();var d;this._privateData.remove();a.remove();for(d=0;d<this._collections.length;d++)b=this._collections[d],this._privateData.insert(b.find(this._querySettings.query,this._querySettings.options));b=this._privateData.find({},this._querySettings.options);a._linked?$.observable(a._data).refresh(b):(this._privateData._data.length=
0,this._privateData._data=this._privateData._data.concat(b));return this};e.prototype.count=function(){return this._privateData&&this._privateData._data?this._privateData._data.length:0};e.prototype.transform=function(a){return void 0!==a?("object"===typeof a?(void 0!==a.enabled&&(this._transformEnabled=a.enabled),void 0!==a.dataIn&&(this._transformIn=a.dataIn),void 0!==a.dataOut&&(this._transformOut=a.dataOut)):this._transformEnabled=!1===a?!1:!0,this._transformPrimaryKey(this.privateData().primaryKey()),
this._transformSetData(this.privateData().find()),this):{enabled:this._transformEnabled,dataIn:this._transformIn,dataOut:this._transformOut}};e.prototype.privateData=function(){return this._privateData};e.prototype.publicData=function(){return this._transformEnabled?this._publicData:this._privateData};e.prototype._transformSetData=function(a){this._transformEnabled&&(this._publicData=new d("__FDB__view_publicData_"+this._name),this._publicData.db(this._privateData._db),this._publicData.transform({enabled:!0,
dataIn:this._transformIn,dataOut:this._transformOut}),this._publicData.setData(a))};e.prototype._transformInsert=function(a,b){this._transformEnabled&&this._publicData&&this._publicData.insert(a,b)};e.prototype._transformUpdate=function(a,b){this._transformEnabled&&this._publicData&&this._publicData.update(a,b)};e.prototype._transformRemove=function(a){this._transformEnabled&&this._publicData&&this._publicData.remove(a)};e.prototype._transformPrimaryKey=function(a){this._transformEnabled&&this._publicData&&
this._publicData.primaryKey(a)};d.prototype.init=function(){this._views=[];b.apply(this,arguments)};d.prototype.view=function(a,b,d){a=(new e(a,b,d)).db(this._db)._addCollection(this);this._views=this._views||[];this._views.push(a);return a};d.prototype._addView=function(a){void 0!==a&&this._views.push(a);return this};d.prototype._removeView=function(a){void 0!==a&&(a=this._views.indexOf(a),-1<a&&this._views.splice(a,1));return this};m.prototype.init=function(){this._views={};h.apply(this,arguments)};
m.prototype.view=function(a){this._views[a]||(this.debug()||this._db&&this._db.debug())&&console.log("Core.View: Creating view "+a);this._views[a]=this._views[a]||(new e(a)).db(this);return this._views[a]};m.prototype.viewExists=function(a){return Boolean(this._views[a])};m.prototype.views=function(){var a=[],b;for(b in this._views)this._views.hasOwnProperty(b)&&a.push({name:b,count:this._views[b].count()});return a};p.exports=e},{"./Collection":2,"./Overload":9,"./Shared":11}]},{},[1])(1)});
