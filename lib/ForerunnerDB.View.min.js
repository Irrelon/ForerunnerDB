(function(){var f=ForerunnerDB.classes.Collection,n=f.prototype.init,p=ForerunnerDB.prototype.init,b=function(){this.init.apply(this,arguments)};b.prototype.init=function(a){var c=this;this._name=a;this._groups=[];this._listeners={};this._query={query:{},options:{}};this._onFromSetData=function(){c._onSetData.apply(c,arguments)};this._onFromInsert=function(){c._onInsert.apply(c,arguments)};this._onFromUpdate=function(){c._onUpdate.apply(c,arguments)};this._onFromRemove=function(){c._onRemove.apply(c,
arguments)}};b.prototype.on=function(a,c){this._listeners=this._listeners||{};this._listeners[a]=this._listeners[a]||[];this._listeners[a].push(c);return this};b.prototype.off=function(a,c){if(a in this._listeners){var b=this._listeners[a],d=b.indexOf(c);-1<d&&b.splice(d,1)}return this};b.prototype.emit=function(a,c){this._listeners=this._listeners||{};if(a in this._listeners){var b=this._listeners[a],d=b.length,e;for(e=0;e<d;e++)b[e].apply(this,Array.prototype.slice.call(arguments,1))}return this};
b.prototype.drop=function(){return(this._db||this._from)&&this._name?((this._debug||this._from&&this._from._debug||this._db&&this._db._debug)&&console.log("Dropping view "+this._name),this.emit("drop"),this._db&&delete this._db._views[this._name],this._from&&delete this._from._views[this._name],!0):!1};b.prototype.db=function(a){return void 0!==a?(this._db=a,this):this._db};b.prototype.from=function(a){if(void 0!==a){if("string"===typeof a)if(this._db.collectionExists(a))a=this._db.collection(a);
else throw"Invalid collection in view.from() call.";this._from!==a&&(this._from&&this.removeFrom(),this.addFrom(a));return this}return this._from};b.prototype.addFrom=function(a){if(this._from=a)return this._from.on("setData",this._onFromSetData),this._from.on("insert",this._onFromInsert),this._from.on("update",this._onFromUpdate),this._from.on("remove",this._onFromRemove),this._from._addView(this),this._primaryKey=this._from._primaryKey,this.refresh(),this;throw"Cannot determine collection type in view.from()";
};b.prototype.removeFrom=function(){this._from.off("setData",this._onFromSetData);this._from.off("insert",this._onFromInsert);this._from.off("update",this._onFromUpdate);this._from.off("remove",this._onFromRemove);this._from._removeView(this)};b.prototype.primaryKey=function(){if(this._from)return this._from.primaryKey()};b.prototype.query=function(a,c,b){void 0!==a&&(this._query.query=a);void 0!==c&&(this._query.options=c);return void 0!==a||void 0!==c?((void 0===b||!0===b)&&this.refresh(),this):
this._query};b.prototype.queryAdd=function(a,c,b){var d=this._query.query,e;if(void 0!==a)for(e in a)if(a.hasOwnProperty(e)&&(void 0===d[e]||void 0!==d[e]&&c))d[e]=a[e];(void 0===b||!0===b)&&this.refresh()};b.prototype.queryRemove=function(a,c){var b=this._query.query,d;if(void 0!==a)for(d in a)a.hasOwnProperty(d)&&delete b[d];(void 0===c||!0===c)&&this.refresh()};b.prototype.queryObj=function(a,c){return void 0!==a?(this._query.query=a,(void 0===c||!0===c)&&this.refresh(),this):this._query.query};
b.prototype.queryOptions=function(a,c){return void 0!==a?(this._query.options=a,(void 0===c||!0===c)&&this.refresh(),this):this._query.options};b.prototype.refresh=function(a){var c=this._data,b,d,e,m,g,k=[],f=[],l=[],h;this._from&&(this._data=this._query?this._from.subset(this._query.query,this._query.options):this._from.subset({}));if(a)e=this._data.find(),this._onInsert(e,[]),this.emit("change",{data:e});else if(c){d=this._data;if(c.subsetOf()===d.subsetOf()){e=d.find();a=c.find();m=d._primaryKey;
for(h=0;h<e.length;h++)g=e[h],b={},b[m]=g[m],(b=c.find(b)[0])?JSON.stringify(b)!==JSON.stringify(g)&&f.push(g):k.push(g);for(h=0;h<a.length;h++)g=a[h],b={},b[m]=g[m],d.find(b)[0]||l.push(g);k.length&&this._onInsert(k,[]);f.length&&this._onUpdate(f,[]);l.length&&this._onRemove(l,[])}else l=c.find(),l.length&&this._onRemove(l),k=d.find(),k.length&&this._onInsert(k);this.emit("change",{data:e})}return this};b.prototype.count=function(){return this._data&&this._data._data?this._data._data.length:0};b.prototype.find=
function(){return this._data?this._data.find.apply(this._data,arguments):[]};b.prototype.insert=function(){return this._from?this._from.insert.apply(this._from,arguments):[]};b.prototype.update=function(){return this._from?this._from.update.apply(this._from,arguments):[]};b.prototype.remove=function(){return this._from?this._from.remove.apply(this._from,arguments):[]};b.prototype._onSetData=function(a,b){this.emit("remove",b,[]);this.emit("insert",a,[])};b.prototype._onInsert=function(a,b){this.emit("insert",
a,b)};b.prototype._onUpdate=function(a,b){this.emit("update",a,b)};b.prototype._onRemove=function(a,b){this.emit("remove",a,b)};f.prototype.init=function(){this._views=[];n.apply(this,arguments)};f.prototype._addView=function(a){void 0!==a&&(this._views[a._name]=a);return this};f.prototype._removeView=function(a){void 0!==a&&delete this._views[a._name];return this};ForerunnerDB.prototype.init=function(){this._views={};p.apply(this,arguments)};ForerunnerDB.prototype.view=function(a){this._views[a]||
this._debug&&console.log("Creating view "+a);this._views[a]=this._views[a]||(new b(a)).db(this);return this._views[a]};ForerunnerDB.prototype.viewExists=function(a){return Boolean(this._views[a])};ForerunnerDB.prototype.views=function(){var a=[],b;for(b in this._views)this._views.hasOwnProperty(b)&&a.push({name:b,count:this._views[b].count()});return a};ForerunnerDB.classes.View=b})();
